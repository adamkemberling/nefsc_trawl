---
title: "Stratification and Aggregation Validation"
author: "Adam A. Kemberling"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: TRUE
    toc_float:
        collapsed: FALSE
    code_folding: show
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F, comment = NA)
options(knitr.kable.NA = '')

###__ Packages  ####
library(here)
library(janitor)
library(gmRi)
library(patchwork)
library(tidyverse)
library(knitr)
library(kableExtra)
library(scales)



# Load the build code and stratification function
mills_path <- shared.path(os.use = "unix", group = "Mills Lab", folder = NULL)
res_path <- shared.path(os.use = "unix", group = "RES Data", folder = NULL)

#### Set theme  ####
theme_set(theme_minimal())

```

`r use_gmri_style_rmd(css_file = "gmri_rmarkdown.css")`

# About

The goal of this markdown is to validate consistency of outcomes for various aggregation scales. The approach is to take 4 years from the survey data, 2006-2010 to cover the change in survey design. Then we will track comparisons between estimating biomasses at a station level or in aggregate.

## Starting Data

```{r}
####__  Data  ####

# 2020 Raw data
load(here("data/NEFSC/Survdat_Nye_Aug 2020.RData"))
trawl_20 <- survdat %>% clean_names()
rm(survdat)

# And filter
trawl_20 <- filter(trawl_20, est_year >=2006 & est_year <= 2010)
```

## Clean up Function

The size spectra clean up function does any data prep including:   

 * Removal of incomplete records   
 * Spatial filters   
 * Pairing species to growth coefficients   
 * Calculating stratum effort and area weighting coefficients   
 * Estimating stratified catch rates   
 

```{r}
source(here("R/01_nefsc_ss_build.R"))
weights_20 <- load_ss_data(survdat = trawl_20, survdat_source = "tester")

```

**NOTE:**

The cleanup function retains the station-level information of the raw data, so its possible to compare individual stations across the raw and prepped data:

```{r}
test_station <- weights_20$id[1]
test_species <- unique(weights_20$comname)[3]

print(paste0("The test station is: ", test_station))
print(paste0("The test species is: ", test_species))

show_comparison <- function(x, test_station, test_species, names = "original"){
  if(names == "original"){
    x %>% 
      mutate(id = as.character(id)) %>% 
      filter(id == test_station, 
             comname == toupper(test_species)) %>% 
      select(id, comname, length, numlen, biomass, abundance,)
    } else{
    x %>% 
      filter(id == test_station, 
             comname == tolower(test_species)) %>% 
      select(id, comname, length, numlen, numlen_adj, biom_adj, abundance)
  }

}
t_raw <- show_comparison(trawl_20, test_station, test_species, names = "original")
t_clean <- show_comparison(weights_20, test_station, test_species, names = "cleaned")


bind_rows(list("raw data" = t_raw, "cleaned data" = t_clean), .id = "Data Source") %>% 
  mutate_if(is.numeric, round, 1) %>% 
  mutate_if(is.character, tolower) %>% 
  kable() %>%  
  kable_styling(font_size = 10)
```

This example is good because it shows how abundance does not always equal what the sum of the column `numlen` returns. `numlen_adj` is then an adjustment to convert the numbers found in `numlen` to total the observed "abundance".


# Raw Comparisons

Looking at the weights dataset we prepared, the first obvious comparison to make is how to weights from length weight relationships compare to the bulk biomass measurements recorded on the ship. In the below plots its clear that they do not match up, and in these years the aggregate biomass measure is almost 3x the l-w counterparts, with an inconsistent relationship in the fall.

```{r}
# Annual Summary
ann_summs <- weights_20 %>% 
  group_by(est_year) %>% 
  summarise(`L-W Biomass` = sum(sum_weight_kg),
            `Bulk Biomass` = sum(biom_adj),
            season = "SPRING + FALL")

# Seasonal Differences
seas_summs <- weights_20 %>% 
  group_by(est_year, season) %>% 
  summarise(`L-W Biomass` = sum(sum_weight_kg),
            `Bulk Biomass` = sum(biom_adj))

bind_rows(ann_summs, seas_summs) %>% 
  pivot_longer(names_to = "Biomass Source", values_to = "Biomass (kg)", 
               cols = c(`L-W Biomass`, `Bulk Biomass`)) %>% 
  mutate(season = factor(season, levels = c("SPRING + FALL", "SPRING", "FALL")))%>% 
  ggplot(aes(est_year, `Biomass (kg)`, color = `Biomass Source`)) +
    geom_line() +
    facet_wrap(~season, ncol = 1) +
    scale_y_continuous(labels = comma_format())+
    scale_color_gmri() +
    labs(x = "") +
    theme(legend.position = "bottom")
```



# Aggregation Comparisons {.tabset .tabset-pills}

Another comparison of interest is whether it makes a difference to calculate catch rates for individual lengths of a species, expanding those rates out to get a stratified biomass. Or to aggregate before estimating catch rates.

The following code will look into that comparison.

## Size Specific Catch Rates {.tabset}

The way the size spectra build code is written catch rates for each length caught are estimated and weighted for every stratum in which they are caught. Weighting is adjusted by the amount of effort within that stratum in that year, and the relative size of the stratum to the overall sampling coverage that year.

In this way, using the example above there are catch per tow estimates for American Plaice of lengths 15, 16, and 30 cm.

```{r}
weights_20 %>% 
    filter(id == test_station, 
           comname == tolower(test_species)) %>% 
      select("Species" = comname, 
             "Length" = length, 
             "Number at Length" = numlen_adj, 
             "Weight (g)" = sum_weight_kg, 
             "Stratum" = stratum,
             "Tows in Stratum (by year)" = strat_ntows, 
             "Abundance per Tow" = abund_tow_s, 
             "Weighted Abundance per Tow (by stratum area)" =  wt_abund_s,
             "Projected Abundance (stratum)" = expanded_abund_s) %>% 
  mutate(`Weight (g)` = `Weight (g)` * 1000) %>% 
  mutate_if(is.numeric, round, 3) %>% 
  kable() %>%  
  kable_styling(font_size = 10, )
```

The question is whether the sum of these "Projected Abundances" is the same  when these catch rates are done in aggregate using the following function:

```{r}
agg_species_metrics
```


### Aggregate After

```{r}
cod_20 <- weights_20 %>% filter(comname == "atlantic cod")

# adding up stratified weights at the end
cod_20 %>% 
  group_by(est_year, season, comname) %>% 
  summarise(stratified_abundance = sum(expanded_abund_s),
            stratified_lwbio = sum(expanded_lwbio_s),
            stratified_biom = sum(expanded_biom_s)) %>% 
  kable() %>% 
  kable_styling(font_size = 10)
```

### Aggregate First 

```{r}

# Aggregating then calculating the catch rates etc.
cod_20 %>% 
  agg_species_metrics(est_year, season) %>% 
  select(est_year, season, comname, 
         stratified_abundance = strat_abundance_s,
         stratified_lwbio = lw_strat_biomass_s,
         stratified_biom = fscs_strat_biomass_s) %>% 
  kable() %>% 
  kable_styling(font_size = 10)
```

