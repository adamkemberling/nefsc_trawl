---
title: "Stratification and Aggregation Validation"
author: "Adam A. Kemberling"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: TRUE
    toc_float:
        collapsed: FALSE
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F, comment = NA)
options(knitr.kable.NA = '')

###__ Packages  ####
library(here)
library(janitor)
library(gmRi)
library(patchwork)
library(tidyverse)
library(knitr)
library(kableExtra)
library(scales)
library(ggforce)
library(ruler)



# Load the build code and stratification function
box_paths <- research_access_paths(os.use = "unix")
mills_path <- box_paths$mills
res_path <- box_paths$res

#### Set theme  ####
theme_set(theme_minimal())

```

`r use_gmri_style_rmd(css_file = "gmri_rmarkdown.css")`

# About

The goal of this markdown is to validate consistency of outcomes for various aggregation scales. The approach is to take 4 years from the survey data, 2006-2010 to cover the change in survey design. Then we will track comparisons between estimating biomasses at a station level or in aggregate.

## Starting Data

```{r}
####__  Data  ####

# Load 2020 Raw survdat data from .RData file
load(here("data/NEFSC/Survdat_Nye_Aug 2020.RData"))
trawl_20 <- survdat %>% clean_names()
rm(survdat)

# And filter
trawl_20 <- filter(trawl_20, est_year >= 2006 & est_year <= 2010)
```

## Clean up Function

The size spectra clean up function does any data prep including:   

 * Removal of incomplete records   
 * Spatial filters   
 * Pairing species to growth coefficients   
 * Calculating stratum effort and area weighting coefficients   
 * Estimating stratified catch rates   
 

```{r}

# Cleanup functions
source(here("R/01_nefsc_ss_build.R"))

# Clean/Prep Survdat 2006-2010
survdat_20 <- survdat_prep(survdat = trawl_20, survdat_source = "tester")

# Add LW coefficients
survdat_lw <- add_lw_info(survdat_clean = survdat_20)

# Get stratified Biomass
weights_20 <- add_area_stratification(survdat_weights = survdat_lw, include_epu = F)


```

**NOTE:**

The cleanup function retains the station-level information of the raw data, so its possible to compare individual stations across the raw and prepped data:

```{r}
test_station <- weights_20$id[1]
test_species <- unique(weights_20$comname)[4]

print(paste0("The test station is: ", test_station))
print(paste0("The test species is: ", test_species))

show_comparison <- function(x, test_station, test_species, names = "original"){
  if(names == "original"){
    x %>% 
      mutate(id = as.character(id)) %>% 
      filter(id == test_station, 
             comname == toupper(test_species)) %>% 
      select(id, comname, length, numlen, biomass, abundance,)
    } else{
    x %>% 
      filter(id == test_station, 
             comname == tolower(test_species)) %>% 
      select(id, comname, length, numlen, numlen_adj, biom_adj, abundance, n_len_class, biom_per_lclass)
  }

}
t_raw <- show_comparison(trawl_20, test_station, test_species, names = "original")
t_clean <- show_comparison(weights_20, test_station, test_species, names = "cleaned")


bind_rows(list("raw data" = t_raw, "cleaned data" = t_clean), .id = "Data Source") %>% 
  mutate_if(is.numeric, round, 1) %>% 
  mutate_if(is.character, tolower) %>% 
  kable() %>%  
  kable_styling(font_size = 10)
```

This example is good because it shows how abundance does not always equal what the sum of the column `numlen` returns. `numlen_adj` is then an adjustment to convert the numbers found in `numlen` to total the observed "abundance".


# Raw Comparisons

Looking at the weights dataset we prepared, the first obvious comparison to make is how to weights from length weight relationships compare to the bulk biomass measurements recorded on the ship. In the below plots its clear that they do not match up, and in these years the aggregate biomass measure is almost 3x the l-w counterparts, with an inconsistent relationship in the fall.



## Is Biomass repeated, or divyed out

Confusion has arisen about whether at a station the `survdat$BIOMASS` column should be summed for each species to get total biomass, or whether it is the aggregate biomass for the species and should be pulled once as a unique value.

The following code will compare how either of these compares to what the L-W Biomass is when looking at the number at length.

As an added check I flagged the number of length classes per tow and created a new column that is the bulk biomass divided by that number. This implementation lets me add those values just as I would for the L-W mass for aggregations. This value was added to the plot to verify that there weren't instances where they diverged.

```{r}
important_species <- c("atlantic cod", "haddock", "spiny dogfish", "pollock")
focal_species <- weights_20 %>% filter(comname %in% important_species)

# Biomass treated as the total biomass for that species, pulled once for each tow
biomass_as_total <- focal_species %>% 
  distinct(est_year,id, comname, catchsex, biom_adj) %>% 
  group_by(est_year, comname) %>% 
  summarise(`Biomass as Bulk Total` = sum(biom_adj))


# Biomass treated as a total divided evenly among the number of length classes
biomass_spread_out  <- focal_species %>% 
  # Sum up for each station for each sex
  group_by(est_year, comname, id, catchsex) %>% 
  summarise(biom_adj = sum(biom_adj),
            biomass_divided = sum(biom_per_lclass),
            sum_weight_kg = sum(sum_weight_kg)) %>% 
  # Aggregate again for the years
  group_by(est_year, comname) %>% 
  summarise(`Biomass Divided Among Length Classes` = sum(biom_adj),
            `Biomass Readjusted for n Length Classes` = sum(biomass_divided),
            `Length Weight Biomass Total` = sum(sum_weight_kg))



ggplot() +
  geom_line(data = biomass_as_total, 
            aes(est_year, `Biomass as Bulk Total`, 
                color = "Biomass as Bulk Total")) +
  geom_line(data = biomass_spread_out, 
            aes(est_year, `Biomass Divided Among Length Classes`, 
                color = "Biomass Divided Among Length Classes")) +
  geom_line(data = biomass_spread_out, 
            aes(est_year, `Length Weight Biomass Total`, 
                color = "Length Weight Biomass Total")) +
  geom_line(data = biomass_spread_out,
            aes(est_year, `Biomass Readjusted for n Length Classes`,
                color = "Biomass Readjusted for n Length Classes")) +
  labs(x = "", y = "Biomass (kg)") + 
  facet_wrap(~comname)


```





## Total Biomass vs. L-W Biomass

Due to subsampling of large catches and inherent variability around the mean weight at length for a species we expect the biomass estimates to resemble but not exactly match the biomass recorded for a species total weight at a station. The following figures aim to track how these aggregate totals compare over the years of the survey.

```{r}
####  Annual Summary, summer and fall  ####

#BIOMASS
# Because we are taking distinct records for BIOMASS we use biom_adj not per_lclass
ann_summ_bio <- weights_20 %>% 
  distinct(est_year, id, comname, catchsex, biom_adj, biom_per_lclass, expanded_biom_s) %>% 
  group_by(est_year) %>% 
  summarise(`Bulk Biomass` = sum(biom_adj),
            `Area Stratified Total BIOMASS` = sum(expanded_biom_s),
            season = "SPRING + FALL")
            

# L-W
ann_summ_lw <- weights_20 %>% 
  group_by(est_year) %>% 
  summarise(`L-W Biomass` = sum(sum_weight_kg),
            `Area Stratified Total L-W` = sum(expanded_lwbio_s),
            season = "SPRING + FALL")

# Join them
ann_summs <- left_join(ann_summ_bio, ann_summ_lw)



####  Annual Summary, seperate seasons  ####

#BIOMASS
seas_summ_bio <-  weights_20  %>% 
  distinct(est_year, season, id, comname, catchsex, biom_adj, biom_per_lclass, expanded_biom_s) %>% 
  group_by(est_year, season) %>% 
  summarise(`Bulk Biomass` = sum(biom_adj),
            `Area Stratified Total BIOMASS` = sum(expanded_biom_s))
# L-W
seas_summ_lw <- weights_20 %>% 
  group_by(est_year, season) %>% 
  summarise(`L-W Biomass` = sum(sum_weight_kg),
            `Area Stratified Total L-W` = sum(expanded_lwbio_s))

# Join them
seas_summs <- left_join(seas_summ_bio, seas_summ_lw)


# reformat for plotting
summaries_long <- bind_rows(ann_summs, seas_summs) %>% 
  pivot_longer(names_to = "Biomass Source", 
               values_to = "Total Survey Biomass (kg)", 
               cols = c(`L-W Biomass`, `Bulk Biomass`)) %>% 
  pivot_longer(names_to = "Stratified Biomass Source", 
               values_to = "Area Projected Biomass (kg)", 
               cols = c(`Area Stratified Total L-W`,`Area Stratified Total BIOMASS`)) %>% 
  mutate(season = factor(season, levels = c("SPRING + FALL", "SPRING", "FALL")))


# Total Biomass from survey
ggplot(summaries_long, aes(est_year, `Total Survey Biomass (kg)`, color = `Biomass Source`)) +
  geom_line() +
  facet_wrap(~season, ncol = 1) +
  scale_y_continuous(labels = comma_format())+
  scale_color_gmri() +
  labs(x = "") +
  theme(legend.position = "bottom")


# What that biomass is extended out to total areas
ggplot(summaries_long, aes(est_year, `Area Projected Biomass (kg)`, color = `Stratified Biomass Source`)) +
  geom_line() +
  facet_grid(`Stratified Biomass Source`~season, scales = "free") +
  scale_y_continuous(labels = comma_format())+
  scale_color_gmri() +
  labs(x = "") +
  theme(legend.position = "bottom")

```



# Aggregation Comparisons {.tabset .tabset-pills}

Another comparison of interest is whether it makes a difference to calculate catch rates for individual lengths of a species, expanding those rates out to get a stratified biomass. Or to aggregate before estimating catch rates.

The following code will look into that comparison.



## Size Specific Catch Rates {.tabset}

The way the size spectra build code is written catch rates for each length caught are estimated and weighted for every stratum in which they are caught. Weighting is adjusted by the amount of effort within that stratum in that year, and the relative size of the stratum to the overall sampling coverage that year.

In this way, using the example above there are catch per tow estimates for American Plaice of lengths 15, 16, and 30 cm.

```{r}
weights_20 %>% 
    filter(id == test_station, 
           comname == tolower(test_species)) %>% 
      select("Species"                                      = comname, 
             "Length"                                       = length, 
             "Number at Length"                             = numlen_adj, 
             "Weight (g)"                                   = sum_weight_kg, 
             "Stratum"                                      = stratum,
             "Tows in Stratum (by year)"                    = strat_ntows, 
             "Abundance per Tow"                            = abund_tow_s, 
             "Weighted Abundance per Tow (by stratum area)" = wt_abund_s,
             "Projected Abundance (stratum)"                = expanded_abund_s) %>% 
  mutate(`Weight (g)` = `Weight (g)` * 1000) %>% 
  mutate_if(is.numeric, round, 3) %>% 
  kable() %>%  
  kable_styling(font_size = 10, )
```

The question is whether the sum of these "Projected Abundances" is the same  when these catch rates are done in aggregate using the following function:

```{r}
agg_species_metrics
```


### Aggregate After

```{r}
cod_20 <- weights_20 %>% filter(comname == "atlantic cod")

# adding up stratified weights at the end
cod_20 %>% 
  group_by(est_year, season, comname) %>% 
  summarise(stratified_abundance = sum(expanded_abund_s),
            stratified_lwbio     = sum(expanded_lwbio_s),
            stratified_biom      = sum(expanded_biom_s)) %>% 
  select(Year                     = est_year, 
         Season                   = season, 
         Species                  = comname, 
         `Stratified Abundance`   = stratified_abundance,
         `Stratified LWbio`       = stratified_lwbio,
         `Stratified Biom`        = stratified_biom) %>% 
  kable() %>% 
  kable_styling(font_size = 10)
```

### Aggregate First  

```{r}

# Aggregating then calculating the catch rates etc.
cod_20 %>% 
  agg_species_metrics(est_year, season) %>% 
  select(Year                     = est_year, 
         Season                   = season, 
         Species                  = comname, 
         `Stratified Abundance`   = strat_abundance_s,
         `Stratified LWbio`       = lw_strat_biomass_s,
         `Stratified Biom`        = fscs_strat_biomass_s) %>% 
  kable() %>% 
  kable_styling(font_size = 10)
```

# LW Coefficient Comparisons {.tabset .tabset-pills}

Looks like the root cause is just the difference between what the mean prediction from species-specific coefficients is when compared to the biomass column in survdat.

Going to plot out how each species compares individually and rank their fits.


```{r, fig.height=10}
# Thoughts - difference between lw biomass vs. time 
# (i.e. is their relationship changing)
# how does that relate to temperature and survey change'
# good way to flag species that are way off

# Load all years and species
weights_all <- survdat_prep(survdat_source = "2020") %>% 
  add_lw_info() %>% 
  add_area_stratification()


# Get the total weights for each station, then do it each year for every species
mismatch_ranks <- function(x){
  species_summaries <- x %>% 
    group_by(est_year, comname, id) %>% 
    summarise(number_caught = sum(numlen_adj),
              length_weight_biomass = sum(sum_weight_kg),
              ship_measured_biomass = sum(biom_per_lclass),
              lw_underestimate = ship_measured_biomass - length_weight_biomass) %>% 
    ungroup()
  
  
  # Format rankings to plot
  n_species <- length(unique(species_summaries$comname))
  ranks <- species_summaries %>% 
    mutate(comname = fct_reorder(.f = comname, .x = lw_underestimate, mean),
           species_rank = as.numeric(comname),
           extremes = ifelse( species_rank >= n_species - 20, "Extreme Under-Estimation", NA),
           extremes = ifelse(species_rank <= 20, "Extreme Over-Estimation", extremes)) 
  
  return(ranks)
  
}


# Plot flags top and bottom 15 species that don't match well with survdat$biomass
mismatch_plot <- function(x){
  # All ranks in one panel
  all_ranks <- x %>% 
    ggplot(aes(lw_underestimate, species_rank)) +
      geom_boxplot(aes(group = species_rank), color = "gray40") +
      geom_boxplot(data = filter(x, is.na(extremes) == FALSE),
                   aes(group = species_rank, color = extremes)) +
      geom_vline(xintercept = 0, size = 0.5, color = "black", linetype = 2) +
      scale_x_continuous(labels = comma_format()) +
      scale_color_gmri() +
      guides("color" = guide_legend(title = "")) +
      labs(x = "Underestimation of Biomass from LW Regressions\nShipboard Weight - LW Biomass (kg)",
           y = "Underestimation Rank") +
    theme(legend.position = c(0.2, 1))
  
  # Focus on top 5
  top_5 <- x %>% 
    filter(extremes == "Extreme Under-Estimation") %>% 
    ggplot(aes(lw_underestimate, comname)) +
      geom_boxplot(aes(group = species_rank), color = gmri_cols("orange")) +
      #geom_vline(xintercept = 0, size = 0.5, color = "black", linetype = 2) +
      scale_color_gmri() +
      scale_x_continuous(labels = comma_format()) +
      labs(x = "",
           y = "", 
           subtitle = "L-W mass < 'survdat$Biomass'") +
    theme(title = element_text(hjust = 0.5))
  
  # Focus on bottom 5
  bot_5 <- x %>% 
    filter(extremes == "Extreme Over-Estimation") %>% 
    ggplot(aes(lw_underestimate, comname)) +
      geom_boxplot(aes(group = species_rank), color = gmri_cols("gmri blue")) +
      #geom_vline(xintercept = 0, size = 0.5, color = "black", linetype = 2) +
      scale_color_gmri() +
      scale_x_continuous(labels = comma_format()) +
      labs(x = "Underestimation of Biomass from LW Regressions\nShipboard Weight - LW Biomass (kg)",
           y = "", 
           subtitle = "L-W mass > 'survdat$Biomass'") +
    theme(title = element_text(hjust = 0.5))
    
  
  
  # Patchwork plot
  plot_out <- all_ranks | (top_5/bot_5)
  return(plot_out)
}



```


## Wigley 06 - Species

These species got a priority pass when matching with L-W coefficients because they are from a more recent and region specific source.

```{r, fig.height=8}
# Get ranks for everything
all_source_ranks <- weights_20 %>%
  mismatch_ranks() 

# Just Wigley
wigley_ranks <- weights_all %>% filter(source == "wigley") %>% 
  mismatch_ranks() 

# Wigley mismatch plot
wigley_ranks %>% 
  mismatch_plot()

```


## Fishbase Species

These species were matched up with coefficients from fishbase and are likely less accurate than the ones with svspp codes.

```{r, fig.height=8}
fishbase_ranks <- weights_all %>% filter(source == "fishbase") %>% 
  mismatch_ranks()

fishbase_ranks %>% 
  mismatch_plot()
```


## LW Regression Fit Diagnostics {.tabset}





### Subsampling Errors

Take the species that stood out above and plot the mismatch versus the station abundances. This should highlight whether its an issue of subsampling. Might be beneficial to  split it for seasons for dogfish and some other species.


```{r, fig.height=10}


#species that are caught in large numbers
subsampling_suspects <- c("spiny dogfish", "haddock", "blueback herring", "american shad", "windowpane", "silver rag", "atlantic cod", "pollock", "smooth dogfish", "acadian redfish")



# plot
all_source_ranks %>% 
  filter(comname %in% subsampling_suspects) %>% 
  ggplot(aes(number_caught, lw_underestimate)) +
      geom_point(color = gmri_cols("gmri blue")) +
      geom_smooth(formula = y ~ x, method = "lm", color = gmri_cols("orange")) +
      facet_wrap(~comname, scales = "free", ncol = 2) +
      labs(x = "Single Station Abundance", y = "survdat$BIOMASS - LW Biomass")
  
```


### Mismatch Outliers

Dig into the cases where things are really off by flagging the outliers and plotting those relationships.

```{r, fig.height=10}

#### Outlier Rules ####


#Z-score
isnt_out_z <- function(x, thres = 3, na.rm = TRUE) {
  abs(x - mean(x, na.rm = na.rm)) <= thres * sd(x, na.rm = na.rm)}

# Median Absolute Deviation https://en.wikipedia.org/wiki/Median_absolute_deviation
isnt_out_mad <- function(x, thres = 3, na.rm = TRUE) {
  abs(x - median(x, na.rm = na.rm)) <= thres * mad(x, na.rm = na.rm)}


# Tukeys Fences - box plot outliers https://en.wikipedia.org/wiki/Outlier#Tukey&%2339;s_fences
isnt_out_tukey <- function(x, k = 1.5, na.rm = TRUE) {
  quar <- quantile(x, probs = c(0.25, 0.75), na.rm = na.rm)
  iqr <- diff(quar)
  
  (quar[1] - k * iqr <= x) & (x <= quar[2] + k * iqr)}

# Mahalanobis Distance https://en.wikipedia.org/wiki/Mahalanobis_distance
maha_dist <- . %>% select_if(is.numeric) %>%
    mahalanobis(center = colMeans(.), cov = cov(.))
isnt_out_maha <- function(tbl, isnt_out_f, ...) {
  tbl %>% maha_dist() %>% isnt_out_f(...)}

# Definition of non-outlier row
isnt_out_funs <- list(
  z = isnt_out_z,
  mad = isnt_out_mad,
  tukey = isnt_out_tukey)

#Implementation
all_source_ranks <- all_source_ranks %>% 
  split(.$comname) %>% 
  map_dfr(~ .x %>% 
  mutate(abundance_outliers = isnt_out_tukey(number_caught),
         estimation_outliers = isnt_out_tukey(lw_underestimate)))




# Plot the estimation outliers
# Filter to just outliers for mismatches between BIOMASS and lw bio
all_source_ranks %>% 
  filter(estimation_outliers == F,
         comname %in% subsampling_suspects)%>% 
  ggplot(aes(number_caught, lw_underestimate)) +
      geom_point(color = gmri_cols("gmri blue")) +
      geom_smooth(formula = y ~ x, method = "lm", 
                  color = gmri_cols("orange")) +
      facet_wrap(~comname, scales = "free", ncol = 2) +
      labs(x = "Single Station Abundance", 
           y = "survdat$BIOMASS - LW Biomass",
           subtitle = "Biomass Estimation Outliers",
           caption = "Data shown are outliers in estimate error between BIOMASS and L-W weights.")


```

### Haddock Issues

Haddock is one of the most commonly caught species, particularly true in the recent years. It also has a particularly high prevalance for large deviances from the two biomass sources.

Looking more closely it looks like there are two distinct groups in the fall, whereas the spring seems to match up fairly well.

```{r}

single_species <- "haddock"

# haddock check
haddock <- weights_all %>% 
  filter(comname == single_species)


# which coefficients are breaking it
haddock %>% 
  group_by(id, est_year, season, svvessel, catchsex, a, b, ln_a) %>% 
  summarise(lw_bio = sum(sum_weight_kg),
            biomass_col = sum(biom_per_lclass)) %>% 
  ggplot(aes(biomass_col, lw_bio, 
             color = svvessel)) +
  geom_point(show.legend = F) +
  facet_grid(season~svvessel) +
  geom_abline(slope = 1, intercept = 0, linetype = 2, color  = "darkblue") +
  labs(x = "Weight from survdat$BIOMASS", y = "Weight from LW relationship",
       caption = "Dashed line depicts 1:1 relationship",
       subtitle = paste0(single_species, " Growth Coefficient Testing") )
```




### Cutoff threshold

If we assume that the total biomass weighed at a station is correct then we can use some cutoff value for an unacceptable deviaiton from the known weight.

For example values 100% heavier or lighter.

```{r}
broken_coefficients <- weights_all %>% 
  group_by(comname, source) %>% 
  summarise(
    `Biomass`    = sum(biom_per_lclass),
    `LW Biomass` = sum(sum_weight_kg),
    weight_perc_diff  = ((`LW Biomass` - Biomass) / Biomass) * 100,
    broken_coef  = ifelse(weight_perc_diff > 100 | weight_perc_diff < -100, "broken", "less broken"),
    .groups = "keep") %>% ungroup() %>% 
  filter(broken_coef == "broken")

# Broken Wigley Coefficientz
broken_coefficients %>% 
  filter(source == "wigley") %>% 
  mutate(comname = fct_reorder(comname, weight_perc_diff, max)) %>% 
  ggplot(aes(weight_perc_diff, comname)) +
   geom_point() +
   labs(x = "Percent Difference in Biomass Sources", y = "")

# Broken fishbase coefficients
broken_coefficients %>% 
  filter(source == "fishbase",
         comname != "hogfish") %>% 
  top_n(n = 20, weight_perc_diff) %>% 
  mutate(comname = fct_reorder(comname, weight_perc_diff, max)) %>% 
  ggplot(aes(weight_perc_diff, comname)) +
   geom_point() +
   labs(x = "Percent Difference in Biomass Sources", 
        y = "", 
        caption = "hogfish excluded, super broken also") +
  scale_x_continuous(labels = scales::comma_format())
  

broken_coefficients %>% filter(source == "wigley")
broken_coefficients %>% filter(source == "fishbase")
```



## Removing bad fits

Certain coefficients seem to be really off and contributing to some really big differences in stratified abundances/biomasses.


```{r}

bad_coefficients <-
  c("windowpane",
    "swordfish",
    "snowy grouper",
    "cobia",
    "king mackerel",
    "scalloped hammerhead shark",
    "warsaw grouper",
    "dusky shark",
    "ocean sunfish",
    "southern eagle ray",
    "porbeagle shark",
    "northern sand lance",
    # wigley
    "haddock",
    "butterfish",
    "southern stingray"
  )



fish_removed <- weights_all %>% 
  filter(comname %not in% bad_coefficients)


new_totals <- fish_removed %>% 
 group_by(est_year, season) %>% 
 summarise(`Biomass` = sum(biom_per_lclass),
           `LW Biomass` = sum(sum_weight_kg),
           .groups = "keep")



ggplot(new_totals, aes(est_year)) +
  geom_line(aes(y = Biomass, color = "BIOMASS")) +
  geom_line(aes(y = `LW Biomass`, color = "LW Biomass")) +
  facet_wrap(~season, ncol = 1) +
  scale_y_continuous(labels = comma_format())+
  scale_color_gmri() +
  labs(x = "", subtitle = "Error prone species removed") +
  theme(legend.position = "bottom")
```

