---
title: "Temperature Impacts on Size Structure of Northeast US Groundfish Community Extend Issues from Fisheries Over-Exploitation"
author: 
    name: "Adam Kemberling"
    url: https://github.com/adamkemberling
    affiliation: Gulf of Maine Research Institute
description: | 
  Size Spectrum Analysis of the Northeast US Groundfish Community
date: "`r Sys.Date()`"
format: 
  html:
    self-contained: true
    code-fold: true
    code-tools: true
    df-print: kable
    toc: true
    toc-depth: 2
editor: source
execute: 
  echo: true
  warning: false
  message: false
  fig.height: 6
  fig.width: 6
  fig.align: "center"
  comment: ""
bibliography: references.bib
---

```{r}
#| label: load packages and functions

####  Packages  ####
library(targets)
library(rnaturalearth)
library(here)
library(sf)
library(gmRi)
library(patchwork)
library(gt)
library(knitr)
library(tidyverse)
library(ggstream)
library(ggforce)
library(bcp)
library(scales)

# Support functions
source(here("R/support/sizeSpectra_support.R"))

# Set theme
theme_set(theme_gmri())

# Map polygons
us_poly <- ne_states("united states of america", returnclass = "sf")
canada <- ne_states("canada", returnclass = "sf")


# Function to process summaries for various factor combinations
get_group_summaries <- function(...){
  
  # Do some grouping to get totals
  group_totals <- nefsc_size_bins %>% 
    group_by(...) %>% 
    summarise(total_survey_catch = sum(numlen, na.rm = T),
              total_lw_bio = sum(sum_weight_kg, na.rm = T),
              total_strat_abund = sum(strat_total_abund_s, na.rm = T),
              total_strat_lw_bio = sum(strat_total_lwbio_s, na.rm = T), 
              .groups = "drop") 
  
  # length bins
  group_lengths <- nefsc_size_bins %>% 
    group_by(..., length_bin) %>% 
    summarise(lenbin_survey_catch = sum(numlen),
              lenbin_lw_bio       = sum(sum_weight_kg),
              lenbin_strat_abund  = sum(strat_total_abund_s),
              lenbin_strat_lw_bio = sum(strat_total_lwbio_s), 
              .groups = "drop") %>% 
    left_join(group_totals) %>% 
    mutate(
      perc_total_catch  = (lenbin_survey_catch - total_survey_catch) * 100,
      perc_lw_bio       = (lenbin_lw_bio - total_lw_bio) * 100,
      perc_strat_abund  = (lenbin_strat_abund - total_strat_abund) * 100,
      perc_strat_lw_bio = (lenbin_strat_lw_bio - total_strat_lw_bio) * 100)
  
  # weight bins
  group_weights <- nefsc_size_bins %>% 
    group_by(..., weight_bin) %>% 
    summarise(wtbin_survey_catch = sum(numlen),
              wtbin_lw_bio       = sum(sum_weight_kg),
              wtbin_strat_abund  = sum(strat_total_abund_s),
              wtbin_strat_lw_bio = sum(strat_total_lwbio_s),
              .groups = "drop") %>% 
    left_join(group_totals) %>% 
    mutate(
      perc_total_catch  = (wtbin_survey_catch / total_survey_catch) * 100,
      perc_lw_bio       = (wtbin_lw_bio / total_lw_bio) * 100,
      perc_strat_abund  = (wtbin_strat_abund / total_strat_abund) * 100,
      perc_strat_lw_bio = (wtbin_strat_lw_bio / total_strat_lw_bio) * 100)

return(list("length_bins" = drop_na(group_lengths),
            "weight_bins" = drop_na(group_weights)))
}


```

# Abstract

The Northwest Atlantic ocean bordering the United states and Scotian Shelf is one of the fastest warming locations on Earth. Research on the impacts of this rapid-warming has primarily focused on high-profile and/or upper trophic level species. Here we investigate an the ecosystem wide impacts by integrating community size structure changes using size spectrum analysis. While laboratory studies and ecological theory suggest that ectotherms raised at higher temperatures will reach smaller body-sizes at comparable development stages, it is unclear whether that relationship can be mitigated against across a diverse community through collective individual behaviors. In cases where communities fails to mitigate/adapt to elevated temperatures, we anticipate a steepening of the body-size spectrum slope relating to a reduction in larger sized individuals and an increase in smaller sized individuals within that community. Using groundfish abundance data from fisheries independent surveys we estimated size spectrum indices for four regions along the US NE continental shelf. At the regional scale we found that declines in the size spectrum slopes occurred the strongest in the Gulf of Maine and Georges Bank regions. Regions possessing the coldest temperatures and the largest populations of commercially targeted groundfish species. The largest declines in size spectrum slope occurred earlier in these areas than the more-recent temperature trends, suggesting other external forces may have driven the decline in larger-sized individuals within the communities. While the primary pressure of fisheries exploitation has declined over time, recovery in terms of larger-bodied individuals remains threatened by elevated temperatures.

# Introduction

This is a direct quote, needs a citation:

> Temperature is the most important physical factor affecting processes at multiple scales of organization from cellular chemical reaction rates, organismal physiological processes, population productivity and distribution, and interactions among species in complex communities (Fry 1971, Magnuson et al. 1979, Claireaux and Lefrançois 2007).

Temperature related effects on marine organism physiology impacts:

1.  The acquisition of biomass through feeding

2.  The loss of biomass through metabolism

3.  The rates of development

## Global/Regional Ocean Temperatures

-   Osman et al. 2011 (climate change hockey stick)
-   Marine species distribution shifts in NE Atlantic shelf [@kleisner2017]

## Temperature Impacts on Growth

In most species differences in the temperature-dependence of these rates causes early life stages to grow more quickly in warmer water. This rapid early growth is then usually followed by an earlier maturation and a smaller size at maturity. **Citations needed TSR & Berggman Rule.** Multiple competing explanations have been suggested to test how general the mechanisms are behind this relationship. **More citations about how contested this is**.

#### Experimental Evidence & TSR

-   Atkinson (2003)
-   Forster (2012)

#### In-Situ Evidence 

-   North sea groundfish
-   Range shifts NW Atlantic Kleisman

## Size Spectrum Theory

**Importance of size in ecology:**

Size is a defining characteristic of a species, and of individuals. Size impacts the mobility of an organism, its ability to evade predation, its ability to successfully prey on other organisms, and the metabolic costs associated with each of these behaviors. Size structured environments are...

**What is a size spectrum**

A "size spectrum" describes the distribution of biomass or abundance as a function of individuals\' mass or size on a log--log scale [@guiet2016]. Size spectrum are described by two terms, the size spectrum slope & intercept, which contain the following ecological relationships: The size spectrum slope captures the rate at which abundance declines with increasing body size. The slope reflects the efficiency of energy transfer moving from smaller to larger individuals via processes like growth and predation. Variation in the slope has been associated with **fishing pressure** [@bianchi2000; @shin2005] and to **environmental conditions** through numerical experiments [@guiet2016]. The intercept on the other hand captures the richness or the productivity of the community. This term is thought to be related to, or even defined, by the environmental conditions [@boudreau1992; @guiet2016, @rossberg2012].

**Size spectrum applications**

The size spectrum relationship is the community-wide integration of individual-level processes like growth, maintenance, and size-selective predation \[@guiet2016\]. Spectra condense the complexities of predator prey networks and their interactions into a handful of size-based metrics. In doing so a community size spectrum captures the emergent properties of a system, while needing size and abundance information that is commonly available. For this reason it has become increasingly relied upon as an indicator of ecosystem health in the push for ecosystem based fisheries management. As an index, size spectra capture changes in energy flow within a community. Looking at changes to the efficieny of energy flow in a system is a way that ecologists and natural resource manages can track the health of an ecosystem. Inefficient transfer of energy, a symptom of poor prey availability or size mismatches, produces steeper slopes and/or fewer trophic levels. Disturbances like the physical removal of specific size classes through fishing directly impacts spectrum slopes through removal of larger individuals. Differences in intercept are more commonly attributed to environmental differences. Lower productivity communities (with exceptions) supporting less complex food webs (less biomass available to transfer).

### Temperature of the Gulf of Maine & NE Shelf

Sea surface temperatures in the Gulf of Maine since 1982 have been warming at rates faster than 96% of the world's oceans, with similar warming rates along the northwest Atlantic shelf [@pershing2018]. A punctuated elevation in temperatures over the last decade are believed to be the result of a shift in Gulf Stream positioning. A Northward shift in the Gulf stream has increased the regional temperatures via an increased direct transport of warm gulf stream water into areas like the Gulf of Maine . The Gulf stream has also been producing a higher frequency of warm core rings, and has obstructed some of the cold-water Scotian Shelf current flow that would otherwise counter the influence of the Gulf Stream on the region's temperatures [@gangopadhyay2019; @meyer-gutbrod2021]. The combination of these oceanographic changes has led to a warmer continental shelf habitat.

### Species Trends in NE Shelf

The observed warming in the northwest Atlantic has been shown to be a major factor in the redistribution of marine species along the US east coast. Species have responded to these warming trends by adjusting the timing and locations of their seasonal migrations and shifting their geographic ranges [@nye2009; @staudinger2019]. There is also evidence that warming has hampered fisheries recoveries through its physiological impacts on growth and metabolism. Species like Black Sea Bass, Atlantic shortfin squid, and Blue crab have been high-profile examples of species expanding their ranges to follow their thermal preferences. While species like the American lobster have shown declines at their southern range near Long Island Sound, with much doubt whether they will recover under the present temperature trends. The recent regime shift in the physical oceanography has also shown to be a catalyst for biological shifts as well [@meyer-gutbrod2021; @perretti2017].

While these examples show that species can respond to changes in the physical environment around them through movement & behavior, research elsewhere suggests that physiological responses integrated across species will manifest as changes in community size structure.

### Purpose

We estimated size spectrum relationships for the groundfish populations for each sub-region of the Northeast US continental shelf.

In the context of a strongly size-structured ecosystem, growth and maturity changes alter fitness and ultimately determine whether a species is successful in the given environment.

**In the case of the NW Atlantic:** sustained increases in temperature should have a physiological impact on the community.

This leads to our second hypothesis:

> #### H2. Warming alters the community through the direct influence of temperature on metabolism, growth, and population productivity.

# Methods

## Groundfish Data

```{r}
#| label: load survdat_data

# 1. Biological data used as input
withr::with_dir(rprojroot::find_root('_targets.R'), 
                tar_load(nefsc_1g_labelled))   

# rename and format
nefsc_size_bins <- nefsc_1g_labelled

n_species <- length(unique(nefsc_size_bins$comname))
```

Fishery Independent data on was collected as part of the NEFSC's northeast trawl survey. This survey is conducted each year in the spring and in the fall, with sample locations determined following a stratified-random survey design with effort allocated in proportion to stratum area. Analyses using the trawl survey data took used data from both the Spring and Fall survey seasons covering all years from 1970 to 2019. Correction factors were applied to total species abundance and biomass to account for changes in vessels, gear, and doors when appropriate as part of the survey program. However, abundance and biomass by length is not corrected. To account for this, abundance at length for each species were adjusted to match the correction factors applied to total species abundance at each station, with allocation following the distributions of length caught at that station. Such that for each species: the sum of adjusted abundances for each length class is equal to the gross abundance as corrected for changes in vessels, gear, etc. To account for differences in sampling effort among survey strata, all corrected abundance-at-length data was area-stratified.

```{r}
#| label: make region map

# Get region polygons:

# Get the paths to the shapefiles used to mask
trawl_paths <- gmRi::get_timeseries_paths(region_group = "nmfs_trawl_regions", mac_os = "mojave")

# Polygons for each region
all_poly <- read_sf(trawl_paths[["inuse_strata"]][["shape_path"]]) 

  
ggplot() +
  geom_sf(data = us_poly) +
  geom_sf(data = canada) +
  geom_sf(data = all_poly, aes(fill = survey_area), alpha = 0.8) +
  coord_sf(xlim = c(-76.4, -64.4), ylim = c(35, 45.5), expand = F) +
  scale_fill_gmri() +
  theme_bw() +
  map_theme(legend.position = "bottom", 
            legend.background = element_rect(fill = "white")) +
  guides(fill = guide_legend(title = "", nrow = 2))
```

Data from the survey was grouped by strata to form geographically meaningful sub-regions: Gulf of Maine, Georges Bank, Southern New England, Mid-Atlantic Bight. For each region, we developed several time series indicators:

1.  Community Composition metrics (abundance and biomass by functional group, with body-size contributions)

2.  Mean size of the aggregate community and key functional groups

3.  Slope and intercept of the size spectrum\

### Community Composition

Functional groups were assigned to each species based on life history and geography. Functional groups included were elasmobranch, pelagic, demersal, and groundfish species. Stratified annual abundance and biomass totals were calculated for each functional group and each region with labels for increasing body-size (biomass kg) groups.

```{r}
#| label: group biomass and abundance data

# make a column that contains all data
nefsc_size_bins <- nefsc_size_bins %>% 
  mutate(group_col = "All Data") 

# Do some grouping by year survey area and functional group
fgroup_area <- get_group_summaries(Year, survey_area, spec_class)

```

### Body Size Trends

The annual stratified-abundance weighted body length and body weight within each region and for each functional group were also estimated using the numbers at length and the estimated biomass at length information. Data for body size trends was not truncated at 1g minimum body weight.

```{r}
#| label: body size data

# Load the average body size data
withr::with_dir(rprojroot::find_root('_targets.R'), 
                tar_load(mean_sizes_ss_groups))   

# Grouped on year and region
regional_size <- mean_sizes_ss_groups %>% 
  filter(`group ID` == "single years * region") %>% 
  mutate(Year = as.numeric(Year),
         factor(survey_area, levels = c("GoM", "GB", "SNE", "MAB")))

```

### Size Spectrum Analysis

Community size spectra were estimated using abundance-at-length data from `r n_species` species. These species were selected based on the availability of published weight-at-length relationships (Wigley et al. 2003) and represented 98.98% of the total biomass caught in the survey. Published length-weight relationships were used to convert abundance at length data into their corresponding biomass at length (kg). These values were then used to get totals for stratified weight-at-length, in complement to the corrected abundances-at-length data which had been area stratified. These area-stratified biomass at length totals were then used for fitting each regional biomass size spectra.

To fit the normalized biomass size spectra, stratified biomass at length data was binned into logartithmically equal spaced intervals (0.5 on a $log_{10}$ scale), summing bodymass across all species within each body size bin. To normalize the spectra, the atratified abundances within each bin was then divided by the bin-width to account for the increasing bin-widths, a consequence of the log scale. Normalized size spectra were fit for each year and for each region independently, and for each year across all strata, using ordinary least squares (ols) regressions for stratified abundance (normalized) by body-size bins.

```{r}
#| label: load the size spectrum indices
withr::with_dir(rprojroot::find_root('_targets.R'), 
                tar_load(size_spectrum_indices))   


# Grab SS Groups we care about
region_indices <- size_spectrum_indices  %>% 
  filter(`group ID` == "single years * region") %>% 
  mutate(yr = as.numeric(as.character(Year)),
         survey_area = factor(survey_area, levels = c("GoM", "GB", "SNE", "MAB")),
         sig_fit = ifelse(l10_sig_strat < 0.05, "Significant", "Non-Significant"))

```

## Temperature Data

Global Sea surface temperature data was obtained via NOAA's optimally interpolated SST analysis (OISSTv2), providing daily temperature values at a 0.25° latitude x 0.25° longitude resolution (Reynolds et al. 2007). A daily climatology for every 0.25° pixel in the global data set was created using average daily temperatures spanning the period of 1982-2011. Daily anomalies were then computed as the difference between observed temperatures and the daily climatological average. OISSTv2 data used in these analyses were provided by the NOAA PSL, Boulder, Colorado, USA from their website at https://psl.noaa.gov.

Temperature data was regionally averaged to match the survey regions from the age-at-length data. SST anomalies were averaged by year for each region and over the entire sampling region to produce daily time series. These time series were then processed into annual timeseries of surface temperatures and anomalies. All region-averaging was done with area-weighting of the latitude/longitude grid cells to account for differences in cell-size in of the OISSTv2 data.

```{r}
#| label: load temperature data

# Load the regional temperatures from {targets}
withr::with_dir(rprojroot::find_root('_targets.R'), 
                tar_load(regional_oisst))



```

## Spectra Drivers

The impact of external factors on the changes in size spectra was compared against several hypothesized driving forces. External factors proposed as potential drivers included sea surface temperature anomalies, fishing pressure (Fogarty overfishing index), North Atlantic Oscillation (NAO), and zooplankton community indices.

# Results

### Abundance Distribution

```{r}
#| label: abundance distributions
#| fig.width: 8
#| fig-height: 8

# panel plot the biomass by body size
fgroup_area$weight_bins %>% 
  mutate(strat_abund_mill = wtbin_strat_abund / 1e6) %>% 
ggplot(aes(Year, strat_abund_mill, fill = weight_bin)) +
  geom_col(position = "stack", color = "gray80", size = 0.1) +
  facet_grid(survey_area~spec_class) +
  scale_fill_gmri() +
  scale_y_continuous(labels = comma_format()) +
  labs(y = "Stratified Total Abundance (millions)",  
       title = "Abundance Allocation by Weight",
       x = "", 
       fill = "Individual Weight (kg)") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, hjust = 1))


```

### Biomass Distribution

Overall biomass was highest in the two northern regions, the Gulf of Maine and Georges Bank. Roughly half of the biomass sampled in these regions can be attributed to groundfish/demersal species, with the second largest contributions coming from elasmobranchs. Groundfish biomass, larger individuals \>2kg in particular, declined during the 70's and 80's in these regions, never truly recovering. Beginning in the 2000's there were signs that groundfish abundances were increasing as evidenced by increasing numbers of smaller individuals, however in both regions this trend appears to have reversed by the mid 2010's. Elasmobranch populations increased steadily throughout the survey time period across all regions, but for southern New England where they were more flat but with high/low periods. Larger elasmobranch were rare in all regions except for a period spanning the late 70's through the early 90's isolated to Georges Bank. Demersal species biomass was highest in the Gulf of Maine, dwarfing their contributions in other regions. Their biomass declined in the 70's, was flat until the late 90's, remaining relatively high until declining in the late 2010's. Pelagic species biomass was low in all regions, and is unlikely to be representative of true biomass trends due to gear selectivity.

```{r}
#| label: bodymass distributions
#| fig.width: 8
#| fig-height: 8

# panel plot the biomass by body size
fgroup_area$weight_bins %>% 
  mutate(strat_lwbio_mill = wtbin_strat_lw_bio / 1e6) %>% 
ggplot(aes(Year, strat_lwbio_mill, fill = weight_bin)) +
  geom_col(position = "stack", color = "gray80", size = 0.1) +
  facet_grid(survey_area~spec_class) +
  scale_fill_gmri() +
  scale_y_continuous(labels = comma_format()) +
  labs(y = "Stratified Total Biomass (million kg)",  
       title = "Biomass Allocation by Weight",
       x = "", 
       fill = "Individual Weight (kg)") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, hjust = 1))


```

### Regional Variation in Species Composition

There was a distinct difference between Northern and Southern regions in the way biomass was distributed among the different functional groups. The primary contributors to overall biomass in the southern regions (southern New England & mid-Atlantic bight) was the elasmobranch community. While the northern regions (Gulf of Maine & Georges Bank) each had similar quantities of elasmobranch biomasses, there was also a comparable contribution of groundfish and demersal species as well.

### Body Size Trends

```{r}
#| label: average body size trends
#| fig.height: 8

# Length plot
avg_len_p <- ggplot(regional_size, 
       aes(Year, mean_len_cm, group = survey_area)) +
  geom_line() + 
  geom_point() +
  facet_wrap(~survey_area, ncol = 1) + 
  labs(title = "Average Length",
       y = "Length (cm)")


# Weight plot
avg_wt_p <- ggplot(regional_size, 
       aes(Year, mean_wt_kg, group = survey_area)) + 
  geom_line() + 
  geom_point() +
  facet_wrap(~survey_area, ncol = 1)+ 
  labs(title = "Average Weight",
       y = "Weight (kg)")
  
# Plot side by side
avg_len_p | avg_wt_p

```

### Regional Size Spectra

Size spectrum slopes were least steep in the two Northern regions.

-   Steepening of northern slopes

-   lack of bounce-back

-   all slopes similar steepness

```{r}
#| label: size spectra results
#| fig.height: 8


# Plot the Regional Slopes
slope_timeline <- ggplot(region_indices, 
                         aes(yr, l10_slope_strat, group = survey_area)) +
  geom_line(linetype = 1) +
  geom_point() +
  scale_color_gmri() +
  facet_wrap(~survey_area, ncol = 1) +
  # geom_smooth(method = "lm", formula = y~x, alpha = 0.75) +
  labs(x = "Year", y = "Slope", title = "Normalized Biomass Spectra") 

# Plot the Regional Intercepts
int_timeline <- ggplot(region_indices, aes(yr, l10_int_strat, group = survey_area)) +
  geom_line(linetype = 1) +
  geom_point() +
  facet_wrap(~survey_area, ncol = 1) +
  # geom_smooth(method = "lm", formula = y~x, alpha = 0.75) +
  labs(x = "Year", y = "Intercept") 


# Assemble
slope_timeline | int_timeline 
```

## Size Spectra Drivers

### Temperature Trends

```{r}
#| label: Temperature regime shift
#| fig.height: 8

# Plot how each one exhibits a break in the temperature across the region
# Get regional averages
temp_regimes <- regional_oisst %>% 
  filter(yr > 1981) %>% 
  mutate(
    regime = ifelse(sst_anom > 0, "hot", "cold"),
    survey_area = ifelse(survey_area == "all", "Full Region", survey_area),
    survey_area = factor(survey_area, levels = c("Full Region", "GoM", "GB", "SNE", "MAB"))) 



# Plot the timelines
temp_regimes %>% 
  #filter(survey_area == "Full Region") %>% 
  ggplot( aes(yr, sst_anom)) +
  geom_col(aes(fill = regime),  size = 0.75, alpha = 0.8) +
  scale_fill_gmri() +
  scale_color_gmri() +
  scale_x_continuous(expand = expansion(add = c(0.25,0.25))) +
  scale_y_continuous(labels = number_format(suffix = " \u00b0C")) +
  facet_wrap(~survey_area, ncol = 1) +
  guides(fill = "none") +
  theme(
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.background = element_rect(fill = "transparent"),
    legend.key = element_rect(fill = "transparent", color = "transparent")) + 
  labs(
    title = "NW-Atlantic Regional SST Anomalies",
    x = "", 
    y = "Surface Temperature Anomaly",
    caption = "Anomalies calculated using 1982-2011 reference period.") +
  guides(label = "none",
         color = guide_legend(keyheight = unit(0.5, "cm")))

```

### Overfishing Trends

### 

# Discussion

# References
