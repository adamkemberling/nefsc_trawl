---
title: "Community Size-Structure of the Northwest Atlantic Groundfish Communities, Response to Direct Disturbance and a Changing Environment"
author: 
    name: "Adam A. Kemberling"
    title: "Quantitative Research Associate"
    url: https://github.com/adamkemberling
    affiliation: Gulf of Maine Research Institute
description: | 
  Results from a Individual Size Distribution Analysis of the Northeast US Groundfish Community
date: "`r Sys.Date()`"
# format: docx
format:
  html:
    self-contained: true
    code-fold: true
    code-tools: true
    df-print: kable
    toc: true
    toc-depth: 2
editor: source
execute: 
  echo: false
  warning: false
  message: false
  fig.height: 6
  fig.width: 7
  fig.align: center
  comment: ""
bibliography: references.bib
csl: ices-journal-of-marine-science.csl
---

```{r}
#| label: load packages and functions

####  Packages  ####
library(car)
library(targets)
library(rnaturalearth)
library(here)
library(sf)
library(gmRi)
library(patchwork)
library(gt)
library(knitr)
library(tidyverse)
library(ggstream)
library(broom)
library(bcp)
library(scales)
library(corrplot)
library(readxl)
library(Hmisc)
library(MuMIn)
library(gtsummary)
library(broom.helpers)
# changepoint package
library(EnvCpt)

# Package Conflicts
conflicted::conflict_prefer("select", "dplyr")
conflicted::conflict_prefer("filter", "dplyr")

# Support functions
source(here("R/support/sizeSpectra_support.R"))

# Resource Path
res_path <- gmRi::cs_path("res")

# GGplot theme
theme_set(theme_gmri() + theme(
  panel.grid.major = element_line(linewidth = 0.5, linetype = 1, color = "gray"),
  panel.grid.major.x = element_line(linewidth = 0.5, linetype = 3, color = "gray"),
  panel.grid.minor = element_line(linewidth = 0.5, linetype = 3, color = "gray90"),
  axis.line = element_line(color = "black"),
  axis.line.y = element_line(color = "black"), 
  strip.background = element_rect(colour = gmri_cols("teal")),
  legend.position = "bottom"))

# Map polygons
us_poly <- ne_states("united states of america", returnclass = "sf")
canada <- ne_states("canada", returnclass = "sf")

# levels for faceting areas
area_levels <- c("Northeast Shelf, Full", "GoM", "GB", "SNE", "MAB")
area_levels_long <- c("Northeast Shelf, Full", "Gulf of Maine", "Georges Bank", "Southern New England", "Mid-Atlantic Bight")

# table to join for swapping shorthand for long-hand names
area_df <- data.frame(
  area = c("Scotian Shelf", "Gulf of Maine", "Georges Bank", "Southern New England", "Mid-Atlantic Bight", "All"),
  survey_area = c("SS", "GoM", "GB", "SNE", "MAB", "Northeast Shelf, Full"),
  area_titles = c("Scotian Shelf", "Gulf of Maine", "Georges Bank", "Southern New England", "Mid-Atlantic Bight", "Northeast Shelf, Full"))
```



```{r}
#| label: functions-cell

# Function to process summaries for various factor combinations
get_group_summaries <- function(data_in, ...){
  
  # Do some grouping to get totals
  group_totals <- data_in %>% 
    group_by(...) %>% 
    summarise(total_survey_catch = sum(numlen, na.rm = T),
              total_lw_bio = sum(sum_weight_kg, na.rm = T),
              total_strat_abund = sum(strat_total_abund_s, na.rm = T),
              total_strat_lw_bio = sum(strat_total_lwbio_s, na.rm = T), 
              .groups = "drop") 
  
  # length bins
  group_lengths <- data_in %>% 
    group_by(..., length_bin) %>% 
    summarise(lenbin_survey_catch = sum(numlen),
              lenbin_lw_bio       = sum(sum_weight_kg),
              lenbin_strat_abund  = sum(strat_total_abund_s),
              lenbin_strat_lw_bio = sum(strat_total_lwbio_s), 
              .groups = "drop") %>% 
    left_join(group_totals) %>% 
    mutate(
      perc_total_catch  = (lenbin_survey_catch - total_survey_catch) * 100,
      perc_lw_bio       = (lenbin_lw_bio - total_lw_bio) * 100,
      perc_strat_abund  = (lenbin_strat_abund - total_strat_abund) * 100,
      perc_strat_lw_bio = (lenbin_strat_lw_bio - total_strat_lw_bio) * 100)
  
  # weight bins
  group_weights <- data_in %>% 
    group_by(..., weight_bin) %>% 
    summarise(wtbin_survey_catch = sum(numlen),
              wtbin_lw_bio       = sum(sum_weight_kg),
              wtbin_strat_abund  = sum(strat_total_abund_s),
              wtbin_strat_lw_bio = sum(strat_total_lwbio_s),
              .groups = "drop") %>% 
    left_join(group_totals) %>% 
    mutate(
      perc_total_catch  = (wtbin_survey_catch / total_survey_catch) * 100,
      perc_lw_bio       = (wtbin_lw_bio / total_lw_bio) * 100,
      perc_strat_abund  = (wtbin_strat_abund / total_strat_abund) * 100,
      perc_strat_lw_bio = (wtbin_strat_lw_bio / total_strat_lw_bio) * 100)

return(list("length_bins" = drop_na(group_lengths),
            "weight_bins" = drop_na(group_weights)))
}



# Function to process summaries for various factor combinations
log2_bin_summaries <- function(data_in, ...){
  
  # Do some grouping to get totals
  group_totals <- data_in %>% 
    group_by(...) %>% 
    summarise(total_survey_catch = sum(numlen, na.rm = T),
              total_lw_bio = sum(sum_weight_kg, na.rm = T),
              total_strat_abund = sum(strat_total_abund_s, na.rm = T),
              total_strat_lw_bio = sum(strat_total_lwbio_s, na.rm = T), 
              .groups = "drop") 
  
  # weight bins
  group_weights <- data_in %>% 
    mutate(weight_bin = bin_label) %>% 
    group_by(..., left_lim) %>% 
    summarise(wtbin_survey_catch = sum(numlen),
              wtbin_lw_bio       = sum(sum_weight_kg),
              wtbin_strat_abund  = sum(strat_total_abund_s),
              wtbin_strat_lw_bio = sum(strat_total_lwbio_s),
              .groups = "drop") %>% 
    left_join(group_totals) %>% 
    mutate(
      perc_total_catch  = (wtbin_survey_catch / total_survey_catch) * 100,
      perc_lw_bio       = (wtbin_lw_bio / total_lw_bio) * 100,
      perc_strat_abund  = (wtbin_strat_abund / total_strat_abund) * 100,
      perc_strat_lw_bio = (wtbin_strat_lw_bio / total_strat_lw_bio) * 100)

return(list("weight_bins" = drop_na(group_weights)))
}




# Function to grab the correlation data and lag data
get_ccf_vector <- function(x,y){
  
  # Run the ccf
  ccf_data <- ccf(x,y,plot= F , lag.max = 15)
  
  # Get the signif:
  # https://www.squaregoldfish.co.uk/programming/r_acf_significance.md/
  # Not 100% sure n is the same for ccf as it is for acf, but...
  significance_level <- qnorm((1 + 0.95)/2)/sqrt(sum(!is.na(x)))
  
  data.frame(
    "acf" = ccf_data$acf,
    "lag" = ccf_data$lag,
    "sigpos" = significance_level,
    "signeg" = significance_level*-1
  )
}


# Plotting the correlation matrix over a specific decade
plot_period_correlations <- function(x, label) {
  x %>% 
    filter(response_short != "Spectra Slope",
           response_area != "All") %>% 
    ggplot(aes(var1, response_short, fill = r2)) +
    geom_tile() +
    geom_text(aes(label = signif)) +
    facet_grid(response_area ~ driver_type, scales = "free_x", space = "free") +
    scale_fill_distiller(palette = "RdBu", limits = c(-1, 1), breaks = c(-1,0,1)) +
    coord_cartesian(clip = "off") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
          axis.text.y = element_blank(),
          strip.text.y = element_text(angle = 0),
          legend.position = c(1.205, -.25),
          legend.title = element_text(vjust = 0.75),
          plot.caption = element_text(hjust = 0)) +
    guides(fill = guide_colorbar(title.position = "top", title.hjust = 0.5)) +
    labs(x = "Correlated Feature", y = "Size Spectrum Slope",
         fill = "Correlation Coefficient",
         title = str_c(label, " | Correlation of Size Spectra to Hypothesized Drivers"),
         subtitle = "Correlation coefficients shown display same-year correlations.",
         caption = md("* Symbol signals a significant correlation at an alpha =  0.05"))
  
}

```

### Potential Journals:

1.  **ICES Journal of Marine Science**

# Abstract

The surface waters of the Northwest Atlantic Ocean are among the fastest warming on Earth. This area is highly-productive biologically, and there are concerns that ecological consequences will follow this rapid-warming. Research on the impacts of this rapid warming has primarily focused on high-profile and/or upper trophic level species. Ecological theory and laboratory studies suggest that elevated temperatures facilitate early maturation and smaller adult body-sizes. However, it is unclear whether that relationship might be mitigated against through adaptive behaviors in an open ocean environment. Here we've investigated ecosystem wide impacts on the individual size distribution (ISD) to track changes in community size structure. In cases where community responses are not adequate to counter the impacts of elevated temperatures, we anticipated a steepening of the size spectrum slope (ISD exponent). A steeper relationship relating to a reduction in larger sized individuals and an increased prevalence of smaller sized individuals. Using data from fisheries independent surveys we calculated the community size spectra for four regions along the US NE continental shelf. Correlation/regression analyses were then performed to then assess the degree to which these changes were in alignment to hypothesized bottom-up and top-down disturbances. At the regional scale, we found that community size structure changes (spectra slope) were the largest in the Northern regions, in the Gulf of Maine and Georges Bank. These areas are home to the coldest temperatures and the largest proportions of groundfish species in the community. Spectrum slope declines were most pronounced in the 80's and 90's, before the rapid warming of the last decade. The timing of these declines suggest that external factors drove the initial declines of larger-sized individuals within the communities, before elevated temperatures began to influence the ecosystem. Correlation analyses reveal that while fisheries landings are strongly correlated with these declines, bottom-up factors of zooplankton community metrics, Gulf Stream Index, and SST anomalies are also important. While the primary pressure of fisheries exploitation has declined dramatically over time, the recovery of larger-sized individuals has not been seen. That kind of recovery will likely depend on the elevated temperatures seen over the last decade.

# Introduction

## Normalized Size Spectra & Individual Size Distributions

Size is a defining characteristic of species and mediates many ecological interactions and metabolic pathways (@brown2000) . Size is a big factor in determining the mobility of an organism. Mobility then impacts the ability to evade predation, foraging success, efforts to locate and follow essential habitats, geographic ranging, and the metabolic costs associated with each of these behaviors (@hillaert2018). Body size also mediates vulnerability to aspects the immediate environment such as temperature through heat exchange or the threat of desiccation in terrestrial species (@gillooly2001; @heatwole1969). Body size even informs life history features like life span and the trophic position an individual might occupy through its impact on metabolism and resource use (@white2007).

Size structured environments are a fundamental organizational pattern globally that emerges from these relationships **add_citation**. Within strongly size-structured ecosystems, growth and maturity changes alter fitness and ultimately determine whether a species is successful in that environment **add_citation** . Ecological theory is rich with models relating how energy transfers from smaller prey species to larger predatory trophic levels, the allocation of energy for growth, and the trade offs of allocating energy towards those ends (@bertalanffy1938; @vonbertalanffy1957; **add_citations)**. A globally persistent pattern in ecology entangled in those relationships and their critiques is the decline in abundance with increasing body size (@damuth1981; @currie1993; @sheldon1972; @loeuille2006).

This relationship, between size and abundance, integrates multiple processes operating on the cellular, individual, and community levels simultaneously. The quantities for size and abundance are also some of the most readily collected data assets of any ecological community. This creates an opportunity to learn much about a system from a relatively low-effort in data collection. For these reasons, size spectrum analyses and individual size distribution (ISD) methods have gained increasing attention as an entry point to assessing ecosystem health and to detect system-wide disturbance (@shin2005'; @pomeranz2022; @white2007). An advantage of these models is they avoid the need to explicitly articulate each predator-prey interactions as they and can be estimated from the commonly collected measures of abundance and size. The "size spectrum" describes the distribution of biomass or abundance as a function of individuals' mass or size on a log--log scale (@guiet2016; @kerr2001) . Size spectra are described by two terms, the size spectrum slope & intercept. These two terms reveal a sense of the baseline productivity, and how energy flows through an ecosystem (in the form of biomass) from many smaller individuals to many fewer large individuals. The spectrum intercept has been linked to the productivity of the community, and is often connected to the prevailing environmental conditions (@boudreau1992; @rossberg2012).

**How are they used in practice:**

Size spectra condense the complexities of predator prey networks and their interactions into a handful of size-based indices. These indices capture the emergent properties of a system, and have become increasingly used as indicators of ecosystem health. Within the context of fisheries management, changes in spectrum slopes have been associated with fishing exploitation, primarily through the targeted removal of larger individuals (@bianchi2000; @shin2005). Numerical experiments have also linked changes in slope to environmental disturbances (@guiet2016). Size spectra have also been shown to express predictable relationships between ecosystems of similar productivity levels as well as from distinct temperatures (@guiet2016).

**Use Pomerantz paper & Edwards to extend into ISD**

## Temperature & Ecology

Temperature plays a critical role on biological life impacting many of the chemical reactions that underpin basic physiological function. Temperature has direct and indirect impacts on critical biological functions including the acquisition of biomass through feeding, the rates of biomass loss through metabolism, and the rates at which individuals mature and develop. Because of these relationships, most species have evolved thermal preferences around which these chemical reactions are optimized. Species that are unable to maintain their thermal preferences internally must be able to follow their thermal preference in the environment through locomotion or adapt to less-favorable conditions through changes in behavior or risk metabolic costs in failing to do so. In an era of anthropogenic climate change, there is an expectation that many species will be displaced from historic habitats in their efforts to follow their thermal preferences. Recent research in marine environments has shown evidence of this as species are now shifting to higher latitudes and to deeper depths in the pursuit of more favorable conditions (@kleisner2017; @pinsky2013). Others have suggested that temperature related impacts may not be seen through geographic distribution change, but through physiological changes, changes in seasonal phenology, or in dashed hopes of species recovery (@daan2005; @miller2018; @pershing2015; @meyer-gutbrod2021).

**Need to connect temperature to size here**

Direct quote from @guiet2016 , but nails the connection back to temp expectations:

> Because it controls chemical reactions, temperature controls metabolic rates which underpin maintenance, growth or reproduction (Clarke and Johnston, 1999; Kooijman, 2010) as well as the functional responses to food density (Rall et al., 2012). Guiet et al. (2016)... In addition to the impact of temperature on communities' intercepts (heights), the impact of temperature on the speed of the energy flow within communities may affect other properties, such as their resilience to perturbations or the intensity of trophic cascades (Andersen and Pedersen, 2009).

The potential for elevated temperatures to impact the size structure of an ecosystem has implications for the ecosystem resilience in the face of climate change, as well as the blue economies & natural resource systems that rely upon their good health.

### Temperature of the Gulf of Maine & NE Shelf

In addition to the ecological disturbances of industrial fisheries, the Northwest Atlantic is also one of the fastest warming locations in the global oceans. Sea surface temperatures in the Gulf of Maine since 1982 have been warming at rates faster than 96% of the world's oceans, with similar warming rates along the northwest Atlantic shelf (@pershing2018). This persistent elevated temperature regime of the area is a result of several forces, a combination of shifting ocean currents and the unique bathymetry of the region. A Northward shift in the Gulf Stream directly increased the regional temperatures through increased transport of warm Gulf Stream water into areas like the Gulf of Maine. The Northward Gulf Stream shift is associated with a higher frequency of warm core rings, and the obstruction of cold-water Scotian Shelf current flow that would otherwise counter the influence of the Gulf Stream on the region's temperatures (@gangopadhyay2019; @meyer-gutbrod2021). The combination of these oceanographic changes has led to a warmer continental shelf habitat.

The rapid warming in the northwest Atlantic is a major factor in the redistribution of marine species along the US east coast. Species have responded by adjusting the timing and locations of their seasonal migrations and shifting their geographic ranges (@nye2009; @staudinger2019). There is evidence that warming has hampered fisheries recoveries as well. Adding a metabolic tax to physiological pathways like growth and metabolism. Species like Black Sea Bass, Atlantic shortfin squid, and Blue crab have been high-profile examples of species expanding their ranges to follow their thermal preferences. While species like the American lobster have shown declines at their southern range near Long Island Sound, with much doubt whether they will recover under the present temperature trends. The recent regime shift in the physical oceanography has also shown to be a catalyst for biological shifts as well (@meyer-gutbrod2021; @perretti2017).

While these examples show that species can respond to changes in the physical environment around them through movement & behavior, research elsewhere suggests that physiological responses integrated across species will manifest as changes in community size structure.

## Fishing Impacts on Size/Species Composition

**NEED fishing impacts on size structure references**

### Species Trends in the Northeast Atlantic Shelf

The continental shelf groundfish community in Northwest Atlantic has changed dramatically over the last century. Stocks that supported international fishing effort collapsed, and recovery efforts fell short of their objectives. Research on Georges Bank estimated that biomass more than halved in the 1960's (pre-dating federal monitoring efforts), and noted a species replacement of commercial groundfish target species by skate and dogfish (@fogarty1998). Industrial fishing is inherently size-selective, with larger individuals selectively removed from the population. This has an immediate impact on the community size-distribution with additional impacts on the future population as well. Larger individuals have a greater impact on population recovery, capable of holding more (and often of higher quality) eggs. Size-based harvest in fisheries has been shown to create selective pressures that promote characteristics of early maturation at smaller sizes **add_citation**.

**reference gb spectra early work**

### Purpose

With the understanding that populations depend on the health of their ecosystems, there is a need to have community-wide metrics to effectively understand and manage marine resources. Size based indices are metrics that can be estimated from the information that has historically been available from long-term survey efforts. These indices have been shown to be sensitive to the impacts of fishing, but should also capture environmentally driven stress as well. We estimated size spectrum relationships as SBI's for the groundfish populations for each sub-region of the Northeast US continental shelf. In the case of the NW Atlantic sustained increases in temperature should have a physiological impact on the community size structure.

This leads to our second hypothesis:

> H2. Warming alters the community through the direct influence of temperature on metabolism, growth, and population productivity.

# Methods


## Fish Data Source and Processing

```{r}
#| label: load-survdat

# 1. Biological data used as input
withr::with_dir(rprojroot::find_root('_targets.R'), tar_load(catch_log2_labelled))   

# rename and format
catch_size_bins <- catch_log2_labelled %>% fill_func_groups()

# Get total number of species
n_species <- length(unique(catch_size_bins$comname))
```

Data on the biomass, abundance, and size of fish on the Northeast U.S. Shelf were collected as part of the Northeast Fisheries Science Center's bottom trawl survey ( @grosslein1969, @Azarovits1981, @politis2014 ) This survey is conducted from Cape Hatteras, North Carolina to the Gulf of Maine each year in the spring and in the fall.  The survey follows a stratified random sampling design, with strata defined based on depth, bottom habitat, and latitude. Trawls are performed for a fixed duration at each station, reporting aggregate abundance and biomass for all species caught, and measuring individual lengths and weights for the catch of each species or a sub-sample if that catch is large. Correction factors were applied to aggregate species abundance and biomass to account for changes in vessels, gear, and doors used in the survey over time ( @sissenwine1978, @byrne1991, @miller2010 ) However, abundance and biomass at length needed to be estimated after these aggregate corrections. As such, abundance at length for each species was adjusted to match the corrected aggregate species abundance at each station, such that for each species, the sum of the resulting estimated abundance numbers across each length is equal to the corrected aggregate abundance.

```{r}
#| label: study-area-maps

#------------- Trawl Strata --------------

# Get the paths to the shapefiles used to mask
trawl_paths <- gmRi::get_timeseries_paths(region_group = "nmfs_trawl_regions", box_location = "cloudstorage")

# Polygons for each region
all_poly <- read_sf(trawl_paths[["inuse_strata"]][["shape_path"]]) 

# Make the Map
strata_map <- ggplot() +
  geom_sf(data = us_poly) +
  geom_sf(data = canada) +
  geom_sf(data = all_poly, aes(fill = survey_area), alpha = 0.8) +
  coord_sf(xlim = c(-76.4, -64.4), ylim = c(35, 45.5), expand = F) +
  scale_fill_gmri() +
  theme_bw() +
  map_theme(legend.position = c(0.6, 0.125), 
            legend.background = element_rect(fill = "white"),
            plot.caption = element_text(hjust = 0)) +
  guides(fill = guide_legend(title = "", nrow = 2)) 

# ----------- Landings Statistical Zones -----------------


# Shapefiles for the fisheries stat zones
stat_zones <- read_sf(str_c(res_path, "Shapefiles/Statistical_Areas/Statistical_Areas_2010_withNames.shp"))

# Make a list of zones to roughly match the survey areas:
fish_zones <- list(
  "Gulf of Maine" = c(511:515, 464, 465),
  "Georges Bank" = c(521, 522, 525, 561, 562),
  "Southern New England" = c(611, 612, 613, 616, 526, 537, 538, 539),
  "Mid-Atlantic Bight" = c(614:615, 621, 622, 625, 626, 631, 632))


# Trim out what we don't need and label them
stat_zones <- stat_zones %>% 
  mutate(
    survey_area = case_when(
      Id %in% fish_zones$"Gulf of Maine" ~ "Gulf of Maine",
      Id %in% fish_zones$"Georges Bank" ~ "Georges Bank",
      Id %in% fish_zones$"Southern New England" ~ "Southern New England",
      Id %in% fish_zones$"Mid-Atlantic Bight" ~ "Mid-Atlantic Bight")) %>% 
  filter(survey_area %in% c(
    "Georges Bank", "Gulf of Maine", "Southern New England", "Mid-Atlantic Bight"))

# Map it out? - takes forever from Chesapeake bay
garfo_map <- ggplot(stat_zones) +
  geom_sf(aes(fill = survey_area), alpha = 0.8) +
  geom_sf(data = us_poly) +
  geom_sf(data = canada) +
  coord_sf(xlim = c(-76.4, -64.4), ylim = c(35, 45.5), expand = F) +
  scale_fill_gmri() +
  theme_bw() +
  map_theme(legend.position = c(0.6, 0.125),
            legend.background = element_rect(fill = "white"),
            plot.caption = element_text(hjust = 0)) +
  guides(fill = guide_legend(title = "", nrow = 2)) 
# ggsave(garfo_map, filename = here::here("R/nmfs_size_spectra/images/garfo_regions.png"), bg = "white")


# Map them together
(strata_map | garfo_map) + plot_layout(guides = "collect")
```

### Community Composition & Functional Groups

Analyses were performed using 68 species. These species were selected based on the availability of published weight-at-length relationships (Wigley et al. 2003) and represented 98.98% of the total biomass caught in the survey. Each species was assigned to a functional group based on life history and geography using the definitions of (@hare2016). Functional groups included coastal fish, diadromous fish, elasmobranch, groundfish, and pelagic fish (@tbl-functional-groups). Six species with available length-weight details did not have a functional group designation, these species were designated as **reef species**. Exploratory analyses showed that the pelagic species biomass was low in all regions, and is unlikely to be representative of true biomass trends due to gear selectivity.

```{r}
#| label: biomass-group-summaries

# This cell provides the group summaries for how much biomass exists in each size/functional group

# Actual log10 bins
# Do some grouping by year survey area and functional group
fgroup_area <- log2_bin_summaries(data_in = catch_size_bins, Year, survey_area, hare_group)
fgroup_all  <- log2_bin_summaries(data_in = catch_size_bins, Year, hare_group)
fgroup_all  <- fgroup_all %>% map(~mutate(.x, survey_area = "Northeast Shelf, Full"))


# Join the overall values back in
fgroup_area <- map2(fgroup_area, fgroup_all, bind_rows)

```

Published length-weight relationships ( Wigley et al. 2003 ) were used to convert from length data, available for all individuals, into their corresponding biomass-at-length. To account for differences in sampling effort among survey strata, all corrected abundance-at-length data were area-stratified. Area-stratified biomass-at-length values were then computed as the product of area-stratified abundance-at-length and estimated weight-at-length. All analyses were performed using area-stratified abundances and their associated area-stratified biomass estimates, hereby referred to as simply abundance-at-length & biomass-at-length

<!--# Everything above here in methods describes the data source, and its pre-processing, Everything below details what is done with it -->



## Community Composition Metrics

Our analyses used all data collected during the spring and fall surveys from 1970-2019. Data were grouped using survey-design strata into four sub-regions: Gulf of Maine, Georges Bank, Southern New England, Mid-Atlantic Bight. These sub-regions have been widely used in regional ecological studies (e.g., ). For each region, we developed several time series indicators:

1.  Community Composition Metrics (regional abundance and biomass by functional group)

2.  Average length and weight of the aggregate community and each functional group

3.  Exponent of the Individual Size Distribution Spectra



### Body Size Changes

The average body length (cm) and body weight (kg) was calculated for all catch for each region and within each functional group. Each body-size metric was weighted by the abundance-at-length of a species sampled at each station such that.

$$X_j = \frac{ \sum_{}^{}  n_iX_{ij}  }{  \sum~w_i  }$$ Where $X$ is the body-size metric, $j$ is the year, & $n$ is the abundance for each station $i$.

Data for body size trends were not truncated using any minimum or maximum size and reflect all available catch data for the `r n_species`, for which biomass-at-length could be estimated.

```{r}
#| label: body size data

# Load the average body size data
withr::with_dir(rprojroot::find_root('_targets.R'), 
                tar_load(mean_sizes_ss_groups))   

# Overall across all regions
shelf_size <- mean_sizes_ss_groups %>% 
  filter(`group ID` == "single years") %>% 
  mutate(survey_area = "Northeast Shelf, Full")

# Grouped on year and region
regional_size <- mean_sizes_ss_groups %>% 
  filter(`group ID` == "single years * region") %>% 
  bind_rows(shelf_size) %>% 
  mutate(Year = as.numeric(Year),
         survey_area = as.character(survey_area)) %>% 
  left_join(area_df) %>% 
  mutate(area_titles = factor(area_titles, levels = area_levels_long),
         area_copy = survey_area)




# 2. Grouped on year, region, & functional group
functional_group_size <- mean_sizes_ss_groups %>% 
  filter(`group ID` == "single years * region * functional group") %>% 
  mutate(Year = as.numeric(Year),
         survey_area = factor(survey_area, 
                              levels = area_levels))

# Refactor areas
functional_group_size <- functional_group_size %>% 
  mutate(survey_area = as.character(survey_area))  %>% 
  left_join(area_df) %>% 
  mutate(area_titles = factor(area_titles, levels = area_levels_long),
         area_copy = survey_area)

```

### Estimating Size Spectra

```{r}
#| label: load the size spectrum indices
withr::with_dir(rprojroot::find_root('_targets.R'), 
                tar_load(size_spectrum_indices))   

# Grab the overall shelf-wide SS
shelf_ss <- size_spectrum_indices %>% filter(`group ID` == "single years") %>% 
  mutate(survey_area = "Northeast Shelf, Full")


# Grab SS Groups for each region
region_indices <- size_spectrum_indices  %>% 
  filter(`group ID` == "single years * region") %>% 
  bind_rows(shelf_ss) %>% 
  mutate(yr = as.numeric(as.character(Year)),
         survey_area = factor(survey_area, levels = area_levels),
         sig_fit = ifelse(log2_sig_strat < 0.05, "Significant", "Non-Significant"))

# Make a copy so we can gray out the lines in plots
# Merge the long names for labels "area_titles"
region_indices <- region_indices  %>% 
  mutate(survey_area = as.character(survey_area))  %>% 
  left_join(area_df) %>% 
  mutate(area_titles = factor(area_titles, levels = area_levels_long),
         area_copy = survey_area)

```

Lengths of individuals in the catch data are measured to the nearest cm, with smaller specimens measured to the nearest millimeter. Because individual biomass is estimated from those length measurements, there is a range of possible body mass values between the cm & mm increments. The relationship between length and mass in fishes is exponential and taxon specific, so biases resulting from using only the lower or upper end of those ranges is different for each taxon and increases for larger taxa. To account for this and reduce biases, we used the extended likelihood method (MLEbin) of @edwards2020. This method estimates the exponent of size spectra (b) for a bounded power law relationship between abundance and our length-derived estimates of individual biomass.

The exponent of this relationship is analogous to slope estimates from linear regression on logarithmic axes, with a steeper slope (i.e. a more negative b) indicating fewer large-bodied individuals and/or more small-bodied fishes @carvalho2021. This method has been shown to be the most accurate for estimating the exponent of size spectra when tested against alternative methods that require arbitrary decisions around binning the data (@white2008; @sprules2016; @edwards2017 ).

$$
\begin{align*}
f(x) = \frac{ (\lambda + 1)x^{\lambda} }{ x^{\lambda+1}_{max} - x^{\lambda+1}_{min} }~~~~~~\lambda\neq1,
\\
\\
f(x) = \frac{1}{logx_{max} - logx_{min}}~~~~~~\lambda=1
\end{align*}
$${#eq-ISD}

Using this method, the size spectra exponent (b) was estimated for each survey region from 1970 to 2019. A minimum biomass of 1g was used for the lower limit and a maximum biomass of 10kg was used as an upper limit for the ISD's bounded power law probability density function @eq-ISD, where $x$ is body mass & $\lambda$ is the scaling exponent of the ISD. The biomass within these limits constitutes 97.83% of all estimated biomass for the `r n_species` used in this study. This truncation accounts for poor gear selectivity at the smallest and largest size ranges and imposes shared limits to the size distribution we'd expect to sample across these different areas. Exponents of size spectra were calculated using code modified from the sizeSpectra package in R (@edwards2017; @edwards2020).

## Drivers of Size Spectrum Change

The impact of external factors on the changes in size spectra was correlated against several hypothesized driving forces related to both environmental regimes and anthropogenic disturbances. Potential large-scale environmental drivers include regional SST anomalies & the larger-scale impact of the Gulf Stream Index (GSI). Fishing pressure represents the primary top-down anthropogenic driver in the region, and was investigated using the aggregate regional commercial landings data. The potential bottom-up impacts of zooplankton community differences were incorporated at a regional scale using small and large zooplankton indices from the EcoMon plankton survey.

### Gulf Stream Index

Gulf stream index (GSI) values were obtained from the ecodata package in R (Bastille & Hardison 2018) . This package supplies GSI data at monthly intervals following the methodology of @pérez-hernández2014 and @joyce2019 , using as sea level height anomaly data from the Copernicus Marine Environment Monitoring Service

```{r}
#| label: gsi-data-prep
#| eval: true

####  2. Climate Drivers  ####

# From ecodata: GSI & Zooplankton

####  GSI

# Gulf Stream Index
gsi <- ecodata::gsi %>% 
  mutate(
    Time = str_pad(as.character(Time), width = 7, side = "right", pad = "0"),
    year = as.numeric(str_sub(Time, 1, 4)),
    month = str_sub(Time, -2, -1),
    Time = as.Date(str_c(year, month, "01", sep = "-")))
```

### Sea Surface Temperature Data

Global Sea surface temperature data was obtained via NOAA's optimally interpolated SST analysis (OISSTv2), providing daily temperature values at a 0.25° latitude x 0.25° longitude resolution (Reynolds et al. 2007). A daily climatology for every 0.25° pixel in the global data set was created using average daily temperatures spanning the period of 1982-2011. Daily anomalies were then computed as the difference between observed temperatures and the daily climatological average. OISSTv2 data used in these analyses were provided by the NOAA PSL, Boulder, Colorado, USA from their website at [https://psl.noaa.gov/data/gridded/data.noaa.oisst.v2.html](https://www.google.com/url?q=https://psl.noaa.gov/data/gridded/data.noaa.oisst.v2.html&sa=D&source=docs&ust=1675370947039361&usg=AOvVaw1ShFZYjArUTbnJyV_pkcaK).

Sea surface temperature data was regionally averaged to match the survey regions from the age-at-length data. SST anomalies were averaged by year for each region and over the entire sampling region to produce daily time series. These time series were then processed into annual timeseries of surface temperatures and anomalies. All region-averaging was done with area-weighting of the latitude/longitude grid cells to account for differences in cell-size in the OISSTv2 data.

```{r}
#| label: load temperature data

# Load the regional temperatures from {targets}
withr::with_dir(rprojroot::find_root('_targets.R'), 
                tar_load(regional_oisst))


# Get regional averages
temp_regimes <- regional_oisst %>% 
  filter(yr > 1981) %>% 
  mutate(
    regime = ifelse(sst_anom > 0, "hot", "cold"),
    survey_area = ifelse(
      survey_area == "all", 
      "Northeast Shelf, Full", 
      survey_area),
    survey_area = factor(survey_area, levels = area_levels)) 



```

### Commercial Fishing

Fishing pressure in the region was indexed using state and federal commercial fishing landings.  These data were obtained from the Greater Atlantic Regional Fisheries Office (GARFO) for statistical areas that are routinely used for fisheries reporting and management (Figure X).  Individual statistical areas were aggregated into regions that closely align with the survey areas we defined for the size spectra analyses (Figure X).

```{r}
#| label: garfo-data-prep
#| eval: true

####  GARFO Landings  ####

# Load the GARFO landings data:
# Landings of finfish* sheet 5
landings <- read_xlsx(
  path = str_c(res_path, "GARFO_landings/KMills_landings by area 1964-2021_JUN 2022.xlsx"), sheet = 5) %>% 
  rename_all(tolower)


# Add the labels into the landings data and remove what we don't need there:
landings <- landings %>% 
  mutate(
    survey_area = case_when(
      `stat area` %in% fish_zones$"Gulf of Maine" ~ "Gulf of Maine",
      `stat area` %in% fish_zones$"Georges Bank" ~ "Georges Bank",
      `stat area` %in% fish_zones$"Southern New England" ~ "Southern New England",
      `stat area` %in% fish_zones$"Mid-Atlantic Bight" ~ "Mid-Atlantic Bight")) %>% 
  filter(survey_area %in% c("Georges Bank", "Gulf of Maine", "Southern New England", "Mid-Atlantic Bight")) %>% 
  mutate(survey_area = factor(survey_area, area_levels_long))



# Get Summaries
landings_summ <- landings %>% 
  drop_na() %>% 
  rename(
    "weight_lb" = `landed lbs`,
    "live_lb" = `live lbs`) %>% 
  drop_na() %>% 
  group_by(year, survey_area) %>% 
  summarise( 
    across(
      .cols = c(value, weight_lb, live_lb), 
      .fns = list(mean = ~mean(.x , na.rm = T), 
                  total = ~sum(.x , na.rm = T)), 
      .names = "{.fn}_{.col}"), 
    .groups = "drop")  


# Scale the landings to create an index by area
landings_summ <- landings_summ %>% 
  group_by(survey_area) %>% 
  mutate(total_wt_z = base::scale(total_weight_lb)) %>% 
  ungroup()
```


### Zooplankton Abundance Indices

Zooplankton data are from the National Oceanographic and Atmospheric Administration Marine Resources Monitoring, Assessment and Prediction (MARMAP) program and Ecosystem Monitoring (EcoMon) cruises detailed extensively in Kane (2007), Kane (2011), and Morse et al. (2017). Abundance anomalies are computed from the expected abundance on the day of sample collection. The small copepod index is computed by averaging the individual abundance anomalies of Pseudocalanus spp., Centropages hamatus, Centropages typicus, and Temora longicornis. The large-copepod anomalies is the abundance anomaly of Calanus finmarchicus, the largest copepod in the Northeast U.S. region. Anomalies for both large and small zooplankton groups are then averaged within ecological production units for annual timeseries.


```{r}
#| label: zp-data-prep

# ADD Zooplankton: small and large zooplankton anomalies for the EPUS
# Don't need to scale

# Load original data
zp_sli <- ecodata::zoo_sli_anom %>% filter(EPU != "SS")

# Reformat to match the other indices
zp_index <- zp_sli %>% 
  #EPUS combine SNE and MAB, we can repeat the values here
  bind_rows(filter(zp_sli, EPU == "MAB") %>% mutate(EPU = "SNE")) %>% 
  mutate(
    survey_area = case_when(
      EPU == "GB" ~ "Georges Bank",
      EPU == "GOM" ~ "Gulf of Maine",
      EPU == "MAB" ~ "Mid-Atlantic Bight",
      EPU == "SNE" ~ "Southern New-England"),
    Units = str_c("zp_", Var)) %>% 
  select(year = Time, survey_area, Value, Units) %>% 
  pivot_wider(names_from = Units, values_from = Value)


```







```{r}
#| label: combine-drivers-table


####  Build a Common form for all Drivers:   ####
# Format: year, area, var, value

#--------------------
#### Reshape all the inputs so that we can bind them together in one dataframe


# 1.Climate Features

# Join the climate modes together
clim_drivers <- gsi %>% filter(EPU == "All")
  

# Put climate drivers on annual schedule
clim_idx <- clim_drivers %>% 
  group_by(year, area = EPU, var = Var) %>% 
  summarise(value = mean(Value, na.rm = T),
            .groups = "drop")

#--------------------
# 2. GARFO landings
landings_idx <- landings_summ %>% 
  group_by(year, area = survey_area) %>% 
  summarise(value = mean(total_wt_z, na.rm = T),
            .groups = "drop") %>% 
  mutate(var = "landings")


#--------------------
# 3. Temperature
sst_idx <- temp_regimes %>% 
  left_join(area_df, by = "survey_area") %>% 
  select(year = yr, area, value = sst_anom) %>% 
  mutate(var = "sst_anom")


#--------------------
# 4. Zooplankton
zp_idx <- zp_index %>% 
  pivot_longer(cols = c(zp_small, zp_large), names_to = "var", values_to = "value") %>% rename(area = survey_area)



#--------------------
#  4. Size Spectrum Slopes & Intercepts
ss_idx <- region_indices %>% 
  select(
    year = Year, 
    survey_area, 
    spectra_slope = log2_slope_strat, 
    #spectra_int = log2_int_strat,
    isd_slope = b) %>% 
  pivot_longer(
    # cols = c(spectra_slope, spectra_int, isd_slope), 
    cols = c(spectra_slope, isd_slope), 
    names_to = "var", 
    values_to = "value") %>% 
  mutate(year = as.numeric(year)) %>% 
  left_join(area_df, by = "survey_area") %>% 
  select(-survey_area)

#--------------------
# All Metrics Together
all_drivers <- bind_rows(
  list(
    clim_idx,
    landings_idx,
    sst_idx,
    zp_idx,
    ss_idx))

```




```{r}
#| label: driver-scaling

# In this chunk the drivers get reshaped to scale
# Scaling should cover the period of analysis 1982-2019
# SST and GSI (all index/anomaly fields) are not scaled


# Put the data in a wide form for scaling:
drivers_wide <- all_drivers %>% 
  filter(year >= 1982,
         year <= 2019) %>% 
  mutate(id = str_replace_all(str_c(area, "_", var), " ", "_")) %>% 
    select(-c(area, area_titles, var)) %>% 
    pivot_wider(names_from = id, values_from = value) %>% 
  column_to_rownames(var = "year")


# Scale the landings, not SST or GSI
to_scale   <- select(drivers_wide, ends_with("landings")) %>% scale() %>% as.data.frame()
dont_scale <- select(drivers_wide, -ends_with("landings"))

# Join back together
drivers_scaled <- bind_cols(dont_scale, to_scale) %>% 
  rownames_to_column(var = "year")


```


## Analysis of Driver Impacts




### Driver Cross Correlation Functions

In addition to evaluating the direct and contemporaneous impacts of each potential driver, additional predictors were identified for inclusion in the model-selection process through the use of cross correlation function (CCF) estimates and changepoint analysis. CCF estimates were used to look at correlation at one-year lag intervals to investigate potential time-delayed effects between the hypothesized drivers and the community’s size spectra. CCF estimates were performed between the dependent variables of the size spectra slope with the independent variables of the annual gulf stream index, the corresponding regional commercial landings and sea surface temperature anomalies, and both small and large zooplankton indices. Annual time lags on independent variables of up to 10 years that were identified in the CCF analysis were then included as additional candidate predictors in the regression analysis on drivers of the spectrum slope changes.



```{r}
#| label: ccf-data
#| fig-height: 8
#| fig-width: 8

# Run CCF function to get lagged correlations,
# Put that data in one table to plot in a better comparison form


#------------ Processing Data for CCF. ------------------------
# Scale Everything Before CCF,
# Reshape the Drivers Wide to scale
# Scale the columns independently using the variance in all years, but within an area
# Are the columns scaling independently or together?
# Confirmed independently scaling


# Drivers scaled trimmed is a matrix of all the different timeseries
# Columns that end with slope or intercept are pulled out to get a column of the response variables (slope features)
# Columns that don't contain "spectra" or "year" capture the remaining features
# Next we pull out the region information for each
driver_ccf_prep <- drivers_scaled %>% 
  select(-All_sst_anom) %>% 
  #rownames_to_column(var = "year") %>% 
  pivot_longer(names_to = "spectra_param", 
               values_to = "spectra_values", 
               cols = ends_with("slope") | ends_with("int")) %>% 
  pivot_longer(names_to = "driver_var", 
               values_to = "driver_values", 
               cols = -matches("spectra|year")) %>% 
  mutate(
    # C. These are the areas associated with the Spectra Features
    spectra_area = case_when(
      str_detect(spectra_param, "All")          ~ "All",
      str_detect(spectra_param, "Georges")      ~ "Georges Bank",
      str_detect(spectra_param, "Gulf")         ~ "Gulf of Maine",
      str_detect(spectra_param, "Southern")     ~ "Southern New England",
      str_detect(spectra_param, "Mid-Atlantic") ~ "Mid-Atlantic Bight"),
    spectra_area = factor(spectra_area, 
      levels = c("All", "Gulf of Maine", "Georges Bank", "Southern New England", "Mid-Atlantic Bight")),
    
    # D. These are the areas of the drivers
    driver_area = case_when(
      str_detect(driver_var, "All")          ~ "All",
      str_detect(driver_var, "Georges")      ~ "Georges Bank",
      str_detect(driver_var, "Gulf")         ~ "Gulf of Maine",
      str_detect(driver_var, "Southern")     ~ "Southern New England",
      str_detect(driver_var, "Mid-Atlantic") ~ "Mid-Atlantic Bight"),
    driver_area = factor(driver_area, 
      levels = c("All", "Gulf of Maine", "Georges Bank", "Southern New England", "Mid-Atlantic Bight"))) 



# Filter it out so there is only cases where the driver area matches
driver_ccf_prep <- driver_ccf_prep %>% 
  filter(driver_area == spectra_area | driver_area == "All") %>% 
  arrange(year, driver_var)



# Walk through each xvariable, and see how it correlates with each yvar
# split on xvar
# then split on yvars
# make sure order is good
ccf_relationships <- driver_ccf_prep %>% 
  drop_na() %>% 
  split(.$spectra_param) %>% 
    map_dfr(function(x_param){
      x_param %>% 
        split(.$driver_var) %>% 
          map_dfr(function(driver_y_data){
            ccf_df <- get_ccf_vector(
              x = driver_y_data$spectra_values,
              y = driver_y_data$driver_values
            )
          }, .id = "driver_var")
  }, .id = "spectra_param")




# Build back out the labels for plotting
ccf_plot_data <- ccf_relationships %>% 
  mutate(
    # Flag what the driver type was
    driver_type = case_when(
      str_detect(driver_var, "landings") ~ "Commercial Landings",
      str_detect(driver_var, "sst") ~ "SST",
      str_detect(driver_var, "index") ~ "GSI",
      str_detect(driver_var, "small") ~ "ZP-S",
      str_detect(driver_var, "large") ~ "ZP-L",
      TRUE ~ "Missed Something"),
    param_feature = case_when(
      # Flag what the Size Distribution Parameter was
      str_detect(spectra_param, "int") ~ "Spectra Intercept",
      str_detect(spectra_param, "isd") ~ "ISD Exponent",
      str_detect(spectra_param, "slope") ~ "Spectra Slope",
      TRUE ~ "Missed Something"),
    spectra_region = case_when(
      # Flag what region the driver was coming from
      str_detect(spectra_param, "All") ~ "All",
      str_detect(spectra_param, "Georges") ~ "Georges Bank",
      str_detect(spectra_param, "Gulf") ~ "Gulf of Maine",
      str_detect(spectra_param, "Southern") ~ "Southern New England",
      str_detect(spectra_param, "Mid-Atlantic") ~ "Mid-Atlantic Bight"),
    # Flag when it crosses threshold
    sig_flag = ifelse(acf < signeg | acf > sigpos, T, F),
    # Set Factor Levels
    spectra_region = factor(spectra_region, levels = c("All", "Gulf of Maine", "Georges Bank", "Southern New England", "Mid-Atlantic Bight")))


# Limit to one Response:
ccf_plot_data <- filter(ccf_plot_data, param_feature == "ISD Exponent") %>% 
  filter(spectra_region != "All")

# Plot them
ccf_plot_data %>% 
  ggplot(aes(
    x = lag, 
    y = acf, 
    group = driver_var, 
    color = driver_type, 
    fill = driver_type)) +
  geom_col(alpha = 0.65) +
  geom_col(
    data = filter(ccf_plot_data, sig_flag),
    aes(lag, acf, fill = driver_type,  group = driver_var), color = "black") +
  geom_text(
    data = filter(ccf_plot_data, sig_flag),
    aes(lag, y = 0, label = lag, vjust = ifelse(acf < 0, 1.5,-1.5)), color = "black") +
  geom_line(aes(x = lag, y = sigpos), linetype = 2, color = "gray25") +
  geom_line(aes(x = lag, y = signeg), linetype = 2, color = "gray25") +
  geom_hline(yintercept = 0, color = "gray25", linewidth = 1) +
  geom_vline(xintercept = 0, color = "black", linewidth = 1) +
  scale_color_gmri() +
  scale_fill_gmri() +
  facet_grid(spectra_region~driver_type*param_feature) +
  scale_x_continuous(limits = c(-15, 15), breaks = seq(from = -15, to = 12, by = 1)) +
  theme(legend.position = "bottom",
        axis.text = element_text(size = 8)) +
  labs(x = "Driver Lag", y = "Correlation (CCF)", 
       fill = "Driver Type:", color = "Driver Type:",
       caption = "All predictors scaled over year range of 1982-2019. Lags exceeding significance threshold outlined and numbered.")

```

### Slope Changepoint Analyses

Changepoint analysis was used as a means to explore the temporal structure in changes of the regional size spectrum slopes. Changepoint analysis was performed using the envcpt package (@killick et al), testing comparing support for 12 candidate model structures and any identified changepoints. The most supported changepoint structures were then used to inform whether (if any) regional spectra expressed distinct periods of behavior. If changepoints were identified, this was used as evidence that there may have been a community regime change. Following this thinking it is plausible for there to be inconsistencies or non-stationarity in the predictors' impact on the community spectra, as different community regimes may be differently vulnerable to top-down pressures like commercial fishing. To allow for changes in these relationships across different regimes, separated by changepoints, an additional interaction term was added to the regression model candidates for that region. 


### Driver Correlation Periods


```{r}
#| label: driver-correlation-periods

# Pull different years into a list
driver_periods <- list(
  "1982-1998"     = c(1982:1998),
  "1999-2006"     = c(1999:2006),
  "2007-2019"     = c(2007:2019),
  "1982-2019"     = c(1982:2019))


# -------------------------------------------------
# Idea: Add functional_group_sizes into the correlation chart:

# Reshape the size information so we can combine it with the drivers:
# Values are scaled here
sizes_wide <- functional_group_size %>% 
  select(year = Year, 
         survey_area, 
         hare_group, 
         avg_weight = mean_wt_kg) %>% 
  pivot_longer(names_to = "var", 
               values_to = "value", 
               cols = c(avg_weight)) %>% 
  inner_join(area_df, by = "survey_area") %>% 
  select(-survey_area) %>% 
  mutate(id = str_replace_all(str_c(area, "_", hare_group, "_", var), " ", "_")) %>% 
  select(-c(area, area_titles, var, hare_group)) %>% 
  pivot_wider(names_from = id, values_from = value, values_fn = {mean}) %>% 
  column_to_rownames(var = "year") %>% 
  scale() %>% 
  as.data.frame()



# Join regional size changes to the scaled drivers
drivers_and_sizes <- drivers_scaled %>% 
  left_join(rownames_to_column(sizes_wide, var = "year"), by = "year") %>%
  column_to_rownames(var = "year")


# Split them out into a list that contains data for each period
# Takes the years in driver_periods and pulls the rows that correspond
driver_period_list <- map(driver_periods, function(yrs){
  period_matrix <- drivers_and_sizes[rownames(drivers_and_sizes) %in% yrs, ] %>% drop_na()})

```



### Regression Analyses

Following exploratory analyses with CCF functions and changepoint analyses, regression models were developed and tested independently for each region.  Potential drivers included in the models were the annual Gulf Stream Index, the annual regionally averaged SST anomaly value, regionally averaged small and large copepod indices, and the scaled annual commercial landings from that region. Gulf stream index, zooplankton indices, and SST anomalies were not standardized prior to use in model fitting and evaluation as the two former are already an index value and the latter is scaled to a thirty-year climatological reference period. In the event that CCF analysis identified an important time lag for a region’s independent variables, these specific time-lagged predictors were included as predictors in the candidate models, otherwise time-lags on predictors were not evaluated. For any region(s) that showed support for changepoints in their temporal structure, the periods separated by those breaks were included as an interaction term on all other predictors. In the absence of any identified changepoints, no multi-year periods were included as potential regime impacts. All candidate models for a region were evaluated using AIC to determine the most parsimonious models for each regional system. 


```{r}
#| label: regression-analysis-data


# Use scaled drivers for the regressions
# Need to drop zooplankton because they are non-unique since we split the MAB EPU and repeated it
regression_df <- drivers_scaled %>% 
  select(!ends_with(c("zp_small","zp_large")))

# Build back out the metadata:
# Identify what region is associated with both: spectrum values & driver values
regression_df <- regression_df %>% 
  pivot_longer(names_to = "spectra_param", 
               values_to = "spectra_values", 
               cols = ends_with("slope") | ends_with("int")) %>% 
  pivot_longer(names_to = "driver_var", 
               values_to = "driver_values", 
               cols = -matches("spectra|year")) %>% 
  mutate(
    year = as.numeric(year),
    # A. Flag what the driver type was
    driver_type = case_when(
      str_detect(driver_var, "landings") ~ "Commercial Landings",
      str_detect(driver_var, "sst") ~ "SST",
      str_detect(driver_var, "index") ~ "GSI",
      TRUE ~ "Missed Something"),
    # B. Flag what the spectrum feature was
    param_feature = case_when(
      # Flag what the Size Distribution Parameter was
      str_detect(spectra_param, "int") ~ "Spectra Intercept",
      str_detect(spectra_param, "isd") ~ "ISD Exponent",
      str_detect(spectra_param, "slope") ~ "Spectra Slope",
      TRUE ~ "Missed Something"),
    # C. These are the areas associated with the Spectra Features
    spectra_area = case_when(
      str_detect(spectra_param, "All") ~ "All",
      str_detect(spectra_param, "Georges") ~ "Georges Bank",
      str_detect(spectra_param, "Gulf") ~ "Gulf of Maine",
      str_detect(spectra_param, "Southern") ~ "Southern New England",
      str_detect(spectra_param, "Mid-Atlantic") ~ "Mid-Atlantic Bight"),
    spectra_area = factor(spectra_area, levels = c("All", "Gulf of Maine", "Georges Bank", "Southern New England", "Mid-Atlantic Bight")),
    
    # D. These are the areas of the drivers
    driver_area = case_when(
      str_detect(driver_var, "All") ~ "All",
      str_detect(driver_var, "Georges") ~ "Georges Bank",
      str_detect(driver_var, "Gulf") ~ "Gulf of Maine",
      str_detect(driver_var, "Southern") ~ "Southern New England",
      str_detect(driver_var, "Mid-Atlantic") ~ "Mid-Atlantic Bight"),
    driver_area = factor(driver_area, levels = c("All", "Gulf of Maine", "Georges Bank", "Southern New England", "Mid-Atlantic Bight")),
    
    # E. Add Decade in
    decade = floor_decade(year),
    regime = ifelse(year < 2010, "regime_1", "regime_2" )) 


# Filter it so predictors are only within matching regions, 
# or just overarching (GSI)
regression_df <- regression_df %>% 
  filter(driver_area == spectra_area | driver_type == "GSI") %>% 
  arrange(year, driver_var)




# Last wrangling:
# columns for: year, slope, isd, spectra region, drver_region, GSI, sst_anom, landings
# GSI is so annoying here, just rejoin it without the area column
regression_df <- regression_df %>% 
  select(-c(spectra_param, driver_var)) %>% 
  pivot_wider(names_from = "driver_type", values_from = "driver_values") %>% 
  pivot_wider(names_from = "param_feature", values_from = "spectra_values") %>% 
  select(-GSI) %>% 
  filter(driver_area != "All") %>% 
  left_join( select(clim_idx, year, GSI = value), by = c("year") ) %>% 
  mutate(spectra_area = fct_drop(spectra_area))




# Add zooplankton here so it can be checked in the regressions
# Zooplankton values are duplicated in MAB and SNE b/c its the same EPU
regression_df <- left_join(
    regression_df, 
    bind_rows(
      zp_index,
      zp_index %>% 
        filter(survey_area == "Mid-Atlantic Bight") %>% 
        mutate(survey_area = "Southern New England")) %>%                       
  rename(spectra_area = survey_area), 
        by = join_by(year, spectra_area))

```


# Results

### Community Abundance

Stratified abundance estimates have been gradually increasing on the Northeast Shelf since 1970. Abundance growth accelerated after 2007 to peak levels in 2014. Abundance then began declining, which continued through 2019 (Figure 2).  In the Gulf of Maine, fish abundance remained relatively-low until the 1990’s, at which point it began to steadily rise–closely aligning with the pattern for the Northeast Shelf. This increase in abundance reversed briefly during 2002-2006, but continued to rise after 2006 before hitting a regional peak in 2016. Populations then declined through 2019 similar to the shelf-wide trend. Georges Bank abundances were consistently low from 1970 around 2010. By 2014 abundance had roughly quadrupled, propelled by strong recruitment classes of haddock. After 2014, abundance quickly fell to numbers more similar to the 1970-2010 levels by the end of the decade. Community abundance in Southern New England displayed higher inter-annual changes across all years compared to both Gulf of Maine and Georges Bank. Abundance in this area showed a less dramatic rise and fall than the Northern regions.  Abundances began increasing rapidly here in 2007, before falling back to earlier levels by the end of the 2010’s decade. The Mid Atlantic Bight displayed the most inter-annual variability and had no major trends in fish abundance.


```{r}
#| label: abundance distributions
#| fig.width: 8
#| fig-height: 8

# panel plot the biomass by body size
fgroup_area$weight_bins <- fgroup_area$weight_bins %>% 
  mutate(strat_abund_mill = wtbin_strat_abund / 1e6,
         strat_lwbio_mill = wtbin_strat_lw_bio / 1e6,
         survey_area = factor(survey_area,
                              levels = area_levels))




# Just abundance, not by groups
strat_abundance_plot <- fgroup_area$weight_bins %>% 
  filter(survey_area == "Northeast Shelf, Full") %>% 
  group_by(Year, survey_area, hare_group) %>% 
  summarise(abund_millions = sum(strat_abund_mill, na.rm = T),
            .groups = "drop") %>% 
  #filter(survey_area == "GoM") %>% 
  ggplot(aes(Year, abund_millions, fill = hare_group)) +
  #geom_area(color = "gray30", linewidth = 0.1) +
  geom_col(color = "gray30", linewidth = 0.1, position = "stack") +
  scale_fill_gmri() + 
  scale_x_continuous(expand = expansion(add = c(0,0))) +
  scale_y_continuous(labels = comma_format()) +
  facet_wrap(~survey_area, ncol = 1, scales = "free") + 
  labs(y = "Abundance (millions)",  
       x = NULL,
       fill = "Functional Group") +
  theme(legend.position = "bottom")



# Just Biomass, by area and functional group
strat_biomass_plot <- fgroup_area$weight_bins %>% 
  filter(survey_area == "Northeast Shelf, Full") %>% 
  group_by(Year, survey_area, hare_group) %>% 
  summarise(abund_millions = sum(strat_lwbio_mill, na.rm = T),
            .groups = "drop") %>% 
  ggplot(aes(Year, abund_millions, fill = hare_group)) +
  # geom_area(color = "gray30", linewidth = 0.1) +
  geom_col(color = "gray30", linewidth = 0.1, position = "stack") +
  scale_fill_gmri() + 
  scale_x_continuous(expand = expansion(add = c(0,0))) +
  scale_y_continuous(labels = comma_format()) +
  facet_wrap(~survey_area, ncol = 1, scales = "free") + 
  labs(y = "Biomass (million kg)",  
       x = NULL,
       fill = "Functional Group") +
  theme(legend.position = "bottom")


# Biomass and Abundance Together
(strat_abundance_plot / strat_biomass_plot + labs(x = "Year")) + 
  plot_layout(guides = "collect") & 
  theme(legend.position = "bottom")


```

Groundfish species were the dominant functional group driving the abundance and biomass trends in the Gulf of Maine and Georges Bank, with the two southern regions showing a more balanced abundance distribution among the five functional groups (Figure 2). 

```{r}
#| label: abundance-by-group
#| fig.height: 8
#| fig.width: 10
#| eval: false


# Plot abundance by region and Group
fgroup_area$weight_bins %>% 
  filter(survey_area != "Northeast Shelf, Full") %>% 
  ggplot(aes(Year, strat_abund_mill, fill = left_lim)) +
    geom_col(color = "gray30", linewidth = 0.1) +
    facet_grid(survey_area~hare_group) +
    scale_fill_distiller(palette = "RdYlGn", direction = -1, breaks = seq(0,14, 2)) +
    guides(fill = guide_colorsteps(barwidth = unit(3, "in"))) +
    scale_y_continuous(labels = comma_format()) +
    labs(
      y = "Abundance (millions)",  
      x = NULL, 
      fill = "Minimum Individual Weight 2^x (g)") +
    theme(
      legend.position = "bottom",
      axis.text.x = element_text(angle = 45, hjust = 1))

```

### Community Biomass

Similar to abundance, the overall biomass was highest in the two northern regions, the Gulf of Maine and Georges Bank. Roughly half of the biomass sampled in these regions can be attributed to groundfish species, with the second largest contributions coming from elasmobranchs. Within the groundfish biomass, larger individuals \>2kg in particular, declined during the 70's and 80's in these regions, never truly recovering. Beginning in the 2000's there were signs that groundfish abundances were increasing as evidenced by increasing numbers of smaller individuals, however in both regions this trend appears to have reversed by the mid 2010's. Elasmobranch biomass increased steadily throughout the survey time period across all regions, with the exception of southern New England. This area showed large 5-10 year swings in biomass, but no clear long-term trend. Larger elasmobranch were rare in all regions except for a period spanning the late 70's through the early 90's isolated to Georges Bank. Demersal species biomass was highest in the Gulf of Maine, dwarfing their contributions in other regions. Their biomass declined in the 70's, was flat until the late 90's, remaining relatively high until declining in the late 2010's. Pelagic species biomass was low in all regions, and is unlikely to be representative of true biomass trends due to gear selectivity.

```{r}
#| label: bodymass distributions
#| fig.width: 10
#| fig-height: 8

# panel plot the biomass by body size
fgroup_area$weight_bins %>% 
  complete(Year, hare_group, survey_area, left_lim) %>% 
  filter(survey_area != "Northeast Shelf, Full") %>% 
  ggplot(aes(Year, strat_abund_mill, fill = left_lim)) +
    geom_col(color = "gray30", linewidth = 0.1) +
    facet_grid(survey_area~hare_group) +
    scale_fill_distiller(palette = "RdYlGn", direction = -1, breaks = seq(0,14, 2)) +
    guides(fill = guide_colorsteps(barwidth = unit(3, "in"))) +
    scale_y_continuous(labels = comma_format()) +
    labs(y = "Biomass (million kg)",  
         x = "", 
         fill = "Minimum Individual Weight 2^x (g)") +
    theme(legend.position = "bottom",
          axis.text.x = element_text(angle = 45, hjust = 1))


```

### Regional Variation in Species Composition

There was a distinct difference between Northern and Southern regions in the way biomass was distributed among the different functional groups. The largest contributors to biomass in the southern regions (southern New England & mid-Atlantic bight) was the elasmobranch community. While the northern regions (Gulf of Maine & Georges Bank) each had similar quantities of elasmobranch biomasses, there was also a comparable contribution of groundfish and in the Gulf of Maine there was a major component of demersal species as well.

### Body Size Trends

The average fish size in the Gulf of Maine (length and weight) declined the greatest of all regions over our study period. The average individual length was greatest in the 1970's in the 35-40cm range, falling to 28-33cm over the last decade. Body-weight fell dramatically in the 1980's, from around .75kg in the 1970's to .25-.30kg, roughly a third of what it had been. Georges Bank body sizes also declined during the study period, but less dramatically. Both of these Northern regions had brief period in the late 2000's where average length and weight rose, before falling again in the 2010's. The MAB region was the only region to see a long-term increase in both length and weight during the study period. SNE saw no long-term change in length, and a minor decline in average body-weight.

::: panel-tabset
#### All Species

```{r}
#| label: regional-size-trends
#| fig.height: 8
#| fig.weight: 8

# Re-factor
regional_size <- regional_size %>% 
  filter(Year < 2020) %>% 
  mutate(
    survey_area = factor(survey_area, area_levels),
    area_copy = survey_area)


# Length plot
avg_len_p <-  regional_size %>% 
    ggplot(aes(Year, mean_len_cm)) +
    geom_line(data = dplyr::select(regional_size, -area_titles),
              aes(group = area_copy),
              alpha = 0.2, linewidth = 0.5) + 
    geom_line(aes(group = area_titles), 
              linewidth = 1,
              show.legend = F) + 
    scale_color_gmri() +
    facet_wrap(~area_titles, ncol = 1) + 
    labs(title = "Average Length",
         y = "Length (cm)",
         color = "Region")


# Weight plot
avg_wt_p <- regional_size %>% 
  ggplot(aes(Year, mean_wt_kg)) + 
  geom_line(data = dplyr::select(regional_size, -area_titles),
            aes(group = area_copy),
            alpha = 0.2, linewidth = 0.5) + 
  geom_line(aes(group = area_titles), 
            linewidth = 1,
              show.legend = F) + 
  scale_color_gmri() +
  facet_wrap(~area_titles, ncol = 1) + 
  labs(title = "Average Weight",
       y = "Weight (kg)",
       color = "Region")
  
# Plot side by side
(avg_len_p | avg_wt_p) 

```

#### Functional Group Avg. Length

```{r}
#| label: functional-group-length-trends
#| fig.width: 8
#| fig-height: 8





# Plot the different trends in length
functional_group_size %>% 
  ggplot(aes(Year, mean_len_cm)) +
  geom_line(aes(group = area_titles#,
                  #color = area_copy
                  ), 
              linewidth = 1,
              show.legend = F) + 
    geom_smooth(color = "orange", method = "loess", linewidth = 1) +
    facet_grid(hare_group~area_titles, scales = "free_y") + 
    theme(axis.text = element_text(size = 8)) +
    labs(title = "Average Length",
         y = "Length (cm)",
         color = "Region")


```

#### Functional Group Avg. Weight

```{r}
#| label: functional-group-weight-trends
#| fig.width: 8
#| fig-height: 8


# Average individual weight
functional_group_size %>% 
  ggplot(aes(Year, mean_wt_kg)) +
  geom_line(aes(group = area_titles), 
              linewidth = 1,
              show.legend = F) + 
    geom_smooth(color = "orange", method = "loess", linewidth = 1) +
    facet_grid(hare_group~area_titles, scales = "free_y") + 
    theme(axis.text = element_text(size = 8)) +
    labs(title = "Average Weight",
         y = "Weight (kg)",
         color = "Region")

```
:::

### Regional Size Spectra

At the start of our time series, back in the 1970's, there was a clear difference in the relative positions of spectra parameters among the different regions. Gulf of Maine and Georges Bank showed the least steep spectra slopes in the earlier time periods with slopes around -1 & -1.1 respectively. The relatively flat slopes in these regions both steepened over time, settling near -1.3 (GoM) and -1.5 (GB). Gulf of Maine experienced much of its decline during the 1980's and 1990's. There was a brief reversal in this trend during the 2000's, but slopes continued to steepen by 2010 and remained steep through 2019. Georges Bank did not experience as rapid of a decline, but experienced a similar long-term steepening. In contrast to the northern regions, SNE and MAB had steeper slopes in the -1.2 to -1.5 territory. The long term pattern for SNE was one of increasing volatility, but not so much a decline. The spectra slope for the MAB was less volatile, but similarly maintained a relatively stable wander around -1.4. By the end of the study period all regions had slopes that were at or near a similar level.

```{r}
#| label: size spectra results


# Plot the Regional Slopes
slope_timeline <- region_indices %>% 
  ggplot(aes(yr, log2_slope_strat, group = area_titles)) +
  geom_line(data = select(region_indices, -area_titles),
            aes(group = area_copy),
            alpha = 0.2, linewidth = 0.5) +
  geom_line(aes(group = area_titles), linewidth = 1) +
  scale_color_gmri() +
  facet_wrap(~area_titles, ncol = 1)  +
  labs(x = "Year", y = "Normalized Abundance Spectrum Slope") 




# Exponent of ISD
isd_timeline <- region_indices %>% 
  ggplot(aes(yr, b, group = area_titles)) +
  geom_line(data = select(region_indices, -area_titles),
            aes(group = area_copy),
            alpha = 0.2, linewidth = 0.5) +
  geom_line(aes(group = area_titles), linewidth = 1) +
  #geom_pointrange(aes(group = area_titles, ymin = confMin, ymax = confMax), size = 0.1) +
  scale_color_gmri() +
  facet_wrap(~area_titles, ncol = 1) +
  labs(x = "Year", y = "Abundance Size Spectrum Slope (b)")
```


```{r}
#| label: weisberg-synthesis
#| eval: false


# Stuff for Sara:


# 1. Plot of Gulf of Maine Slopes, no gray lines
sara_plot <- region_indices %>% 
  filter(survey_area == "GoM") %>% 
  ggplot(aes(yr, b, group = area_titles)) +
  # geom_line(aes(group = area_titles), linewidth = 1) +
  geom_point(size = 1) +
  geom_smooth(method = 'loess', formula = 'y ~ x', color = "orange") +
  #geom_pointrange(aes(group = area_titles, ymin = confMin, ymax = confMax), size = 0.25) +
  scale_color_gmri() +
  facet_wrap(~area_titles, ncol = 1) +
  labs(x = "Year", y = "Abundance Size Spectrum Slope (b)", title = "Exponent of Abundance Size Spectra")

# The decline in weight of groundfish to go with:
# Average individual weight
functional_group_size %>% 
  filter(survey_area == "GoM", hare_group %in% c("groundfish", "elasmobranch")) %>% 
  ggplot(aes(Year, mean_wt_kg)) +
  geom_point(size = 1) + 
    geom_smooth(color = "orange", method = "loess", linewidth = 1) +
    facet_grid(hare_group~area_titles, scales = "free_y") + 
    theme(axis.text = element_text(size = 8)) +
    labs(title = "Average Weight",
         y = "Weight (kg)",
         color = "Region")

# How much biomass is just gf and elsmo:

# Plot abundance by region and Group
fgroup_area$weight_bins %>% 
  filter(survey_area == "GoM") %>% 
  ggplot(aes(Year, strat_lwbio_mill, fill = hare_group)) +
    geom_col(color = "gray30", linewidth = 0.1, position = "fill") +
    facet_grid(.~survey_area) +
    scale_fill_gmri() +
    scale_y_continuous(labels = percent_format()) +
    labs(
      y = "Fraction of Biomass",  
      x = NULL, 
      fill = "Functional Group") +
    theme(
      legend.position = "bottom",
      axis.text.x = element_text(angle = 45, hjust = 1))


# Table of averages over different periods for all of them:
region_indices %>%
  filter(yr %in% c(1970:2000)) %>%
  mutate(year_range = "1970-2000") %>%
  group_by(year_range, area_titles) %>%
  summarise(
    avg_slope = mean(b, na.rm = T),
    sd_slope = sd(b, na.rm = T)
  )

```

::: panel-tabset
#### Exponent of Size Spectra

```{r}
#| fig.height: 8
#| fig.weight: 8

isd_timeline + geom_smooth(color = "orange", se = FALSE)
```

#### Binned Size Spectra

```{r}
#| fig.height: 8
#| fig.weight: 8

slope_timeline + geom_smooth(color = "orange", se = FALSE)
```

#### Contrast

```{r}
#| fig.height: 8
#| fig.weight: 8

# Assemble the figure
slope_timeline +
  scale_y_continuous(limits = c(-1.35, -0.3))  | isd_timeline +
  scale_y_continuous(limits = c(-1.35, -0.3)) 


```

#### Method Correlation

```{r}
#| fig.height: 8
#| fig.weight: 8


region_indices %>% 
  ggplot(aes(log2_slope_strat, b)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y~x, color = "orange") +
  facet_wrap(~area_titles, ncol = 1) +
  labs(x = "Normalized Abundance Spectra Slope", y = "Individual Size Distribution Exponent (b)", title = "Between Methods Correlation")
```
:::

## Size Spectra Drivers

## Spectra Slope changepoints and Regression Analysis

Following break point exploratory analyses with the EnvCpt package, the Gulf of Maine was the only region from which changepoints were identified in the best supported model from the candidaate changepoint model structures. Changes in Gulf of Maine's spectrum slope was best modeled by a model allowing breaks in the trend, and with an auto-regressive process on the previous 2 years. From this model, breaks were identified at 1999 and 2007. Georges Bank was best modeled with a single trend, with no changepoints. Southern New-England showed the most support for a single intercept model, with no changepoints, with values centered on mu = -1.04 & sd = 0.046. The Mid-Atlantic Bight was best supported by a single trend model, with no changepoints, and an increasing intercept through the study period.

```{r}

# Pull Regions to test independently:
gom_df <- filter(regression_df, spectra_area == "Gulf of Maine") 
gb_df <- filter(regression_df, spectra_area == "Georges Bank") %>% drop_na()
sne_df <- filter(regression_df, spectra_area == "Southern New England") 
mab_df <- filter(regression_df, spectra_area == "Mid-Atlantic Bight") %>% drop_na()


# Check each for different changepoint structures
gom_cpt <- envcpt(gom_df$`ISD Exponent`, verbose = F)
gb_cpt  <- envcpt(gb_df$`ISD Exponent`, verbose = F)
sne_cpt <- envcpt(sne_df$`ISD Exponent`, verbose = F)
mab_cpt <- envcpt(mab_df$`ISD Exponent`, verbose = F)


# Pulling out details of best supported model
cpt_res <- list(
  "gom" =  list("cpt_res" = gom_cpt),
  "gb"  =  list("cpt_res" = gb_cpt),
  "sne" =  list("cpt_res" = sne_cpt),
  "mab" =  list("cpt_res" = mab_cpt)) %>% map(function(x){
    best <- names(which.min(AIC(x$cpt_res)))
    best_summ <- x$cpt_res[[best]]
    x$best <- best
    x$best_summ <- best_summ
    return(x)
})


# Plot GOM, the only one with changepoints
plot(gom_cpt, main = "Gulf of Maine, Break Point Analysis")



# Put the rest of the results into a delta AIC table:
bind_rows(map(cpt_res, ~tibble("Most Supported Model" = .x[["best"]])), .id = "Region") %>% kable()


```



### Driver Differences Across Regimes

changepoint analyses suggest there were as many as 3 distinct regimes in the Gulf of Maine slope changes. For all other regions there was not strong support for changepoints.

```{r}
#| label: period-correlations-processing

# Run Correlations for Each period and for the entire period
driver_period_correlations <- map(driver_period_list, function(drivers){
  
  #------ debug copy-paste line
  # Step 1. Get the correlation matrix (data is pre-scaled)
  corr_matrix <- rcorr(as.matrix(drivers))
  
  # R-squares
  rho_df <- as.data.frame(corr_matrix$r) %>%
    rownames_to_column(var = "var1") %>%
    pivot_longer(cols = -var1, 
                 names_to = "var2", 
                 values_to = "r2")

  # Significance Dataframe
  sig_df <- as.data.frame(corr_matrix$P) %>%
    rownames_to_column(var = "var1") %>%
    pivot_longer(cols = -var1, 
                 names_to = "var2", 
                 values_to = "pval")
  
  # Join
  corr_both <- left_join(rho_df, sig_df, by = c("var1", "var2")) 


  # Step 2. Tidy Up for ggplot
  # Make correlation matrix & significance a dataframe for GGplot
  # Goal: Flag the different Functional Group size changes somehow
  
  
  # Mega Cleanup Code Chunk
  # This first step adds metadata, but mostly creates a way to filter out correlations to be in the direction we want. no sst as response variables for example
  # GOAL: All the drivers in one column, and all the responses in another, order doesn't matter
  corr_tidy <- corr_both %>% 
    mutate(
    
    # 1.These flag whether or not the matrix variables in each column are the independent or dependent variables
    is_var1_driver   = ifelse(str_detect(var1, "landings|index|anom|avg|zp"), T, F),
    is_var2_response = ifelse(str_detect(var2, "slope|int"), T, F),
    
    # 2. Column to Flag what type of driver it is:
    driver_type = case_when(
        str_detect(var1, "landings")       ~ "Top-Down",
        str_detect(var1, "stream|anom|zp") ~ "Bottom-Up",
        str_detect(var1, "length")         ~ "Avg. Length",
        str_detect(var1, "weight")         ~ "Avg. Weight"),
    
    # 3. Column to Flag what area the driver data is from
    driver_area = case_when(
        str_detect(var1, "All")          ~ "Northeast Shelf, Full",
        str_detect(var1, "Georges")      ~ "Georges Bank",
        str_detect(var1, "Gulf")         ~ "Gulf of Maine",
        str_detect(var1, "Southern")     ~ "Southern New England",
        str_detect(var1, "Mid-Atlantic") ~ "Mid-Atlantic Bight"),
    
    # 4. Set Factor Levels for plot
      driver_area = factor(
        driver_area, 
        levels = c(
          "All", 
          "Gulf of Maine", 
          "Georges Bank", 
          "Southern New England", 
          "Mid-Atlantic Bight")),
      
    
    # 5. Shorthand Names for the Spectra Parameters - Response
    response_short = case_when(
      str_detect(var2, "int")   ~ "Spectra Intercept",
      str_detect(var2, "isd")   ~ "ISD Exponent",
      str_detect(var2, "slope") ~ "Spectra Slope"),
    
    
    # 6. These are the areas of the drivers
    response_area = case_when(
      str_detect(var2, "All")          ~ "All",
      str_detect(var2, "Georges")      ~ "Georges Bank",
      str_detect(var2, "Gulf")         ~ "Gulf of Maine",
      str_detect(var2, "Southern")     ~ "Southern New England",
      str_detect(var2, "Mid-Atlantic") ~ "Mid-Atlantic Bight"),
    
    
    # 7. Set levels for the driver areas
    response_area = factor(
      response_area, 
      levels = c(
        "All", 
        "Gulf of Maine", 
        "Georges Bank", 
        "Southern New England", 
        "Mid-Atlantic Bight")),
    
    # 8. Flag when the areas are the same or not:
    area_match = driver_area == response_area
  )
  

# Now we filter rows out to focus in on:
# 1. one direction driver & response
# 2. response and driver in same area, unless its GSI
corr_tidy_pairs <- corr_tidy %>% 
  filter( 
      is_var2_response,
      is_var1_driver,
      area_match | str_detect(var1, "index")) 
  
  
# From here it is just text formatting for plots:
# Because we are faceting we can have repeated names to simplify things
corr_tidy_pairs <- corr_tidy_pairs %>% 
  mutate(
      var1 = ifelse(str_detect(var1, "landings"), "Commercial_Landings", var1),
      var1 = ifelse(str_detect(var1, "sst"), "SST_Anomalies", var1),
      var1 = ifelse(str_detect(var1, "gulf_stream_index"), "Gulf Stream Index", var1),
      var1 = ifelse(str_detect(var1, "zp_small"), "Small Zooplankton", var1),
      var1 = ifelse(str_detect(var1, "zp_large"), "Large Zooplankton", var1),
      var1 = str_replace_all(var1, "_", " "),
      
      # Make a functional group column
      hare_group = case_when(
        str_detect(var1, "elasmobranch") ~ "Elasmobranch",
        str_detect(var1, "pelagic")      ~ "Pelagic",
        str_detect(var1, "coastal")      ~ "Coastal",
        str_detect(var1, "diadromous")   ~ "Diadromous",
        str_detect(var1, "groundfish")   ~ "Groundfish",
        str_detect(var1, "reef")         ~ "Reef",
        TRUE ~ ""),
      
      # Add the functional group column ahead of the average length and weight columns
      var1 = ifelse(str_detect(var1, "avg"), hare_group, var1),
      
      # Set The Factor Levels groups
      var1 = factor(
        var1,
        levels = c(
          "Gulf Stream Index",
          "SST Anomalies",
          "Small Zooplankton",
          "Large Zooplankton",
          "Groundfish",
          "Elasmobranch",
          "Coastal",
          "Diadromous",
          "Pelagic",
          "Reef",
          "Commercial Landings")),
      
      # Flag Significance Levels
      signif = ifelse(pval < 0.05, "*", ""))

  return(corr_tidy_pairs)
  
  #------- 

  
  
  
})

```

::: panel-tabset
#### All Years

```{r}
#| label: correlations-all
#| fig-height: 6
#| fig-width: 8

period <- "1982-2019"
plot_period_correlations(driver_period_correlations[[period]], period)
```

#### 1982-1998

```{r}
#| label: correlations-80s
#| fig-height: 6
#| fig-width: 8

period <- "1982-1998"
plot_period_correlations(driver_period_correlations[[period]], period)
```

#### 1999-2006

```{r}
#| label: correlations-90s
#| fig-height: 6
#| fig-width: 8

period <- "1999-2006"
plot_period_correlations(driver_period_correlations[[period]], period)
```

#### 2007-2019

```{r}
#| label: correlations-20s
#| fig-height: 6
#| fig-width: 8

period <- "2007-2019"
plot_period_correlations(driver_period_correlations[[period]], period)
```

:::







## Spectra Slope Regression Analysis

::: panel-tabset

### Gulf of Maine

```{r}

# change na. action for dredge
options(na.action = "na.fail")


# Incorporate the patterns from the changepoint analysis
# What if we enforce the break_periods
gom_df <- mutate(gom_df, 
  regime_shifts = case_when(
    year < 1999 ~ "regime_1",
    year < 2007 ~ "regime_2",
    year >= 2007 ~ "regime_3"
  ))




# fit model with all parameters
all_parms <- lm(`ISD Exponent` ~ 
                  SST + GSI + `Commercial Landings` + 
                  zp_small + zp_large + regime_shifts, 
                data = gom_df)

# # Refine the dredge
results <- dredge(all_parms,# subset= !(regime && decade), 
                  m.lim = c(1,4), fixed = c("(Intercept)"))
# subset(results, delta == 0)

# The "best" model, without interactions
bmod <- lm(`ISD Exponent` ~ `Commercial Landings` + zp_small, data = gom_df)

# Looked okay

#-----------------

# Allowing Interactions with the changepoint periods found from changepoint analysis:

# Do the interactions:
regime_lm <- lm(`ISD Exponent` ~ 
                  regime_shifts * SST + 
                  regime_shifts * GSI + 
                  regime_shifts * `Commercial Landings` + 
                  regime_shifts * zp_small + 
                  regime_shifts * zp_large,
                data = gom_df)

# Do some dredging:
results_shifts <- dredge(regime_lm)
# subset(results_shifts, delta == 0)


#new_bmod
new_bmod <- lm(`ISD Exponent` ~ regime_shifts * `Commercial Landings`, data = gom_df)

# Looks worse


#---------  Add Autoregressive Patterns



# This is how I could recode the autoregressive predictors neatly
gom_df_lag <- mutate(gom_df, 
                 b = `ISD Exponent`,
                 blag1 = dplyr::lag(b, 1),
                 blag2 = dplyr::lag(b, 2),
                 zpslag1 = dplyr::lag(zp_small, 1),
                 zpslag2 = dplyr::lag(zp_small, 2)
                 ) %>% 
  drop_na(blag2)


# kitchen sink Autoregressive model
gom_ar_models = lm(b ~ 
                   regime_shifts * SST + 
                   regime_shifts * GSI + 
                   regime_shifts * `Commercial Landings` + 
                   regime_shifts * zp_small + 
                   regime_shifts * zp_large + 
                   # zpslag1 + zpslag2 +
                   blag1 + blag2, 
                   data = gom_df_lag)




# Model selection on models with lags at 1+2 years
results_ar <- dredge(gom_ar_models)
# subset(results_ar, delta == 0)

# Best autoregressive model
best_ar <- lm(b ~ `Commercial Landings` * regime_shifts + blag2 + zp_large * regime_shifts + zp_small, data = gom_df_lag)



# # Yea, better AIC somehow
# AIC(new_bmod); AIC(bmod); AIC(best_ar)
```



::: panel-tabset

#### Model Summary

```{r}
# output summary - broom.helpers and gtsummary

# Best Model
tbl1 <- best_ar %>% 
  tbl_regression() %>% 
  add_glance_table() %>% 
  bold_labels()

tbl1

```

#### VIF

```{r}
# make a model with all of them
all_parms <- lm(`ISD Exponent` ~ 
                  regime_shifts * SST + 
                  regime_shifts * GSI + 
                  regime_shifts * `Commercial Landings` + 
                  regime_shifts * zp_small + 
                  regime_shifts * zp_large, data = gom_df)

# Check VIF
vif(all_parms) %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "Predictor") %>% 
  # rename(VIF = ".") %>% 
  # arrange(VIF) %>% 
  gt() 

```

#### Actual vs. Fitted

```{r}
augment(best_ar, gom_df_lag ) %>% 
  ggplot(aes(year)) +
  geom_line(aes(y = `ISD Exponent`, color = "Actual"), linewidth = 1) +
  geom_line(aes(y = .fitted, color = "Predicted"), linewidth = 1) +
  scale_color_gmri() +
  labs(color = "Color", y = "Spectrum Slope")
```


#### Residual Autocorrelation

```{r}
augment(best_ar, gom_df_lag ) %>% 
  ggplot(aes(year, y = .resid)) +
  geom_line(linewidth = 1, color = "gray30") +
  geom_point(size = 2, color = "gray30") +
  geom_hline(yintercept = 0, linetype = 2, color = "darkred", linewidth = 1) +
  scale_color_gmri() +
  labs(color = "Color", y = "Model Residuals")
```
:::


### Georges Bank

Exploratory analyses for Georges Bank indicated that the structure of the data did not show support for clear changepoints. CCF results of individual predictors showed that spectrum slope was correlated with small zooplankton index values from two years prior. This relationship was added to the standard predictor candidates, each operating at a simultaneous timestep.

```{r}

# Georges Bank showed
gb_df_lag <- gb_df %>% 
  mutate(
    b = `ISD Exponent`,
    blag1 = dplyr::lag(b, 1),
    blag2 = dplyr::lag(b, 2),
    zpslag1 = dplyr::lag(zp_small, 1),
    zpslag2 = dplyr::lag(zp_small, 2)) %>% 
  drop_na(blag2)



# fit model with all parameters
all_parms <- lm(b ~ 
                  SST + 
                  GSI + 
                  `Commercial Landings` + 
                  zp_small + 
                  zp_large + 
                  zpslag1 + 
                  zpslag2, 
                data = gb_df_lag)

# Refine the dredge
results <- dredge(all_parms, #subset= !(regime && decade), 
                  m.lim = c(1,3), 
                  fixed = c("(Intercept)"))

#grab best model
# subset(results, delta == 0)
bmod <- lm(`ISD Exponent` ~ SST + zpslag2, data = gb_df_lag)

```

::: panel-tabset

#### Model Summary

```{r}
# output summary - brrom.helpers and gtsummary

# Best Model
tbl1 <- bmod %>% 
  tbl_regression() %>% 
  add_glance_table() %>% 
  bold_labels()

tbl1

```

#### VIF

```{r}
all_parms <- lm(b ~ 
                  SST + 
                  GSI + 
                  `Commercial Landings` + 
                  zp_small + 
                  zp_large + 
                  zpslag1 + 
                  zpslag2, 
                data = gb_df_lag)

vif(all_parms) %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "Predictor") %>% 
  rename(VIF = ".") %>% 
  arrange(VIF) %>% 
  gt() 

```

#### Actual vs. Fitted

```{r}
augment(bmod, gb_df_lag) %>% 
  ggplot(aes(year)) +
  geom_line(aes(y = `ISD Exponent`, color = "Actual"), linewidth = 1) +
  geom_line(aes(y = .fitted, color = "Predicted"), linewidth = 1) +
  scale_color_gmri() +
  labs(color = "Color", y = "Spectrum Slope")
```

#### Residual Autocorrelation

```{r}
augment(bmod, gb_df_lag) %>% 
  ggplot(aes(year, y = .resid)) +
  geom_line(linewidth = 1, color = "gray30") +
  geom_point(size = 2, color = "gray30") +
  geom_hline(yintercept = 0, linetype = 2, color = "darkred", linewidth = 1) +
  scale_color_gmri() +
  labs(color = "Color", y = "Model Residuals")
```
:::



### Southern New England

```{r}

# fit model with all parameters
all_parms <- lm(`ISD Exponent` ~ SST + GSI + `Commercial Landings` + zp_small + zp_large, data = sne_df)

# Refine the dredge
results <- dredge(all_parms, #subset= !(regime && decade), 
                  m.lim = c(1,3), 
                  fixed = c("(Intercept)"))

#grab best model
# subset(results, delta == 0)
bmod <- lm(`ISD Exponent` ~ `Commercial Landings`, data = sne_df)

```

::: panel-tabset
#### Model Summary

```{r}
# output summary - brrom.helpers and gtsummary

# Best Model
tbl1 <- bmod %>% 
  tbl_regression() %>% 
  add_glance_table() %>% 
  bold_labels()

tbl1

```

#### VIF

```{r}
all_parms <- lm(`ISD Exponent` ~ 
                  SST + 
                  GSI + 
                  `Commercial Landings` + 
                  zp_small + 
                  zp_large, 
                data = sne_df)


vif(all_parms) %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "Predictor") %>% 
  rename(VIF = ".") %>% 
  arrange(VIF) %>% 
  arrange(VIF) %>% 
  gt() 

```

#### Actual vs. Fitted

```{r}
augment(bmod, sne_df ) %>% 
  ggplot(aes(year)) +
  geom_line(aes(y = `ISD Exponent`, color = "Actual"), linewidth = 1) +
  geom_line(aes(y = .fitted, color = "Predicted"), linewidth = 1) +
  scale_color_gmri() +
  labs(color = "Color", y = "Spectrum Slope")
```

#### Residual Autocorrelation

```{r}
augment(bmod, sne_df ) %>% 
  ggplot(aes(year, y = .resid)) +
  geom_line(linewidth = 1, color = "gray30") +
  geom_point(size = 2, color = "gray30") +
  geom_hline(yintercept = 0, linetype = 2, color = "darkred", linewidth = 1) +
  scale_color_gmri() +
  labs(color = "Color", y = "Model Residuals")
```
:::



### Mid-Atlantic Bight

```{r}

# fit model with all parameters
all_parms <- lm(`ISD Exponent` ~ SST + GSI + `Commercial Landings` + zp_small + zp_large + regime, data = mab_df)

# Refine the dredge
results <- dredge(all_parms, #subset= !(regime && decade), 
                  m.lim = c(1,3), 
                  fixed = c("(Intercept)"))

#grab best model
# subset(results, delta == 0)
bmod <- lm(`ISD Exponent` ~ zp_small + regime, data = mab_df)

```

::: panel-tabset
#### Model Summary

```{r}
# output summary - brrom.helpers and gtsummary

# Best Model
tbl1 <- bmod %>% 
  tbl_regression() %>% 
  add_glance_table() %>% 
  bold_labels()

tbl1

```

#### VIF

```{r}
all_parms <- lm(`ISD Exponent` ~ SST + GSI + `Commercial Landings` + zp_small + zp_large + regime, 
                data = mab_df)

vif(all_parms) %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "Predictor") %>% 
  rename(VIF = ".") %>% 
  arrange(VIF) %>% 
  gt() 

```

#### Actual vs. Fitted

```{r}
augment(bmod, mab_df ) %>% 
  ggplot(aes(year)) +
  geom_line(aes(y = `ISD Exponent`, color = "Actual"), linewidth = 1) +
  geom_line(aes(y = .fitted, color = "Predicted"), linewidth = 1) +
  scale_color_gmri() +
  labs(color = "Color", y = "Spectrum Slope")
```

#### Residual Autocorrelation

```{r}
augment(bmod, mab_df ) %>% 
  ggplot(aes(year, y = .resid)) +
  geom_line(linewidth = 1, color = "gray30") +
  geom_point(size = 2, color = "gray30") +
  geom_hline(yintercept = 0, linetype = 2, color = "darkred", linewidth = 1) +
  scale_color_gmri() +
  labs(color = "Color", y = "Model Residuals") 
```

:::
:::


## Slope Model Summaries

# WORKING HERE

Need to Organize the model predictions into a panel plot
Need some organized summary table of the models that were selected, and their summary information


Exploring the same model evaluation steps with AIC gives these important predictors in each area: 
\* Gulf of Maine: Landings & Decades.\
\* Georges Bank: GSI & Regime.\
\* Southern New England: SST & Decades.\
\* Mid-Atlantic Bight: Decades.



### Potential Drivers Timeseries:

The following panels show the historical changes in each of the drivers. Landings have been scaled by average total landings within each region across all years. SST and GSI have not been scaled. This is different from how they are implemented in the regression analyses, when the landings were scaled over the 1982-2019 period.

::: panel-tabset
#### Surface Temperature Anomalies

```{r}
#| label: temperature-index
#| fig.height: 8


# Plot the timelines
temp_regimes %>% 
  mutate(anom_direction = ifelse(sst_anom > 0, "Positive", "Negative")) %>% 
  ggplot( aes(yr, sst_anom)) +
  geom_col(aes(fill = anom_direction),  
           linewidth = 0.75, alpha = 0.8) +
  geom_hline(yintercept = 0, linewidth = 0.5, lty = 1) +
  scale_x_continuous(expand = expansion(add = c(0.25,0.25))) +
  scale_y_continuous(labels = number_format(suffix = " \u00b0C")) +
  scale_fill_gmri() +  
  facet_wrap(~survey_area, ncol = 1) +
  theme(
    legend.title = element_blank(),
    legend.background = element_rect(fill = "transparent"),
    legend.key = element_rect(fill = "transparent", color = "transparent")) + 
  labs(
    title = "NW-Atlantic Regional SST Anomalies",
    x = "", 
    y = "Surface Temperature Anomaly",
    caption = "Anomalies calculated using 1982-2011 reference period.") +
  guides(fill = "none",
         label = "none",
         color = guide_legend(keyheight = unit(0.5, "cm")))
```

#### GARFO Landings

```{r}
#| label: landings-index
#| fig.height: 8

####  Landings  ####
landings_summ %>% 
  mutate(anom_direction = ifelse(total_wt_z > 0, "Positive", "Negative")) %>% 
  ggplot(aes(year, total_wt_z, group = survey_area)) +
  geom_col(aes(fill = anom_direction),  
           linewidth = 0.75, alpha = 0.8) +
  geom_hline(yintercept = 0, linewidth = 0.5, lty = 1) +
  scale_fill_gmri() +  
  facet_wrap(~survey_area, ncol = 1) +
  scale_x_continuous(breaks = seq(1950, 2030, by = 10)) +
  labs(x = "Year", y = "Finfish Landings Index (z)",
       title = "GARFO Finfish Landings")  +
  guides(fill = "none")
```

#### Climate Modes

```{r}
#| label: climate-modes

####  Climate Drivers  ####
clim_drivers %>% 
  group_by(year = lubridate::year(Time), Var, EPU) %>% 
  summarise(Value = mean(Value, na.rm = T)) %>% 
  mutate(anom_direction = ifelse(Value > 0, "Positive", "Negative"),
         Var = str_to_title(Var)) %>% 
  ggplot(aes(year, Value, group = EPU)) +
  geom_col(aes(fill = anom_direction),  
           linewidth = 0.75, alpha = 0.8) +
  geom_hline(yintercept = 0, linewidth = 0.5, lty = 1) +
  scale_fill_gmri() +  
  facet_wrap(~Var, ncol = 1) +
  scale_y_continuous(labels = scales::comma_format()) +
  scale_x_continuous(limits = c(1960, 2020), 
                     breaks = seq(1950, 2030, by = 10)) +
  labs(x = "Year", y = "Index",
       title = "Environmental Drivers") +
  guides(fill = "none")
```

###

:::

# Supplemental Materials

::: panel-tabset
## Species Functional Groups

```{r}
#| label: tbl-functional-groups
#| tbl-cap: "Common and scientific names for the species that constitute each functional group used in our analyses. X markers are used to indicate which regions each species has been caught in the data."


# Tidy up a key of what is labeled what
spec_key <- catch_size_bins %>% 
  distinct(comname, scientific_name, hare_group) %>% 
  mutate(
    hare_group = ifelse(hare_group %in% c("elasmobranch", "groundfish"), hare_group, str_c(hare_group)),
    hare_group = ifelse(is.na(hare_group), "Not Classified", hare_group),
    hare_group = str_to_title(hare_group),
    hare_group = fct_drop(hare_group),
    hare_group = factor(hare_group, levels = c("Coastal", "Diadromous", "Elasmobranch", "Groundfish",  "Pelagic", "Reef", "Not Classified"))) %>% 
  group_by(hare_group) %>% 
  mutate(n = str_c("(",n(),")")) %>% 
  ungroup()


# Reformat the data to check presence absence
catch_size_bins %>% 
  distinct(comname, survey_area) %>% 
  mutate(Presence = "X") %>% 
  complete(comname, survey_area) %>% 
  left_join(spec_key, by = "comname") %>% 
  mutate(comname = str_to_title(comname),
         Presence = ifelse(is.na(Presence) == FALSE, "X", ""),
         Presence = ifelse(is.na(Presence) == TRUE, "", Presence)) %>% 
  left_join(area_df, by = "survey_area") %>% 
  select(hare_group, n, comname, scientific_name, area, Presence) %>% 
  pivot_wider(names_from = area, values_from = Presence) %>% 
  arrange(hare_group, comname) %>% 
  group_by(hare_group,n) %>% 
  gt()  %>% 
  gt::tab_header(title = md("**Functional Group Assignments and Regional Presence/Absence**")) %>% 
  tab_stubhead(label = md("**Functional Group**")) %>% 
  cols_label(
    comname = md("*Common Name*"),
    scientific_name = md("*Scientific Name*"),
    `Gulf of Maine` = md("*Gulf of Maine*"),
    `Georges Bank` = md("*Georges Bank*"),
    `Southern New England` = md("*Southern New England*"),
    `Mid-Atlantic Bight` = md("*Mid-Atlantic Bight*")
    ) %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_row_groups()) %>% 
  gt::tab_source_note(source_note = md("*Functional group assignments adapted from Hare et al. 2010*"))

```

## GARFO Landings Summary

```{r}
#| label: garfo-landings-summary

# Add the labels into the landings data and remove what we don't need there:
landings %>% 
  filter(between(year, 1960, 2019),
         !str_detect(sppname, "CONFIDENTIAL")) %>% 
  mutate(
    decade = floor_decade(year),
    sppname = str_to_title(sppname)) %>% 
  group_by(survey_area, decade,  sppname) %>% 
  summarise(avg_landings_lb = mean(`landed lbs`, na.rm = T),
            across(.cols = c(landings_lb = `landed lbs`, 
                             value = value), 
                   .fns = sum, 
                   .names = "total_{.col}"),
            .groups = "drop") %>% 
  group_by(survey_area, decade) %>% 
  slice_max(order_by = total_landings_lb, n = 3) %>% 
  gt() %>% 
  gt::tab_header(title = md("**Top Commercial Fisheries Landings of Northeastern US (by weight)**")) %>% 
  tab_stubhead(label = md("*Harvest Region*")) %>% 
  fmt_number(columns = c(avg_landings_lb, total_landings_lb, total_value),
             use_seps = T, 
             sep_mark = ",",
             suffixing = T) %>% 
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_row_groups()) %>% 
  cols_label(
    decade            = md("*Decade*"),
    sppname           = md(""),
    avg_landings_lb   = md("*Avg. Annual Landings (lb.)*"),
    total_landings_lb = md("*Total Landings (lb.)*"),
    total_value       = md("*Total Value ($)*")) %>%
  gt::tab_source_note(source_note = md("*Landings data obtained from the Greater Atlantic Regional Fishing Office (GARFO)*"))
  
```
:::



# References
