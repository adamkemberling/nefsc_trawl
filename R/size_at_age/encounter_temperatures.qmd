---
title: "Species Encounter Temperature"
author: 
    name: "Adam Kemberling"
    url: https://github.com/adamkemberling
    affiliation: Gulf of Maine Research Institute
description: | 
  Environmental Conditions at Encounter Locations for Marine Species
date: "Updated on: `r Sys.Date()`"
format: 
  html:
    code-fold: true
    code-tools: true
    df-print: kable
editor: visual
execute: 
  echo: true
  warning: false
  message: false
  fig.height: 10
  fig.width: 6
  fig.align: "center"
  comment: ""
---

### Encounter Temperatures of Size-at-Age Species

Species encountering temperature changes may respond to a changing environment in a number of ways. One approach is that species may choose to change location to a more suitable environment. However; this approach may not be an option for all species. Certain species, and individuals of other species, may lack the mobility/awareness needed to relocate and must survive/persist in the new environment.

This document will look at the different temperatures that species have been caught at. Temperatures will be taken from the CTD casts deployed as part of the groundfish survey to take advantage of bottom temperatures.

The general hypothesis follows that species that are better able to track favorable temperatures should experience a lesser physiological toll than species that are unable to track temperature change. Changes in size-at-age should consequently be smaller in highly mobile species than less adaptable ones.

```{r survdat data}
#| echo = FALSE

####  Packages  ####
library(tidyverse)
library(gmRi)
library(sf)
library(gt)
library(rnaturalearth)
library(targets)
library(scales)
library(patchwork)
library(xaringanExtra)
library(ggdist)
library(ggforce)
library(geomtextpath)
library(colorspace)
library(broom)
 


# Set theme
theme_set(theme_gmri())


#### Functions  ####

# Activate panelset
xaringanExtra::use_panelset()

# Function to generate panels using a key word and a plot function
plot_panelset <- function(spec, plot_fun, ...) {
  
  # Open panel
  cat("::: {.panel}\n")
  
  # Create header for panel name
  cat("##", spec, "{.panel-name}\n")

  # # Text as a plot description
  # cat("Plot of", spec, "\n")

  # Make plot
  p <- plot_fun(spec, ...)
  print(p)

  # Add linebreak
  cat("\n")

  # Close panel
  cat(":::\n")
}



# Weighted linear models 
# To test for difference in variable across regimes
test_signif <- function(filter_species, dependent_var){
  
  # formula for lm
  mod_form <- formula(paste(dependent_var, "~ temp_regime"))
  
  # data for models
  mod_dat <- trawldat %>% 
    filter(comname == filter_species) 
  
  # abundance weighting
  abund_lm <- lm(
    formula = mod_form, 
    data = mod_dat, 
    weights = strat_abund_wt)
  
  # biomass weighted
  biom_lm <- lm(
    formula = mod_form, 
    data = mod_dat, 
    weights = strat_lwbio_wt)
  
  # Grab Significance for both in table
  data.frame(
    abund_mod_p = broom::glance(abund_lm)$p.value,
    lwbio_mod_p = broom::glance(biom_lm)$p.value) %>% 
    mutate(comname = filter_species,
           abund_signif = ifelse(abund_mod_p < 0.05, T, F),
           lwbio_signif = ifelse(lwbio_mod_p < 0.05, T, F))
  
}

```

`r gmRi::use_gmri_style_rmd(css_file = "gmri_rmarkdown.css")`

### Species Used:

The species used here will match the 16 species included as part of the size-at-age analysis. Those species are:

```{r}
# Size at age species
saa_species <- c("acadian redfish", "american plaice", 
                 "atlantic cod", "atlantic herring", 
                 "atlantic mackerel", "black sea bass", 
                 "butterfish", "haddock", "pollock", "red hake", 
                 "scup", "silver hake", "summer flounder", 
                 "white hake", "winter flounder", 
                 "witch flounder", "yellowtail flounder")

# table for printing
spec_df <- data.frame("Species" = saa_species)
spec_df %>% knitr::kable()
```

Data for these 16 species comes from fisheries independent trawl survey data collected by NOAA and the NEFSC.

```{r}
# Load the regional temperatures from {targets}
withr::with_dir(rprojroot::find_root('_targets.R'), 
                tar_load(nefsc_stratified))

# Filter to just them, and the two time regimes
trawldat <- nefsc_stratified %>% 
  filter(comname %in% saa_species,
         est_year >= 2000)

# Pull the main columns to speed things up
trawldat <- trawldat %>% 
  select(cruise6, station, stratum, tow, survey_area,
         svvessel, source, est_year, est_towdate,
         season, decdeg_beglat, decdeg_beglon, 
         avgdepth, bottemp, comname, scientific_name,
         abundance, biomass_kg, length_cm, numlen_adj, 
         catchsex, ind_weight_kg, sum_weight_kg, 
         strat_total_abund_s, strat_total_biom_s,
         strat_total_lwbio_s)

# Set up the regimes
trawldat <- trawldat %>% 
  filter(between(est_year, 2000, 2019)) %>% 
  mutate(temp_regime = ifelse(est_year < 2010, "Early Regime", "Warm Regime"))
```

### Are Species Occupying the Same Spaces?

Using the bottom temperatures sampled before each tow, and the stratified-abundances caught at each tow, the following weighted distributions can be generated for what the conditions were at each location these species were caught.

```{r}
# Standardize the stratified abundances by what the average strat-catch
# These are then used as weights for mean/median estimates
trawldat <-trawldat %>% 
  group_by(comname, temp_regime) %>% 
  mutate(
    group_strat_abund = sum(strat_total_abund_s, na.rm = T),
    group_strat_lwbio = sum(strat_total_lwbio_s, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(
    strat_abund_wt = strat_total_abund_s / group_strat_abund,
    strat_lwbio_wt = strat_total_lwbio_s / group_strat_lwbio,
    temp_regime = factor(temp_regime, levels = c("Early Regime", "Warm Regime"))
)


# Weighted Median Bottom Temperatures
median_df <- trawldat %>% 
  group_by(comname, temp_regime) %>% 
  summarise(
    abund_median = matrixStats::weightedMedian(bottemp, strat_abund_wt, na.rm = T),
    lwbio_median = matrixStats::weightedMedian(bottemp, strat_lwbio_wt, na.rm = T),
    .groups = "drop") 


# get results on significance
temp_results <- map_dfr(
  .x = saa_species, 
  .f = test_signif, 
  dependent_var = "bottemp")

# Merge them in
median_df <- left_join(median_df, temp_results, by = "comname")
```

#### Abundance Weighted

In the following figure the abundance densities for the early and warm temperature regimes are shown for each species. The distributions are weighted by stratified abundances to account for the study design and differences in catch at each location. The weighed medians are also shown for each regime.

```{r}
#| fig.height = 8

# Plot 1. Weighted by Stratified Abundance:

# And another df for connecting the points
median_segment_df <- median_df %>% 
  select(comname, temp_regime, abund_median) %>% 
  pivot_wider(names_from = "temp_regime", 
              values_from = c(abund_median)) %>% 
    mutate(median_shift = `Warm Regime` - `Early Regime`)

# Reorder the species factors by median temperature preference
median_segment_df <- median_segment_df %>% 
  mutate(comname = fct_reorder(comname, `Early Regime`, .fun = median))


# Reorder factor by warm-tolerance in Early regime
median_df <- median_df %>% 
  mutate(comname = factor(comname, levels = levels(median_segment_df$comname)))

# Make Density Plots for Each species
# Match factor levelings to preserve facet order
trawldat %>% 
  mutate(comname = factor(comname, levels = levels(median_segment_df$comname))) %>% 
  drop_na(bottemp) %>% 
  ggplot() +
  geom_density(
    aes(x=bottemp,
        weight = strat_abund_wt,
        group = temp_regime,
        colour = temp_regime,
        fill = temp_regime),
  alpha = 0.35,
  trim = TRUE) +
  geom_segment(data = median_segment_df,
               aes(x = `Early Regime`,
                   xend = `Warm Regime`,
                   y = 0,
                   yend = 0),
               color = "black") +
  geom_point(data = median_df ,
             aes(x = abund_median, 
                 y = 0, 
                 color = temp_regime),
             size = 3,
             show.legend = FALSE) +
  facet_grid(comname~.) +
  scale_fill_gmri() +
  scale_color_gmri() +
  scale_y_continuous(breaks = seq(0, 1, by = 1)) +
  scale_x_continuous(breaks = seq(0, 30, by = 2)) +
  labs(
    title = "Shift in Bottom Temperatures of Catch Locations",
    subtitle = "Distributions weighted by stratified abundance, weighted medians shown as points.",
    y = "",  
    x = "Bottom Temperature \u00b0C", 
    color = "Time Period", 
    fill = "Time Period") +
  theme(axis.text.y = element_blank(),
        strip.text.y = element_text(size = 7, angle = 0, hjust = 0),
        legend.position = "bottom")
```

### Center of Latitude

The (weighted) centers of latitude give an indication of whether a species is shifting its location Northward or Southward.

```{r}
# Weighted Median Locations
lat_median_df <- trawldat %>% 
  group_by(comname, temp_regime) %>% 
  summarise(
    abund_median = matrixStats::weightedMedian(decdeg_beglat, strat_abund_wt, na.rm = T),
    lwbio_median = matrixStats::weightedMedian(decdeg_beglat, strat_lwbio_wt, na.rm = T),
    .groups = "drop") 

```

#### Abundance Weighted

```{r}
#| fig.width = 10,
#| fig.height = 6

# Plot 1. Weighted by Stratified Abundance:

# And another df for connecting the points
lat_segment_df <- lat_median_df %>% 
  select(comname, temp_regime, abund_median) %>% 
  pivot_wider(names_from = "temp_regime", 
              values_from = c(abund_median)) %>% 
    mutate(median_shift = `Warm Regime` - `Early Regime`)

# Reorder the species factors by median temperature preference
lat_segment_df <- lat_segment_df %>% 
  mutate(comname = fct_reorder(comname, `Early Regime`, .fun = median, .desc = T))


# Reorder factor by warm-tolerance in Early regime
lat_median_df <- lat_median_df %>% 
  mutate(comname = factor(comname, levels = levels(lat_segment_df$comname)))

# Make Density Plots for Each species

trawldat %>% 
  mutate(comname = factor(comname, levels = levels(lat_segment_df$comname))) %>% 
  drop_na(decdeg_beglat) %>% 
  ggplot() +
  geom_density(
    aes(x=decdeg_beglat, 
        weight = strat_abund_wt, 
        group = temp_regime, 
        colour = temp_regime,
        fill = temp_regime),
    alpha = 0.35, 
    trim = TRUE) +
  geom_segment(data = lat_segment_df,
               aes(x = `Early Regime`,
                   xend = `Warm Regime`,
                   y = 0,
                   yend = 0),
               color = "black") +
  geom_point(data = lat_median_df ,
             aes(x = abund_median, 
                 y = 0, 
                 color = temp_regime),
             size = 3,
             show.legend = FALSE) +
  # facet_grid(comname~.) +
  facet_wrap(~comname,nrow = 1, labeller = label_wrap_gen()) + coord_flip() +
  scale_fill_gmri() +
  scale_color_gmri() +
  scale_y_continuous(breaks = seq(0, 1, by = 1)) +
  scale_x_continuous(breaks = seq(30, 60, by = 2)) +
  labs(
    title = "Shift in Latitude of Catch Locations",
    subtitle = "Distributions weighted by stratified abundance, weighted medians shown as points.",
    y = "",  
    x = "Latitude \u00b0N", 
    color = "Time Period", 
    fill = "Time Period") +
  theme(axis.text.x = element_blank(), 
        strip.text = element_text(size = 4),
        axis.ticks.x = element_blank(),
        strip.text.x = element_text(size = 7, angle = 0, hjust = 0),
        legend.position = "bottom")
```

### Center of Biomass

Using both Lat/Lon we can determine a center of biomass or abundance.

```{r}

# Map polygons
us_poly <- ne_states("united states of america", returnclass = "sf")
canada <- ne_states("canada", returnclass = "sf")

# Weighted Median Locations
center_coord_df <- trawldat %>% 
  group_by(comname, temp_regime) %>% 
  summarise(
    abund_lat = matrixStats::weightedMedian(decdeg_beglat, strat_abund_wt, na.rm = T),
    lwbio_lat = matrixStats::weightedMedian(decdeg_beglat, strat_lwbio_wt, na.rm = T),
    abund_lon = matrixStats::weightedMedian(decdeg_beglon, strat_abund_wt, na.rm = T),
    lwbio_lon = matrixStats::weightedMedian(decdeg_beglon, strat_lwbio_wt, na.rm = T),
    .groups = "drop") 


# Coord ranges to crop
xlim <- range(c(center_coord_df$abund_lon, center_coord_df$lwbio_lon))
ylim <- range(c(center_coord_df$abund_lat, center_coord_df$lwbio_lat))

```

#### Abundance Weighted

```{r}

# Make the map
ggplot() +
  geom_sf(data = us_poly) +
  geom_sf(data = canada) +
  ggforce::geom_link2(
    data = center_coord_df,
    aes(x = abund_lon, 
        y = abund_lat, 
        group = comname,
        alpha = stat(index),
        color = "Warm Regime"),
    size = 0.75,
    show.legend = FALSE) +
  geom_point(data = center_coord_df, aes(x = abund_lon, y = abund_lat, color = temp_regime), size = 3) +
  scale_color_gmri() +
  coord_sf(xlim = xlim, ylim = ylim) +
  map_theme(legend.position = "bottom") +
  labs(color = "Temperature Regime", title = "Weighted-Median Center of Abundances")

```

### Capture Depth

```{r}
# Weighted Median Locations
depth_df <- trawldat %>% 
  group_by(comname, temp_regime) %>% 
  summarise(
    abund_depth = matrixStats::weightedMedian(avgdepth, strat_abund_wt, na.rm = T),
    lwbio_depth = matrixStats::weightedMedian(avgdepth, strat_lwbio_wt, na.rm = T),
    .groups = "drop") 
```

#### Abundance Weighted

```{r}
#| fig.height = 8

# Plot 1. Weighted by Stratified Abundance:

# And another df for connecting the points
depth_segment_df <- depth_df %>% 
  select(comname, temp_regime, abund_depth) %>% 
  pivot_wider(names_from = "temp_regime", 
              values_from = c(abund_depth)) %>% 
    mutate(median_shift = `Warm Regime` - `Early Regime`)

# Reorder the species factors by median temperature preference
depth_segment_df <- depth_segment_df %>% 
  mutate(comname = fct_reorder(comname, `Early Regime`, .fun = median, .desc = F))


# Reorder factor by warm-tolerance in Early regime
depth_df <- depth_df %>% 
  mutate(comname = factor(comname, levels = levels(depth_segment_df$comname)))

# Make Density Plots for Each species

trawldat %>% 
  mutate(comname = factor(comname, levels = levels(depth_segment_df$comname))) %>% 
  drop_na(decdeg_beglat) %>% 
  ggplot() +
  geom_density(
    aes(x = avgdepth,
        weight = strat_abund_wt,
        group = temp_regime,
        colour = temp_regime,
        fill = temp_regime),
    alpha = 0.35,
    trim = TRUE) +
  geom_segment(data = depth_segment_df,
               aes(x = `Early Regime`,
                   xend = `Warm Regime`,
                   y = 0,
                   yend = 0),
               color = "black") +
  geom_point(data = depth_df ,
             aes(x = abund_depth, 
                 y = 0, 
                 color = temp_regime),
             size = 3,
             show.legend = FALSE) +
  facet_grid(comname~.) +
  scale_fill_gmri() +
  scale_color_gmri() +
  scale_y_continuous(breaks = seq(0, 1, by = 1)) +
  scale_x_continuous(breaks = seq(0, 300, by = 50)) +
  labs(
    title = "Shift in Depth of Catch Locations",
    subtitle = "Distributions weighted by stratified abundance, weighted medians shown as points.",
    y = "",  
    x = "Average Depth (m)", 
    color = "Time Period", 
    fill = "Time Period") +
  theme(axis.text.y = element_blank(),
        strip.text.y = element_text(size = 7, angle = 0, hjust = 0),
        legend.position = "bottom")
```

### Move vs. Acclimate

```{r}
# Put metrics of species movements into one table



# Compare those features to the change in growth
```
