---
title: "Species Encounter Temperature"
author: 
    name: "Adam Kemberling"
    url: https://github.com/adamkemberling
    affiliation: Gulf of Maine Research Institute
description: | 
  Environmental Conditions at Encounter Locations for Marine Species
date: "Updated on: `r Sys.Date()`"
format: 
  html:
    code-fold: true
    code-tools: true
    df-print: kable
editor: visual
execute: 
  echo: true
  warning: false
  message: false
  fig.height: 10
  fig.width: 6
  fig.align: "center"
  comment: ""
---

### Encounter Temperatures of Size-at-Age Species

Species encountering temperature changes may respond to a changing environment in a number of ways. One approach is that species may choose to change location to a more suitable environment. However; this approach may not be an option for all species. Certain species, and individuals of other species, may lack the mobility/awareness needed to relocate and must survive/persist in the new environment.

This document will look at the different temperatures that species have been caught at. Temperatures will be taken from the CTD casts deployed as part of the groundfish survey to take advantage of bottom temperatures.

The general hypothesis follows that species that are better able to track favorable temperatures should experience a lesser physiological toll than species that are unable to track temperature change. Changes in size-at-age should consequently be smaller in highly mobile species than less adaptable ones.

```{r survdat data}
#| echo = FALSE

####  Packages  ####
library(tidyverse)
library(gmRi)
library(sf)
library(gt)
library(rnaturalearth)
library(targets)
library(scales)
library(patchwork)
library(xaringanExtra)
library(ggdist)
library(ggforce)
library(geomtextpath)
library(colorspace)
library(broom)


# Set theme
theme_set(theme_gmri())

# Map polygons
us_poly <- ne_states("united states of america", returnclass = "sf")
canada <- ne_states("canada", returnclass = "sf")

#### Functions  ####

# Activate panelset
xaringanExtra::use_panelset()

# Function to generate panels using a key word and a plot function
plot_panelset <- function(spec, plot_fun, ...) {
  
  # Open panel
  cat("::: {.panel}\n")
  
  # Create header for panel name
  cat("##", spec, "{.panel-name}\n")

  # # Text as a plot description
  # cat("Plot of", spec, "\n")

  # Make plot
  p <- plot_fun(spec, ...)
  print(p)

  # Add linebreak
  cat("\n")

  # Close panel
  cat(":::\n")
}



# Function to calculate weighted mean & median across abundance and biomass measures
weighted_df_fun <- function(var_col){
  median_df <- trawldat %>% 
  group_by(comname, temp_regime) %>% 
  summarise(
    abund_median = matrixStats::weightedMedian({{var_col}}, strat_abund_wt, na.rm = T),
    lwbio_median = matrixStats::weightedMedian({{var_col}}, strat_lwbio_wt, na.rm = T),
    biom_median  = matrixStats::weightedMedian({{var_col}}, na.rm = T),
    abund_mu     = matrixStats::weightedMean({{var_col}}, na.rm = T),
    lwbio_mu     = matrixStats::weightedMean({{var_col}}, na.rm = T),
    biom_mu      = matrixStats::weightedMean({{var_col}}, na.rm = T),
    .groups = "drop") 
  
  return(median_df)
  
}





# Weighted linear models 
# To test for difference in variable across regimes
test_signif <- function(filter_species, dependent_var){
  
  # formula for lm
  mod_form <- formula(paste(dependent_var, "~ temp_regime"))
  
  # data for models
  mod_dat <- trawldat %>% 
    filter(comname == filter_species) 
  
  # abundance weighting
  abund_lm <- lm(
    formula = mod_form, 
    data = mod_dat, 
    weights = pull(mod_dat, strat_abund_wt))
  
  # abundance weighting
  lwbio_lm <- lm(
    formula = mod_form, 
    data = mod_dat, 
    weights = pull(mod_dat, strat_lwbio_wt))
  
  # biomass weighted
  biom_lm <- lm(
    formula = mod_form, 
    data = mod_dat, 
    weights = pull(mod_dat, strat_biom_wt))
  
  # Grab Significance for both in table
  data.frame(
    abund_mod_p = broom::glance(abund_lm)$p.value,
    lwbio_mod_p = broom::glance(lwbio_lm)$p.value,
    biom_mod_p  = broom::glance(biom_lm)$p.value) %>% 
    mutate(comname = filter_species,
           abund_signif = ifelse(abund_mod_p < 0.05, T, F),
           lwbio_signif = ifelse(lwbio_mod_p < 0.05, T, F),
           biom_signif  = ifelse(biom_mod_p  < 0.05, T, F)           )
  
}

```

`r gmRi::use_gmri_style_rmd(css_file = "gmri_rmarkdown.css")`

### Species Used:

The species used here will match the 16 species included as part of the size-at-age analysis. Those species are:

```{r}
# Size at age species
saa_species <- c("acadian redfish", "american plaice", 
                 "atlantic cod", "atlantic herring", 
                 "atlantic mackerel", "black sea bass", 
                 "butterfish", "haddock", "pollock", "red hake", 
                 "scup", "silver hake", "summer flounder", 
                 "white hake", "winter flounder", 
                 "witch flounder", "yellowtail flounder")

# table for printing
spec_df <- data.frame("Species" = saa_species)
spec_df %>% knitr::kable()
```

Data for these 16 species comes from fisheries independent trawl survey data collected by NOAA and the NEFSC.

```{r}
# Load the regional temperatures from {targets}
withr::with_dir(rprojroot::find_root('_targets.R'), 
                tar_load(nefsc_stratified))

# Filter to just them, and the two time regimes
trawldat <- nefsc_stratified %>% 
  filter(comname %in% saa_species,
         est_year >= 2000)

# Pull the main columns to speed things up
trawldat <- trawldat %>% 
  select(cruise6, station, stratum, tow, survey_area,
         svvessel, source, est_year, est_towdate,
         season, decdeg_beglat, decdeg_beglon, 
         avgdepth, bottemp, comname, scientific_name,
         abundance, biomass_kg, length_cm, numlen_adj, 
         catchsex, ind_weight_kg, sum_weight_kg, 
         strat_total_abund_s, strat_total_biom_s,
         strat_total_lwbio_s)

# Set up the regimes
trawldat <- trawldat %>% 
  filter(between(est_year, 2000, 2019)) %>% 
  mutate(temp_regime = ifelse(est_year < 2010, "Early Regime", "Warm Regime"))
```

## Temperature Habitat Use

Using the bottom temperatures sampled before each tow, and the biomass caught at each tow, the following weighted distributions can be generated for what the conditions were at each location these species were caught.

```{r}
# Standardize the stratified abundances by what the average strat-catch
# These are then used as weights for mean/median estimates
trawldat <- trawldat %>% 
  group_by(comname, temp_regime) %>% 
  mutate(
    group_strat_abund = sum(strat_total_abund_s, na.rm = T),
    group_strat_lwbio = sum(strat_total_lwbio_s, na.rm = T),
    group_strat_bio   = sum(strat_total_biom_s,  na.rm = T)) %>% 
  ungroup() %>% 
  mutate(
    strat_abund_wt = strat_total_abund_s / group_strat_abund,
    strat_lwbio_wt = strat_total_lwbio_s / group_strat_lwbio,
    strat_biom_wt  = strat_total_biom_s / group_strat_bio,
    temp_regime = factor(temp_regime, levels = c("Early Regime", "Warm Regime")))



# Run weighting function for bottom temp
median_df <- weighted_df_fun(bottemp)

# get results on significance
temp_results <- map_dfr(
  .x = saa_species, 
  .f = test_signif, 
  dependent_var = "bottemp")

# Merge the significance in
median_df <- left_join(median_df, temp_results, by = "comname")


# Get regime averages
temp_avgs <- median_df %>% 
  group_by(temp_regime) %>% 
  summarise(
    biom_avg = round(mean(biom_mu),2),
    biom_med = round(mean(biom_median), 2)
  )
```



Across all species the average temperature (by biomass) has increased from `r temp_avgs[temp_avgs$temp_regime == "Early Regime", 2][[1]]` to `r temp_avgs[temp_avgs$temp_regime == "Warm Regime", 2][[1]]` for a change in `r diff(temp_avgs$biom_avg)`°C. 

`r sum(temp_results$biom_signif)` of the `r length(saa_species)` showed a significant change in temperature among the different regimes indicating a change in habitat conditions regardless of avoidance strategy.

In the following figure the abundance densities for the early and warm temperature regimes are shown for each species. The distributions are weighted by stratified abundances to account for the study design and differences in catch at each location. The weighed medians are also shown for each regime.

```{r}
#| fig.height = 8

# Plot 1. Weighted by Stratified Abundance:

# And another df for connecting the points
median_segment_df <- median_df %>% 
  select(comname, temp_regime, biom_median) %>% 
  pivot_wider(names_from = "temp_regime", 
              values_from = c(biom_median)) %>% 
    mutate(median_shift = `Warm Regime` - `Early Regime`)

# Reorder the species factors by median temperature preference
median_segment_df <- median_segment_df %>% 
  mutate(comname = fct_reorder(comname, `Early Regime`, .fun = median))


# Reorder factor by warm-tolerance in Early regime
median_df <- median_df %>% 
  mutate(comname = factor(comname, levels = levels(median_segment_df$comname)))

# Make Density Plots for Each species
ggplot() +
  ggforce::geom_link(data = median_segment_df,
               aes(x = `Early Regime`,
                   xend = `Warm Regime`,
                   y = 0,
                   yend = 0,
                   group = comname,
        alpha = stat(index),
        color = "Warm Regime"),
    size = 0.75,
    show.legend = FALSE) +
  geom_point(data = median_df ,
             aes(x = biom_median, 
                 y = 0, 
                 color = temp_regime),
             size = 3,
             show.legend = FALSE) +
  facet_grid(comname~.) +
  scale_fill_gmri() +
  scale_color_gmri() +
  scale_y_continuous(breaks = seq(0, 1, by = 1)) +
  scale_x_continuous(breaks = seq(0, 30, by = 2)) +
  labs(
    title = "Shift in Bottom Temperatures of Catch Locations",
    subtitle = "Distributions weighted by biomass, weighted medians shown as points.",
    y = "",  
    x = "Bottom Temperature \u00b0C", 
    color = "Time Period", 
    fill = "Time Period") +
  theme(axis.text.y = element_blank(),
        strip.text.y = element_text(size = 7, angle = 0, hjust = 0),
        legend.position = "bottom")
```

## Center of Latitude

The (weighted) centers of latitude give an indication of whether a species is shifting its location Northward or Southward.

```{r}
# Weighted Median Locations
lat_median_df <- weighted_df_fun(decdeg_beglat)

# Get regime averages
lat_avgs <- lat_median_df %>% 
  group_by(temp_regime) %>% 
  summarise(
    biom_avg = round(mean(biom_mu),2),
    biom_med = round(mean(biom_median), 2)
  )
```


Across all species the average Latitude at capture has increased from `r lat_avgs[lat_avgs$temp_regime == "Early Regime", 2][[1]]` to `r lat_avgs[lat_avgs$temp_regime == "Warm Regime", 2][[1]]` for a change in `r diff(lat_avgs$biom_avg)` ° Latitude. 


```{r}
#| fig.width = 10,
#| fig.height = 6

# Plot 1. Weighted by Stratified Abundance:

# And another df for connecting the points
lat_segment_df <- lat_median_df %>% 
  select(comname, temp_regime, biom_median) %>% 
  pivot_wider(names_from = "temp_regime", 
              values_from = c(biom_median)) %>% 
    mutate(median_shift = `Warm Regime` - `Early Regime`)

# Reorder the species factors by median temperature preference
lat_segment_df <- lat_segment_df %>% 
  mutate(comname = fct_reorder(comname, `Early Regime`, .fun = median, .desc = T))


# Reorder factor by warm-tolerance in Early regime
lat_median_df <- lat_median_df %>% 
  mutate(comname = factor(comname, levels = levels(lat_segment_df$comname)))



# Plot the Median Latitude
# lat_plot_dat <- trawldat %>% 
#   mutate(comname = factor(comname, levels = levels(lat_segment_df$comname))) %>% 
#   drop_na(decdeg_beglat)

 



# Make a Plot of Major cities/landmarks for reference
lat_references <- data.frame(
  "cities" = c("NY, NY", "Chatham, MA", "Cape May, NJ"),
  "lat" = c( 40.72,  41.68, 38.93) 
)

# Plot Latitude Change with City References
ggplot()  +
  geom_segment(data = lat_segment_df,
               aes(y = `Early Regime`,
                   yend = `Warm Regime`,
                   x = comname,
                   xend = comname),
               color = "black") +
  geom_point(data = lat_median_df ,
             aes(x = comname, 
                 y = biom_median, 
                 color = temp_regime),
             size = 3,
             show.legend = FALSE) +
  #geom_hline(data = lat_references, aes(yintercept = lat), color = "gray60") +
  geom_label(data = lat_references, aes(x = 3.5, label = cities, y = lat)) +
  scale_fill_gmri() +
  scale_color_gmri() +
  scale_y_continuous(breaks = seq(30, 60, by = 2)) +
  labs(
    title = "Shift in Median Latitude of Catch Locations",
    subtitle = "Distributions weighted by biomass, weighted medians shown as points.",
    y = "Latitude \u00b0N",  
    x = "", 
    color = "Time Period", 
    fill = "Time Period") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        strip.text.x = element_text(size = 7, angle = 0, hjust = 0),
        legend.position = "bottom")
  
  
```

Species showing the largest latitudinal shifts include Atlantic mackerel, scup, and Black Sea Bass. These species all have center of biomass latitudes South of Cape Cod, and have some of the largest potential for Northward movements within the survey area.

## Center of Biomass

Using both Lat/Lon we can determine a center of biomass or abundance.

```{r}

# Weighted Median Locations
center_coord_df <- trawldat %>% 
  group_by(comname, temp_regime) %>% 
  summarise(
    abund_lat = matrixStats::weightedMedian(decdeg_beglat, strat_abund_wt, na.rm = T),
    lwbio_lat = matrixStats::weightedMedian(decdeg_beglat, strat_lwbio_wt, na.rm = T),
    biom_lat = matrixStats::weightedMedian(decdeg_beglat, strat_biom_wt, na.rm = T),
    abund_lon = matrixStats::weightedMedian(decdeg_beglon, strat_abund_wt, na.rm = T),
    lwbio_lon = matrixStats::weightedMedian(decdeg_beglon, strat_lwbio_wt, na.rm = T),
    biom_lon = matrixStats::weightedMedian(decdeg_beglon, strat_biom_wt, na.rm = T),
    .groups = "drop") 


# Coord ranges to crop
xlim <- range(c(center_coord_df$abund_lon, center_coord_df$biom_lon))
ylim <- range(c(center_coord_df$abund_lat, center_coord_df$biom_lat))

```

### Individual Changes

```{r}

# Make the map
ggplot() +
  geom_sf(data = us_poly) +
  geom_sf(data = canada) +
  ggforce::geom_link2(
    data = center_coord_df,
    aes(x = biom_lon, 
        y = biom_lat, 
        group = comname,
        alpha = stat(index),
        color = "Warm Regime"),
    size = 0.75,
    show.legend = FALSE) +
  geom_point(data = center_coord_df, aes(x = biom_lon, y = biom_lat, color = temp_regime), size = 3) +
  ggrepel::geom_text_repel(data = filter(center_coord_df, temp_regime == "Warm Regime"), 
            aes(label = comname, x = biom_lon, y = biom_lat), size = 3) +
  scale_color_gmri() +
  coord_sf(xlim = xlim, ylim = ylim) +
  map_theme(legend.position = "bottom") +
  labs(color = "Temperature Regime", title = "Weighted-Median Center of Biomass")




```

## Capture Depth

```{r}
# Weighted Median Locations
depth_df <- weighted_df_fun(avgdepth)

# Avg Depths 
avg_depths <- depth_df %>% 
  group_by(temp_regime) %>% 
  summarise(
    biom_avg = round(mean(biom_mu),2),
    biom_med = round(mean(biom_median), 2)
  )
```

Across all species the average depth (by biomass) has increased from `r avg_depths[avg_depths$temp_regime == "Early Regime", 2][[1]]` to `r avg_depths[avg_depths$temp_regime == "Warm Regime", 2][[1]]` for a change in `r diff(avg_depths$biom_avg)` meters.

### Individual Changes

```{r}
#| fig.height = 8

# Plot 1. Weighted by Stratified Abundance:

# And another df for connecting the points
depth_segment_df <- depth_df %>% 
  select(comname, temp_regime, biom_median) %>% 
  pivot_wider(names_from = "temp_regime", 
              values_from = c(biom_median)) %>% 
    mutate(median_shift = `Warm Regime` - `Early Regime`)

# Reorder the species factors by median temperature preference
depth_segment_df <- depth_segment_df %>% 
  mutate(comname = fct_reorder(comname, `Early Regime`, .fun = median, .desc = F))


# Reorder factor by warm-tolerance in Early regime
depth_df <- depth_df %>% 
  mutate(comname = factor(comname, levels = levels(depth_segment_df$comname)))

# Make Density Plots for Each species
ggplot() +
  ggforce::geom_link(data = depth_segment_df,
               aes(y = `Early Regime`,
                   yend = `Warm Regime`,
                   x = comname,
                   xend = comname,
                   alpha = stat(index),
        color = "Warm Regime"),
    size = 0.75,
    show.legend = FALSE) +
  geom_point(data = depth_df ,
             aes(y = biom_median, 
                 x = comname, 
                 color = temp_regime),
             size = 3,
             show.legend = FALSE) +
  scale_fill_gmri() +
  scale_color_gmri() +
  scale_y_reverse(breaks = seq(0, 300, by = 50), limits = c(200,0)) +
  labs(
    title = "Shift in Depth of Catch Locations",
    subtitle = "Distributions weighted by stratified biomass, weighted medians shown as points.",
    x = "",  
    y = "Average Depth (m)", 
    color = "Time Period", 
    fill = "Time Period") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.position = "bottom")
```

## Move vs. Acclimate

Species can achieve similar outcomes through either moving deeper, or more Northward, or some combination of both.


```{r}
# Put metrics of species movements into one table



# Compare those features to the change in growth
```
