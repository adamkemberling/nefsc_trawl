---
title: "Growth Regimes in the NW Atlantic Following Temperature Regime Shift"
author: 
    name: "Adam A. Kemberling"
    title: "Quantitative Research Associate"
    url: https://github.com/adamkemberling
    affiliation: Gulf of Maine Research Institute
description: | 
  Size at Age Analysis of the Northeast US Groundfish Community
date: "`r Sys.Date()`"
# format: docx
format:
  html:
    self-contained: true
    df-print: kable
    toc: true
    toc-depth: 2
execute: 
  echo: false
  warning: false
  message: false
  fig.height: 6
  fig.width: 6
  fig.align: center
  comment: ""
bibliography: references.bib
---

```{r packages and functions}

####  Packages  ####
{
  library(FSAdata)
  library(FSA)
  library(car)
  library(matrixStats)
  library(scales)
  library(patchwork)
  library(directlabels)
  library(xaringanExtra)
  library(ggridges)
  library(ggdist)
  library(ggforce)
  library(geomtextpath)
  library(colorspace)
  library(gt)
  library(tidyverse)
  library(gmRi)
  library(targets)
  library(bcp)
  library(ggrepel)
  library(rnaturalearth)
  library(terra)
  library(tidyterra)
  library(raster)
  library(sf)
  library(ggHoriPlot)
 
}

conflicted::conflict_prefer("select", "dplyr")
conflicted::conflict_prefer("filter", "dplyr")


# Set seed
set.seed(3905)

# Set theme
theme_set(theme_gmri())

# Celsius symbol
deg_c <- "\u00b0C"

# Acitvate panelset
xaringanExtra::use_panelset()

# Function to generate panels using a key word and a plot function
plot_panelset <- function(spec, plot_fun, ...) {
  
  # Open panel
  cat("::: {.panel}\n")
  
  # Create header for panel name
  cat("##", spec, "{.panel-name}\n")

  # # Text as a plot description
  # cat("Plot of", spec, "\n")

  # Make plot
  p <- plot_fun(spec, ...)
  print(p)

  # Add linebreak
  cat("\n")

  # Close panel
  cat(":::\n")
}
```


```{r}
#| label: configuration-constants


#----------  Season Filters ------------------

# Seasons to include in center of biomass
season_filter <- list(
  "cob" = c("Spring", "Fall"),
  "age" = c("Spring", "Fall")
)



#----------  Species Selections --------------

#. Species that have center of biomass south of Gulf of Maine
southern_species <- c("atlantic mackerel", "scup", "black sea bass", "butterfish")
  
# Species to display with their own panels
display_species <- sort(c(
  "american plaice",
  "atlantic cod",
  "atlantic herring",
  "atlantic mackerel",
  "black sea bass",
  "butterfish",
  "haddock", 
  "pollock",
  #"red hake",
  "scup",
  "silver hake",
  #"summer flounder",
  "white hake",
  #"windowpane",
  "winter flounder",
  "witch flounder",
  "yellowtail flounder"
))


# Species included in Janet Nye's Analysis of spring distributions
# Just the Species, or as Stocks?
nye_species <- c(
  "spiny dogfish",
  "little skate",
  "thorny skate",
  "winter skate",
  "alewife",
  "american shad",
  "atlantic herring",
  "atlantic cod",
  "haddock",
  "pollock",
  "silver hake",
  "red hake",
  "spotted hake",
  "white hake",
  "cusk",
  "goosefish",
  "american plaice",
  "atlantic halibut",
  "yellowtail flounder",
  "winter flounder",
  "fourspot flounder",
  "summer flounder",
  "windowpane",
  "atlantic mackerel",
  "ocean pout",
  "atlantic wolffish",
  "blackbelly rosefish",
  "longhorn sculpin",
  "sea raven",
  "acadian redfish"
)


```


```{r}
#| label: add-css
#| results: asis
gmRi::use_gmri_style_rmd(css_file = "gmri_rmarkdown.css")
```




# Abstract

Physical observations of the region indicate that the NW Atlantic has experienced a regime shift that has accelerated warming in the area. Temperature has a profound impact on the growth, behavior, production, and mortality in ectotherms. For these reasons species are expected to follow their thermal preferences, otherwise risking consequences in the forms of metabolic costs and/or other forms of stress. Using trawl survey data we monitored we tracked the individual responses of 17 species during the ten years prior, and ten years following the regime shift in 2010. Species response to warming was studied in terms of their behavioral shifts via shifting geographic center of biomass,and their biologic response via their size-at-age relationships through time. The majority of species in the southern half of the study area shifted their center of biomass Northward, with no northern species shifting anywhere south of Cape Cod. A concurrent pattern emerged in growth patterns, with the majority of species experiencing faster early-stage growth and smaller adult size. These patterns suggest that even among species that are able to follow thermal preferences, there are additional metabolic costs associated with the shifting environment. Changes in growth rates across such a wide range of species have implications for ecologists and fisheries managers seeking to understand climate impacts on fisheries.

---

# Introduction

### Literature on TSR and Growth Expectations

### Introduce Study Area and Existing Research

Recent changes in Gulf stream positioning have altered the relative influences of both the Gulf stream and Labrador current on temperature and salinity regimes for the region. Understanding that this new temperature and salinity regime should alter both the energetics of the region, as well as food-web dynamics. We seek to identify whether these changes have had a measurable impact on the growth of several groundfish species.

Despite many of these species living at or near the bottom, research suggests that the forces driving these thermal regimes should have far-reaching impacts biological impacts. These impacts may directly change the near-bottom environment through mixing patterns, and/or indirectly through food-web impacts.

Through the lens of an environmental regime change we will assess changes to body size, size-at-age, and growth characteristics derived using the Von-Bertalanffy growth equation.

---

# Methods

## Sea Surface Temperature

Global Sea surface temperature data was obtained via NOAA's optimally interpolated SST analysis (OISSTv2), providing daily temperature values at a 0.25° latitude x 0.25° longitude resolution [@reynolds2007]. A daily climatology for every 0.25° pixel in the global data set was created using average daily temperatures spanning the period of 1982-2011. Daily anomalies were then computed as the difference between observed temperatures and the daily climatological average. OISSTv2 data used in these analyses were provided by the NOAA PSL, Boulder, Colorado, USA from their website at https://psl.noaa.gov.

```{r}
#| label: Load-sst-data


#---------------------------

# Isolate the Shelf and Gulf of Maine EPU

# The Gulf of Maine EPU:
gom_oisst <- oisst_access_timeseries(
      region_family = "epu",
      poly_name = "gom",
      box_location = "cloudstorage" ) %>% 
  mutate(year = lubridate::year(time)) %>% 
  filter(between(year, 1982, 2022))

# The all-areas shelf shapefile used:
shelf_oisst <- oisst_access_timeseries(
      region_family = "nmfs trawl regions",
      poly_name = "inuse strata",
      box_location = "cloudstorage" ) %>% 
  mutate(year = lubridate::year(time)) %>% 
  filter(between(year, 1982, 2022))

# Load Global OISST:
global_oisst <- read_csv(
    paste0(cs_path("res", "OISST/oisst_mainstays"),   
           "global_timeseries/global_anoms_1982to2011.csv"), 
    guess_max = 1e6,
    col_types = cols()) %>% 
  mutate(year = lubridate::year(time)) %>% 
  filter(between(year, 1982, 2022))



# ------------------

# Make a joined dataset that can replace the targets one:
regional_oisst <- bind_rows(
  list("GoM" = gom_oisst, "all" = shelf_oisst), .id = "survey_area"
) %>% 
  select(survey_area, yr = year, sst = area_wtd_sst, sst_clim = area_wtd_clim, sst_anom = area_wtd_anom)


# Get regional averages
temp_regimes <- regional_oisst %>% 
  filter(yr > 1981) %>% 
  group_by(survey_area, yr) %>% 
  summarise(
    sst = mean(sst, na.rm = T),
    sst_clim = mean(sst_clim, na.rm = T),
    sst_anom = mean(sst_anom, na.rm = T),
    .groups = "drop") %>% 
  mutate(
    decade = floor_decade(yr),
    regime = ifelse(yr < 2010, "1982-2009 Average", "2010-2021 Average"),
    survey_area = ifelse(survey_area == "all", "Full Region", survey_area)) %>% 
  group_by(survey_area, regime) %>% 
  mutate(
    avg_temp_c = round(mean(sst), 2),
    temp_label = str_c(avg_temp_c, "\u00b0C"),
    avg_anom_c = mean(sst_anom),
    x = ifelse(regime == "1982-2009 Average", 1981.5, 2009.5),
    xend = ifelse(regime == "1982-2009 Average", 2009.5, 2021.5),
         ) %>% 
  ungroup()

#--------------------------

# Decision was made to use EPU for Gulf of Maine and the survey area for the shelf, this code was replaced

# # Load the regional temperatures from {targets}
# withr::with_dir(rprojroot::find_root('_targets.R'), 
#                 tar_load(regional_oisst))
# 
# 
# # Get regional averages
# temp_regimes <- regional_oisst %>% 
#   filter(yr > 1981) %>% 
#   mutate(
#     regime = ifelse(yr < 2010, "1982-2009 Average", "2010-2021 Average"),
#     survey_area = ifelse(survey_area == "all", "Full Region", survey_area),
#     survey_area = factor(survey_area, levels = c("Full Region", "GoM", "GB", "SNE", "MAB"))) %>% 
#   group_by(survey_area, regime) %>% 
#   mutate(
#     avg_temp_c = round(mean(sst), 2),
#     temp_label = str_c(avg_temp_c, "\u00b0C"),
#     avg_anom_c = mean(sst_anom),
#     #avg_anom_c = ifelse(regime == "1982-2009 Regime", 0, avg_anom_c),
#     x = ifelse(regime == "1982-2009 Average", 1981.5, 2009.5),
#     xend = ifelse(regime == "1982-2009 Average", 2009.5, 2021.5),
#          ) %>% 
#   ungroup()
```

### Temperature Study Region

Temperature data was regionally averaged to match the sampling area for the fisheries independent survey program providing the age-at-length data. SST anomalies were averaged over the entire sampling region, consisting of continental shelf habitats from Cape Hatteras to Nova Scotia, to produce a daily time series. This time series was then processed into an annual timeseries of surface temperatures and anomalies. All area-averaging was done with area-weighting to account for differences in the relative areas of the latitude/longitude grid of the OISSTv2 data.

### Temperature Regime Shift

Annual temperature anomalies were checked for a regime shift using the bayesian change points package [@erdman2007] following the approach of [@Barry2012] implemented in the R statistical programming language.

### Warming Trends

We computed the linear trend ($°C/Decade$) in the daily Gulf of Maine SST time series using standard linear regression. We considered the two time periods: all years before, and all years following the regime shift. Warming rates and long-term averages were estimated independently for each period.

```{r}
#| label: warming-trends-comparisons
#| eval: true







# -------------  Plot 1 - Linear Trends ----------

# Annual Trend Plot Prep:
temp_details <- function(temp_dataset){
  
    # Get the annual warming rates: 82-2021
    annual_avgs <- temp_dataset %>% group_by(year) %>% 
      summarise(
        sst = mean(area_wtd_sst), 
        sst_anom = mean(area_wtd_anom),
        .groups = "drop")  %>% 
      mutate(regime = ifelse(year<2010, gmri_cols("blue"), gmri_cols("orange")))
    
  
    # What are the warming rates in c and F
    rate_c <- as.numeric(coef(lm(sst~year, data = annual_avgs))[2])
    rate_f <- as_fahrenheit(rate_c, data_type = "anomalies")
    

    # Get the mean temperatures for 82-2009 & 2010-2021
    data_early <- annual_avgs %>% filter(year %in% c(1982:2009))
    data_late <- annual_avgs %>% filter(year %in% c(2010:2022))
    mean_early <- data_early %>% pull(sst) %>% mean()
    mean_anom_early <- data_early %>% pull(sst_anom) %>% mean()
    mean_late <- data_late %>% pull(sst) %>% mean()
    mean_anom_late <- data_late %>% pull(sst_anom) %>% mean()
    
    # Return everything
    return(
      list(
        "annual_avgs" = annual_avgs,
        "annual_rate" = rate_c,
        "rate_f" = rate_f,
        "data_early" = data_early,
        "data_late" = data_late,
        "mean_early" = mean_early,
        "mean_anom_early" = mean_anom_early,
        "mean_late" = mean_late,
        "mean_anom_late" = mean_anom_late))
  
  
}


# Run it for the three areas
area_summaries <- map(list("northeast shelf" = shelf_oisst, 
                           "Gulf of Maine" = gom_oisst, 
                           "Global Oceans" = global_oisst), temp_details)
```


::: {.panel-tabset}

### Northeast Shelf Regime Shift


```{r}
#| label: warming-rate-usshelf

# Make a Plot comparing
data_1 <- area_summaries$`northeast shelf`
data_2 <- area_summaries$`Global Oceans`
ggplot() +
  geom_path(data = data_1$annual_avgs, aes(year, sst_anom, color = regime, group = 1), alpha = 0.5) +
  scale_color_identity() +
  geom_point(data = data_1$data_early, aes(year, sst_anom), color = gmri_cols("blue"), alpha = 0.5) +
  geom_point(data = data_1$data_late, aes(year, sst_anom), color = gmri_cols("orange"), alpha = 0.5) +
  stat_smooth(data = data_1$annual_avgs, method = "lm", formula = y ~ x, 
              aes(year, sst_anom), color = "gray30", se = FALSE, linetype = 1, linewidth = 1.2, alpha = 0.9) +
  stat_smooth(data = data_2$annual_avgs, method = "lm", formula = y ~ x, 
              aes(year, sst_anom), color = "gray30", se = FALSE, linetype = 5, linewidth = 1.2, alpha = 0.9) +
  geom_segment(aes(x = 1981.5, xend = 2009.5, y = data_1$mean_anom_early, yend = data_1$mean_anom_early),
               color = gmri_cols("blue"), linewidth = 1.5) +
  geom_segment(aes(x = 2009.5, xend = 2021.5, y = data_1$mean_anom_late, yend = data_1$mean_anom_late),
               color = gmri_cols("orange"), linewidth = 1.5) +
  annotate(x = 1996, y = 0.3, geom = "text", label = "1982-2009", color = gmri_cols("blue"), fontface = "bold") +
  annotate(x = 2016, y = 1.6, geom = "text", label = "2010-2021", color = gmri_cols("orange"), fontface = "bold") +
  annotate(x = 2026, y = 0.4, geom = "text", label = "Global", color = "black", fontface = "bold") +
  annotate(x = 2026, y = 1.1, geom = "text", label = "Regional", color = "black", fontface = "bold") +
  scale_y_continuous(labels = number_format(suffix = deg_c), 
                     expand = expansion(add = c(0.5,0.5))) +
  scale_x_continuous(expand = expansion(add = c(2,8))) +
  labs(x = "Year", y = "SST Anomaly", title = "Northeast US Shelf SST Regime Shift")


```



### Gulf of Maine Regime Shift


```{r}
#| label: warming-rate-gom

# Make a Plot comparing
data_1 <- area_summaries$`Gulf of Maine`
data_2 <- area_summaries$`Global Oceans`
ggplot() +
  geom_path(data = data_1$annual_avgs, aes(year, sst_anom, color = regime, group = 1), alpha = 0.5) +
  scale_color_identity() +
  geom_point(data = data_1$data_early, aes(year, sst_anom), color = gmri_cols("blue"), alpha = 0.5) +
  geom_point(data = data_1$data_late, aes(year, sst_anom), color = gmri_cols("orange"), alpha = 0.5) +
  stat_smooth(data = data_1$annual_avgs, method = "lm", formula = y ~ x, 
              aes(year, sst_anom), color = "gray30", se = FALSE, linetype = 1, linewidth = 1.2, alpha = 0.9) +
  stat_smooth(data = data_2$annual_avgs, method = "lm", formula = y ~ x, 
              aes(year, sst_anom), color = "gray30", se = FALSE, linetype = 5, linewidth = 1.2, alpha = 0.9) +
  geom_segment(aes(x = 1981.5, xend = 2009.5, y = data_1$mean_anom_early, yend = data_1$mean_anom_early),
               color = gmri_cols("blue"), linewidth = 1.5) +
  geom_segment(aes(x = 2009.5, xend = 2021.5, y = data_1$mean_anom_late, yend = data_1$mean_anom_late),
               color = gmri_cols("orange"), linewidth = 1.5) +
  annotate(x = 1996, y = 0.3, geom = "text", label = "1982-2009", color = gmri_cols("blue"), fontface = "bold") +
  annotate(x = 2016, y = 1.75, geom = "text", label = "2010-2021", color = gmri_cols("orange"), fontface = "bold") +
  annotate(x = 2026, y = 0.4, geom = "text", label = "Global", color = "black", fontface = "bold") +
  annotate(x = 2026, y = 1.4, geom = "text", label = "Regional", color = "black", fontface = "bold") +
  scale_y_continuous(labels = number_format(suffix = deg_c), 
                     expand = expansion(add = c(0.5,0.5))) +
  scale_x_continuous(expand = expansion(add = c(2,8))) +
  labs(x = "Year", y = "SST Anomaly", title = "Gulf of Maine EPU SST Regime Shift")


```


### Regional Warming Rates



```{r}
#| label: warming-trends-maps
#| eval: true

# -------------  Plot 2 - Map of Rates ----------


# Masking Function to clip to the study area
mask_nc <- function(ras_obj, mask_shape, rotate = TRUE){
  
  # First Mask using the polygon, rotate if needed
  if(rotate == TRUE){
    m1 <- mask(rotate(ras_obj), mask_shape)
  } else {
    m1 <- mask(ras_obj, mask_shape)
  }
  
  # Then Crop
  m1 <- crop(m1, mask_shape)
  return(m1)
}


# Load warming rates raster
# # 1. Warming Rates and Rankings
oisst_path <- cs_path("res", "OISST/oisst_mainstays")
rates_path <- str_c(oisst_path, "warming_rates/annual_warming_rates1982to2021.nc")
rates_nc <- raster::stack(rates_path, varname = "annual_warming_rate")
# ranks_nc <- raster::stack(rates_path, varname = "rate_percentile")



#------------

# Crop specifically to NE Shelf
shelf_path <- gmRi:::get_timeseries_paths(region_group = "nmfs_trawl_regions", box_location = "cloudstorage")
shelf_path <- shelf_path$inuse_strata$shape_path
ne_shelf_sf <- read_sf(shelf_path) %>% st_union() %>% st_as_sf()
ne_shelf_rate <- mask_nc(ras_obj = rates_nc, mask_shape = ne_shelf_sf)


#------------

# Crop specifically to Gulf of Maine EPU
gom_epu <- ecodata::epu_sf %>% filter(EPU == "GOM")
gom_epu_rate <- mask_nc(ras_obj = rates_nc, mask_shape = gom_epu)


#------------

# Get Means within each region for display purposes
ne_shelf_avg <- cellStats(ne_shelf_rate, mean, na.rm = T) %>% round(2)
gom_epu_avg <- cellStats(gom_epu_rate, mean, na.rm = T) %>% round(2)


#------------

# Terra of general area for map


# Bounding Box Extent
area_extent <- tribble(
  ~"lon", ~"lat",
  -76,	35, 
  -61,	35, 
  -61,	48, 
  -76,	48, 
  -76,	35) %>% 
  as.matrix() %>% 
  list() %>% 
  st_polygon()

# as simple feature collection
general_area <- st_sf(area = "general_area", st_sfc(area_extent), crs = 4326)

# Mask
general_area_rate <- mask_nc(ras_obj = rates_nc, mask_shape = general_area)
general_area_rate <- terra::rast(general_area_rate)


#------------



# Make map
# landmasses, warming rates everywhere, shapefiles for regions, labels for regional rates
us_poly <- ne_states("united states of america", returnclass = "sf")
canada <- ne_states("canada", returnclass = "sf")



ggplot() +
  tidyterra::geom_spatraster(
    data = general_area_rate, show.legend = T) +
  geom_sf(data = us_poly, fill = "gray90", linewidth = .15) +
  geom_sf(data = canada, fill = "gray90", linewidth = .15) +
  geom_sf(data = ne_shelf_sf,
          color = "gray20",
          linetype = 1,
          linewidth = 0.5,
          fill = "transparent") +
  geom_sf(data = gom_epu,
          color = "gray20",
          linetype = 1, 
          linewidth = 0.5,
          fill = "transparent") +
  geom_sf(data = us_poly, fill = "gray90", linewidth = .15) +
  geom_sf(data = canada, fill = "gray90", linewidth = .15) +
  annotate(x = -63.5, y = 42.85, label = str_c("GoM EPU\n", gom_epu_avg, deg_c, " / Year"), geom = "label", size = 3) +
  annotate(x = -69.5, y = 39, label = str_c("Northeast Shelf\n", ne_shelf_avg, deg_c, " / Year"), geom = "label", size = 3) +
  scale_fill_distiller(palette = "RdBu", direction = -1, limits = c(-.12, .12), labels = number_format(suffix = deg_c), na.value = "transparent") +
  scale_y_continuous(breaks = seq(30, 50, by = 2)) +
  coord_sf(xlim = c(-78, -62), ylim = c(36, 47)) +
  theme_bw() +
  map_theme(legend.position = "bottom") +
  guides(fill = guide_colorsteps(
    title = "Annual Warming Rate: 1982-2021",
    title.position = "top",
    title.hjust = 0.5,
    barwidth = unit(4, "in"), 
    frame.colour = "black",
    ticks.colour = "black", labels = number_format(suffix = "t"),
    show.limits = T)) +
  labs(x = NULL, y = NULL)

```




:::



## Data Collection

Fishery Independent data on groundfish size-at-age was collected as part of the NEFSC's northeast trawl survey. This survey is conducted each year in the spring and in the fall, with sample locations determined following a stratified-random survey design with effort allocated in proportion to stratum area. **Add an Explanation of the Strata we Exclude**. Correction factors were applied for changes in vessels, gear, and doors when appropriate. Prior to sampling, a CTD cast is performed to collect environmental conditions for the water column at/near the start of the trawl sample providing information on bottom habitat conditions like bottom temperatures.


```{r}
#| label: age-data-prep

# Access Biological Data with {targets}
withr::with_dir(rprojroot::find_root('_targets.R'), 
                tar_load(survdat_biological))

# 1. Prepare Bio Data for Age analysis for regimes:

# Drop NA age data, restrict to both summer and fall
bio_data <- survdat_biological %>%
  filter(is.na(age) == FALSE,
         season %in% season_filter$age) %>% 
      as.data.frame()
  

# Add regime and decade labels
# Add residence info
# Add condition Facotr: Fulton's condition factor
bio_data <- bio_data %>% 
  mutate(
    yearclass = est_year - (age-1),
    regime = ifelse(est_year < 2010, "Early Regime", "Warm Regime"),
    decade = floor_decade(est_year),
    residence = ifelse(
           comname %in% southern_species,
           "Southern\nResident", 
           "Gulf of Maine\nResident"),
    # Fultons condition factor:
    fK = (100 * indwt*1000) / length_cm^3) 

rm(survdat_biological)



####  Growth Data Prep  #### 

# Filter to just the data for the two regimes
bio_regimes <- bio_data %>% 
  filter(est_year >= 2000, est_year <= 2019)



# Rank species by how many measurements there are in those years
bio_species_abunds <- bio_regimes %>% 
  dplyr::count(comname) %>% 
  arrange(desc(n)) # ordered by number measured


# Drop the ones that don't work for whatever reason
vonbert_species <- bio_species_abunds %>% 
  filter(comname %not in% c("goosefish", "fourspot flounder", "cusk", "ocean pout", "bluefish")) %>% 
  arrange(comname) %>% 
  pull(comname)


# tidy up
rm(bio_species_abunds, bio_data)
```

## Distribution Shift Analyses

Analyses focusing on the shifts in distribution among species were limited to data from the spring survey season. Previous work has shown no significant changes in timing of sampling, or the mean annual latitude and longitude of the spring survey sampling [@nye2009]. Our analyses followed the continued movements of 30 species consistent with Nye et al. 2009. These species were originally selected for being consistently sampled across all years, and as representatives of a wide range of taxonomic groups. Our analysis looks at both the annual (combined spring and fall) centers of biomass for latitude, longitude, depth, and bottom temperature distributions.


```{r}
#| label: cob-data-prep


# Access the tidy survdat Data with {targets}
withr::with_dir(rprojroot::find_root('_targets.R'), 
                tar_load(survdat_clean))


# Filter to Just spring? - its in methods for Janet but settings are at top
catch_data <- survdat_clean %>% 
  filter(season %in% season_filter$cob)


# Filter to those species
catch_data <- catch_data %>% 
  filter(comname %in% nye_species | comname %in% vonbert_species)


# Get the total biomass at each station
# Totals up the abundance and biomass across sex, ignores repeated biomass values
catch_station_totals <- catch_data %>% 
  distinct(est_year, survey_area, stratum, tow, est_towdate, season, comname, catchsex, .keep_all = T) %>%
  group_by(est_year, survey_area, stratum, tow, est_towdate, season, 
           avgdepth, bottemp, decdeg_beglat, decdeg_beglon, comname) %>% 
  summarise(biomass_kg = sum(biomass_kg, na.rm = T), .groups = "drop")


rm(survdat_clean)



```



### Calculating Spatial Metrics

```{r}
#| label: weighted-mean-functions

# Function to run the group weighted means on different groups using ...
# Does all variables: depth, bottemp, lat, lon & their variance (sd)
grouped_center_bio <- function(station_totals, ...){
  station_totals %>% 
    group_by(comname, ...) %>% 
    summarise(
      # Un-weighted averages
      total_biomass   = sum(biomass_kg),
      avg_biomass     = mean(biomass_kg),
      biomass_sd      = sd(biomass_kg),
      # All below are weighted by biomass
      avg_depth       = weightedMean(avgdepth, w = biomass_kg, na.rm = T),
      avg_temp        = weightedMean(bottemp, w = biomass_kg, na.rm = T),
      avg_lat         = weightedMean(decdeg_beglat, w = biomass_kg, na.rm = T),
      avg_lon         = weightedMean(decdeg_beglon, w = biomass_kg, na.rm = T),
      depth_sd        = weightedSd(avgdepth, w = biomass_kg, na.rm = T),
      temp_sd         = weightedSd(bottemp, w = biomass_kg, na.rm = T),
      lat_sd          = weightedSd(decdeg_beglat, w = biomass_kg, na.rm = T),
      lon_sd          = weightedSd(decdeg_beglon, w = biomass_kg, na.rm = T),
      .groups = "drop") 
}




# Function to calculate weighted mean & median for one variable
# returns a common format that can join easily to global benchmarks
variable_center_bio <- function(station_totals, var_col, wt_col = biomass_kg, ...){
  var_lab <- deparse(substitute(var_col))
  mean_df <- station_totals %>% 
    group_by(comname, ...) %>% 
    summarise(
      biom_median  = weightedMedian({{var_col}}, {{wt_col}}, na.rm = T),
      biom_mu      = weightedMean({{var_col}},   {{wt_col}}, na.rm = T),
      biom_sd      = weightedSd({{var_col}},     {{wt_col}}, na.rm = T), 
      .groups = "drop") %>% 
      mutate(var = var_lab)
    
  return(mean_df)
  
}
```


Movements through time were characterized for each species using the following metrics: center of biomass, area-occupied, mean depth of occurrence, and the mean temperature of occurrence. Each metric was weighted by the biomass of a species sampled at each station such that.

$$X_j = \frac{ \sum_{}^{}  w_iX_{ij}  }{  \sum~w_i  }$$ Where $X$ is the spatial metric, $j$ is the year, & $w$ is the biomass (in kg) for each station $i$.



```{r}
#| label: distribution-weighted-means


# Summarize the conditions each species prefers based on catch at each location,
# Perform this summary at different scales



#-------- Spring and Fall----------------

# 1. Yearly Spatial Metrics
year_avgs <- grouped_center_bio(station_totals = catch_station_totals, est_year) 


# 2. Average Metrics Across Temperature Regimes
regime_avgs <- catch_station_totals %>% 
  filter(est_year >= 2000) %>% 
  mutate(temp_regime = ifelse(est_year < 2010, "Early Regime", "Warm Regime")) %>% 
  grouped_center_bio(., temp_regime) 


# Variance across all years within each species
global_benchmarks <- grouped_center_bio(station_totals = catch_station_totals) 




#-------- Just Spring------------



#-------- Just Fall------------

```


## Size at Age Analyses

The available age data is a subset of the overall catch data from the NMFS trawl survey. This biological data subset contains additional information on individual fishes such as otolith-derived aging that require additional workup to ascertain. Not all fish species have age available for the full time period, with special attention being given to aid in the management of commercially valuable species. The data used for size-at-age analyses comes from both the Spring and Fall surveys.

Size at age analyses were performed on `r length(vonbert_species)` species. Species were omitted from analyses if age data was not available across both temperature regimes (bluefish & ocean pout) or if their physiology prevented accurate aging (elasmobranch species). The following 18 species had sufficient age data across both temperature regimes to be included in the analysis: **`r pander::pander(vonbert_species)`**.

```{r}
#| label: set-vonbert-species-data

# Name the list so it carries through purrr:: functions
names(vonbert_species) <- vonbert_species

# Make group ID for later and filter to just vbert species
# Don't need map_dfr...
vbert_age_data <- bio_regimes %>% 
  filter(comname %in% vonbert_species) %>% 
  mutate(`common name` = comname,
         group_id = str_c(regime, comname, sep = "-"))

```

### Growth by Temperature Regime

To assess the impact of an elevated temperature regime, the size-at-age data was grouped into decadal periods relating to the shift in surface temperature regimes (2000-2009 & 2010-2019). Growth in fishes is commonly modeled using the "Von-Bertalanffy" growth function (VBGF) to capture how a fishes size (length or weight) changes with age. For each species the growth was modeled by fitting the VGBF to the length distribution-at-age.

$$L_t~=~L_{\infty}(1-e^{-K(t-t_0)})$$ Where $L_t$ is the length in cm of a species at age $t$. $L_\infty$ is the asymptotic maximum length, $K$ is \_\_\_\_\_, and $t_0$ is x intercept, or the hypothetical age at 0 cm length.

```{r}
#| label: set-VB-function

# Set the function for nls() to solve
vb <- vbFuns(param="Typical") 
```


```{r}
#| label: vonbert-model-fitting

# Function to Pull Vonbert Coefficients from one species or one group subset of data
# In development: boot strapped intervals
vonbert_coef <- function(length_age_dat, start_points, min_obs = 20){
  
  ####  Von Bert Fitting Using: {FSA}  ####
  # Don't run on fewer than a minimum number of observations
  num_aged <- nrow(length_age_dat)
  
  # If number aged less than the minimum observations:
  # fill output with NA's, but preserve structure to build table
  if(num_aged < min_obs){
    
    # dataframe structure for coefficients
    na_coef_df <- data.frame(
      "Linf" = NA,
      "K" = NA,
      "t0" = NA)
    
    # dataframe structure for parameters
    na_param_df <- data.frame(
      "parameter" = NA,
      "estimate" = NA,
      "std_error" = NA,
      "t_value" = NA,
      "pr_t" = NA,
      "converged" = NA)
    
    # What to return when it fails/aborts:
    return(list("model"  = NA, 
                "coef"   = na_df, 
                "params" = na_param_df))
    
  } # Close conditional for sample size
  
  
  ####  Fitting Model When Sample Size is Sufficient  ####
  
  # Use nls to estimate VBGF parameters using starting points
  vbert_fit <- nls(length_cm ~ vb(age, Linf, K, t0),
                   data = length_age_dat,
                   start = start_points)

  # Access parameters with coef()
  vbert_coef <- as.data.frame(t(coef(vbert_fit)))
  
  
  # Get Summary Info (For convergence and std. error)
  vbert_summ <- summary(vbert_fit)
  
  # Convergence Info
  vbert_conv <- vbert_summ$convInfo$isConv
  
  # Parameters w/ Standard Error
  vbert_params <- as.data.frame(vbert_summ$parameters) %>% 
    rownames_to_column(var = "parameter") %>% 
    janitor::clean_names()
  
  # add convergence information in
  vbert_params$converged <- vbert_conv
  

  ####  Work in Progress / Debugging  ####
  # This section fails, can't find namespace/object "length_age_dat"
  # # Use bootstrapping for confidence intervals:
  # vbert_boot <- Boot(vbert_fit)  # Be patient! Be aware of some non-convergence
  # vbert_conf <- confint(vbert_boot)
  
  # output list
  out_l <- list(
    "model" = vbert_fit,
    "coef"  = vbert_coef,
    "params" = vbert_params#,
    #"conf"  = vbert_conf
  )

  # Return the list
  return(out_l)
  
}

```



```{r}
#| label: vonbert-fitting-wrapper
# Second Function for running that for a single Species, split by a factor column

# Function does these things:
# 1. grab data for one species
# 2. Get starting points for VB using all data on that species
# 3. Fit Vonbert to  both Regimes
process_group_vbert <- function(spec_name, split_col, min_obs){
  
  # Get the data using the species
  spec_dat <- dplyr::filter(vbert_age_data, comname == spec_name)
  
  # Get starting points from all data
  test_starts <-  vbStarts(length_cm ~ age, 
                           data = spec_dat)
  
  # Get coefficients for groups
  spec_dat %>% 
    split(.[split_col]) %>% 
    map(.f = vonbert_coef,
        start_points = test_starts, 
        min_obs = min_obs) %>% 
    # map_dfr(pluck, "coef", .id = split_col) %>%  # Pull  out just the coefficients
    map_dfr(pluck, "params", .id = split_col) %>%  # Pull out the parameters and stderr
    mutate(comname = spec_name)
}

```


```{r}
#| label: vonbert-coefficient-processing

# Running Each Species for Each Regime
species_coef <-  map_dfr(vonbert_species, function(x){
    process_group_vbert(
      spec_name = x, 
      split_col =  "regime", 
      min_obs = 30)
    
  })


# Get the difference in regimes to add back
coef_changes <- species_coef %>%
  distinct(comname, regime, parameter, estimate) %>% 
  pivot_wider(values_from = "estimate", names_from = c("regime")) %>% 
  mutate(regime_difference = `Warm Regime`-`Early Regime`) %>% 
  select(-c(`Warm Regime`, `Early Regime`))



# Get the change in average condition and the difference in regimes
condition_changes <- vbert_age_data %>% 
  split(.$group_id) %>% 
  map_dfr(function(x){ x %>% summarise(avg_fK = mean(fK, na.rm = T))}, .id = "group_id") %>% 
  separate(group_id, c("regime", "comname"), sep = "-", remove = T) %>% 
  pivot_wider(values_from = "avg_fK", names_from = c("regime")) %>% 
  mutate(regime_difference = `Warm Regime`-`Early Regime`) %>% 
  pivot_longer(names_to = "regime", values_to = "estimate", cols = c("Early Regime", "Warm Regime")) %>% 
  mutate(parameter = "fK")

```




### Growth Impacts on Productivity

Yield-per-recruit analysis similar to Baudron et al. 2014?


---

# Results

## Temperature Regime Shift

```{r}
#| label: Temperature-regime-shift

# Pull the whole area's temps
survey_temps <- filter(temp_regimes, survey_area == "Full Region")

# Get the distinct labels for the two regimes
regime_avg_temps <- survey_temps %>% 
  distinct(regime, avg_temp_c, avg_anom_c, temp_label) 

# Get the regime averages separately for in text values
regime_1 <- regime_avg_temps %>% filter(regime == "1982-2009 Average")
regime_2 <- regime_avg_temps %>% filter(regime == "2010-2021 Average")


# Functions developed in 10_change_points.R
# For bayesian Change points

# run bcp and flag changepoints using threshold
flag_bcp <- function(response_var,  
                     predictor_var = NULL, 
                     id_var, 
                     burnin = 10000,
                     mcmc = 10000, 
                     return.mcmc = T, 
                     threshold_prob = 0.3){
 
  # Use bcp to find support for change points
  bcp_x <- bcp(y = response_var, 
               x = predictor_var, 
               burnin = burnin, 
               mcmc = mcmc, 
               return.mcmc = return.mcmc)
  
  sink("/dev/null")
  # Convert summary to a dataframe
  bcp_sum <- as.data.frame(summary(bcp_x))
  sink()
  
  # Label the id variable
  bcp_sum$id <- id_var
  
  #Only pull records with support above desired threshold
  flag_dat <- bcp_sum[which(bcp_x$posterior.prob > threshold_prob), ]
  flag_dat <- as.data.frame(flag_dat)
  return(flag_dat)
  
}




# Perform BCP regions temp breakpoints
anom_bcp <- flag_bcp(response_var = survey_temps$sst_anom, 
                     id_var = survey_temps$yr, 
                     threshold_prob = 0.3)

# in-text values
prob_text <- paste(round(anom_bcp$Probability *100, 2), collapse = ", ")
```

SST anomaly time series of the region indicate a jump in annual temperature anomalies indicative of a regime shift centered around 2010. A bayesian change point analysis showed highest support for a regime shift among `r nrow(anom_bcp)` the years: 2009-2011. Change point probabilities for these years were `r prob_text`% respectively.

```{r}
#| label: bcp-plotting-fun

# Function to plot bcp breaks, highlighting their support
plot_bcp_breaks <- function(bcp_data, 
                            bcp_breaks, 
                            region_label, 
                            y_label = "sizeSpectra Exponent (b)",
                            y_col = "b"){
  
  # Set label elevation
  label_y <- mean(as.data.frame(bcp_data)[, y_col], na.rm = T) - 1
  
  # plot with breakpoint
  ggplot(bcp_data, aes_string("yr", y_col)) + 
    geom_line() + 
    geom_point() + 
    geom_vline(data = bcp_breaks, aes(xintercept = id), linetype = 2, color = "gray50") +
    ggrepel::geom_label_repel(data = bcp_breaks, 
                              aes(x = id, y = label_y, label = str_c(round(Probability, 2), "%"))) +
    labs(x = "Year", 
         y = y_label, 
         title = str_c(region_label, " - Bayesian Change Points"))
}





# Plot the bcp breaks for the Sea surface temperature anomalies
plot_bcp_breaks(bcp_data = survey_temps, 
                bcp_breaks = anom_bcp, 
                y_label = "Temperature Anomalies", 
                region_label = "Northeastern US Continental Shelf", 
                y_col = "sst_anom") +
  scale_y_continuous(labels = number_format(suffix = "\u00b0C"))


```

### Warming Trends

```{r}
#| label: temperature-warming-trends

# warming trends
list(
  "1982-2019" = filter(temp_regimes, between(yr, 1982, 2009)),
  "2010-2019" = filter(temp_regimes, between(yr, 2010, 2019))
) %>% 
  map_dfr(function(.x){
    mod_x <- lm(sst ~ yr, data = .x)
    rate <- coef(mod_x)[["yr"]] * 10
    rate_df <- tibble("Decadal Rate" = round(rate, 2))
    return(rate_df)}, .id = "Period")
```

Temperatures prior to the 2010 regime shift rose at a rate of 0.7 $°C/Decade$. Regional temperatures then peaked in 2012 and have remained high while decreasing slowly at a rate of 0.02 $°C/Decade$. Average temperatures following the regime shift (2011-2021), were on average 1.09°C warmer than the than the average over the previous 28 years (1982-2009). Temperatures within each regime were relatively stable, indicative of a jump in mean temperatures rather than a rate change between them. While temperatures in the current regime are falling, the rate is such that

```{r}
#| label: temperature-regime-figure

# Plot how each one exhibits a break in the temperature across the region
temp_regimes %>% 
  filter(survey_area == "Full Region") %>% 
  ggplot( aes(yr, sst_anom)) +
  geom_col(aes(fill = regime),  size = 0.75, alpha = 0.4) +
  scale_fill_gmri() +
  # Using geomtextpath for label
  geom_textpath(
    aes(x = yr, 
        y = avg_anom_c, 
        label = temp_label, 
        linecolor = regime,
        colour = regime), 
        size = 4, 
    vjust = -1,
    fontface = "bold", 
    show.legend = FALSE) +
  # Line segments for the regime averages:
  geom_segment(
    aes(x = x, 
        xend = xend,
        y = avg_anom_c, 
        yend = avg_anom_c,
        color = regime),
    #key_glyph = "rect",
    linewidth = .8,
    linetype = 1) +
  scale_x_continuous(expand = expansion(add = c(0.25,0.25))) +
  scale_y_continuous(labels = number_format(suffix = " \u00b0C")) +
  scale_color_gmri() +
  guides(fill = "none") +
  theme(
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.background = element_rect(fill = "transparent"),
    legend.key = element_rect(fill = "transparent", color = "transparent")) + 
  labs(
    title = "Northwest-Atlantic Temperature Regime Shift",
    x = "", 
    y = "Surface Temperature Anomaly",
    caption = "Anomalies calculated using 1982-2011 reference period.") +
  guides(label = "none",
         color = guide_legend(keyheight = unit(0.5, "cm"), ))
   
```

## Distribution Shifts

```{r}
#| label: center-bio-heatmaps
#| fig.height: 8
#| fig-width: 8

# Get the values for each of them in a standardized format
# Standardize to global benchmarks

# Latitude
lat_yrly <- variable_center_bio(station_totals = catch_station_totals, wt_col = biomass_kg, decdeg_beglat, est_year) %>% 
  left_join(select(global_benchmarks, c("comname", "avg_lat", "lat_sd")), by = "comname") %>% 
  mutate(biom_z = (biom_mu - avg_lat) / lat_sd) 

# Longitude
lon_yrly <- variable_center_bio(station_totals = catch_station_totals, wt_col = biomass_kg, decdeg_beglon, est_year) %>% 
  left_join(select(global_benchmarks, c("comname", "avg_lon", "lon_sd")), by = "comname") %>% 
  mutate(biom_z = (biom_mu - avg_lon) / lon_sd) 

# Bottom Temperature
t_yrly <- variable_center_bio(station_totals = catch_station_totals, wt_col = biomass_kg, bottemp, est_year) %>% 
  left_join(select(global_benchmarks, c("comname", "avg_temp", "temp_sd")), by = "comname") %>% 
  mutate(biom_z = (biom_mu - avg_temp) / temp_sd) 

# Depth
d_yrly <- variable_center_bio(station_totals = catch_station_totals, wt_col = biomass_kg, avgdepth, est_year) %>% 
  left_join(select(global_benchmarks, c("comname", "avg_depth", "depth_sd")), by = "comname") %>% 
  mutate(biom_z = (biom_mu - avg_depth) / depth_sd) 



# Put them together in one table for heatmap
standardized_changes <- list(
  "Latitude" = lat_yrly,
  "Longitude" = lon_yrly,
  "Bottom Temperature" = t_yrly,
  "Depth" = d_yrly) %>% 
  map_dfr(function(x){select(x, comname, est_year, var, biom_z)}, .id = "var_neat")



# Organize them by their global average latitude
global_benchmarks <- global_benchmarks %>% 
  mutate(comname = fct_reorder(.f = comname, .x = avg_lat, .fun = median))

# Relevel the standardized changes
standardized_changes <- standardized_changes %>% 
  mutate(comname = factor(comname, 
                          levels = levels(global_benchmarks$comname)))


# Heatmap
standardized_changes %>% 
  ggplot(aes(est_year, comname, fill = biom_z)) +
  geom_tile() +
  scale_x_continuous(expand = expansion(add = c(0, 0))) +
  facet_wrap(~var_neat, ncol = 2, scales = "fixed") +
  scale_fill_distiller(palette = "RdBu",
                       oob = scales::oob_squish,
                       limits = c(-1, 1), 
                       breaks = c(-1, -.5, 0, .5, 1),
                       labels =c("<-1", "-.5", "0", ".5", ">1")) +
  labs(x = "Year", y = "",
       title = "Center of Biomass Movements Through Time",
       fill = "Center of Biomass Metric Change (z)",
       caption = "Species ordered based on center of biomass latitude across all years.") +
  theme(legend.position = "bottom",
        axis.text.y = element_text(size = 7)) +
  guides(fill = guide_colorbar(title.position = "top", title.hjust = 0.5, barwidth = unit(6, "cm")))

```

## Center of Biomass Trends

Taking the annual weighted center of biomass locations from each species we can see that there is a prevailing direction to the majority of these shifts.

::: panel-tabset
### Latitude

```{r}
#| label: center-lat-shifts


# Standardized Plots
lat_yrly %>% 
  group_by(comname) %>% 
  mutate(slope = lm(biom_z ~ est_year)$coeff[2],
         change = ifelse(slope > 0, "Positive Change", "Negative Change")) %>%
  ggplot(aes(est_year, biom_z, group = comname)) +
  stat_smooth(method = "lm", 
              geom = "line",
              formula = y ~ x, 
              aes(color = change),
              alpha = 0.6, 
              linewidth = 1,
              se = FALSE) +
  geom_point(aes(color = change), alpha = 0.25) +
  geom_hline(aes(yintercept = 0, color = "No Change Null Hypothesis"), size = 1, linetype = 1) +
  scale_color_gmri(reverse = T) +
  facet_wrap(~change) +
  labs(
    title = "Shift in Center of Biomass Latitudes",
    subtitle = "Yearly averages weighted by biomass, scaled with 2000-2019 mean & sd.",
    y = "Center of Biomass Latitude (z)",  
    x = "", 
    color = "Species Change") +
  theme(legend.position = "bottom")
```

### Longitude

```{r}
#| label: center-lon-shifts

# Longitude
lon_yrly %>% 
  group_by(comname) %>% 
  mutate(slope = lm(biom_z ~ est_year)$coeff[2],
         change = ifelse(slope > 0, "Positive Change", "Negative Change")) %>%
  ggplot(aes(est_year, biom_z, group = comname)) +
  stat_smooth(method = "lm", 
              geom = "line",
              formula = y ~ x, 
              aes(color = change),
              alpha = 0.6, 
              linewidth = 1,
              se = FALSE) +
  geom_point(aes(color = change), alpha = 0.25) +
  geom_hline(aes(yintercept = 0, color = "No Change Null Hypothesis"), size = 1, linetype = 1) +
  scale_color_gmri(reverse = T) +
  facet_wrap(~change) +
  labs(
    title = "Shift in Center of Biomass Longtitudes",
    subtitle = "Yearly averages weighted by biomass, scaled with 2000-2019 mean & sd.",
    y = "Center of Biomass Longitude (z)",  
    x = "", 
    color = "Species Change") +
  theme(strip.text.y = element_text(size = 7, angle = 0, hjust = 0),
        legend.position = "bottom")


```

### Mean Temperature

```{r}
#| label: center-temp-shifts

# Temperature
t_yrly %>% 
  group_by(comname) %>% 
  mutate(slope = lm(biom_z ~ est_year)$coeff[2],
         change = ifelse(slope > 0, "Positive Change", "Negative Change")) %>%
  ggplot(aes(est_year, biom_z, group = comname)) +
 stat_smooth(method = "lm", 
              geom = "line",
              formula = y ~ x, 
              aes(color = change),
              alpha = 0.6, 
              linewidth = 1,
              se = FALSE) +
  geom_point(aes(color = change), alpha = 0.25) +
  geom_hline(aes(yintercept = 0, color = "No Change Null Hypothesis"), size = 1, linetype = 1) +
  scale_color_gmri(reverse = T) +
  facet_wrap(~change) +
  labs(
    title = "Shift in Center of Biomass Temperature",
    subtitle = "Yearly averages weighted by biomass, scaled with 2000-2019 mean & sd.",
    y = "Center of Biomass Bottom Temperature (z)",  
    x = "", 
    color = "Species Change") +
  theme(legend.position = "bottom")
```

### Mean Depth

```{r}
#| label: center-depth-shifts

# Depth
d_yrly %>% 
  group_by(comname) %>% 
  mutate(slope = lm(biom_z ~ est_year)$coeff[2],
         change = ifelse(slope > 0, "Positive Change", "Negative Change")) %>%
  ggplot(aes(est_year, biom_z, group = comname)) +
  stat_smooth(method = "lm", 
              geom = "line",
              formula = y ~ x, 
              aes(color = change),
              alpha = 0.6, 
              linewidth = 1,
              se = FALSE) +
  geom_point(aes(color = change), alpha = 0.25) +
  geom_hline(aes(yintercept = 0, color = "No Change Null Hypothesis"), size = 1, linetype = 1) +
  scale_color_gmri(reverse = T) +
  facet_wrap(~change) +
  labs(
    title = "Shift in Center of Biomass Depth",
    subtitle = "Yearly averages weighted by biomass, scaled with 2000-2019 mean & sd.",
    y = "Center of Biomass Depth (z)",  
    x = "", 
    color = "Species Change") +
  theme(strip.text.y = element_text(size = 7, angle = 0, hjust = 0),
        legend.position = "bottom")
```
:::



## Changes to Growth

```{r}
#| label: regime-comparison-data

# Take the first part from the previous plot:
# takes each species
# for age 0 - max_age, solve what the size would be based on vb fit
regime_curve_prep <- function(spec_name){
  
  # The raw size/age data:
  t_dat <- vbert_age_data %>% 
    filter(comname == spec_name)  
  
  # The group coefficients, augmented with x values across a range
  age_max <- max(t_dat$age)
  x_range <- seq(from = 0, to = age_max, by = .1)
  t_coef <- species_coef %>% 
    distinct(comname, regime, parameter, estimate) %>% 
    pivot_wider(values_from = "estimate", names_from = "parameter") %>% 
    filter(comname == spec_name) %>% 
    right_join(
      # Make a dataframe that covers the size range for the species
      y = data.frame(
        regime = rep(unique(t_dat$regime), length(x_range)),
        age = rep(x_range, length(unique(t_dat$regime)))),
      by = "regime") %>% 
    mutate(
      # Calculate the length at age
      pred_length = Linf * (1  - exp(-1 * K * (age - t0)))
    )
  
  # Pivot wider?
  # Take the size at age from each regime and get the difference
  t_coef <- t_coef %>%
    select(-c(Linf, K, t0)) %>% 
    pivot_wider(names_from = "regime", values_from = "pred_length") %>%
    mutate(
      growth_shift = `Warm Regime` - `Early Regime`,
      growth_frac = (growth_shift / `Early Regime`),
      size_change  = ifelse(growth_shift > 0, "Increase", "Decrease")
    )
  
  return(t_coef)
  
}


# Do it for all the species
regime_comparison <- vonbert_species %>% 
  map_dfr(.f = regime_curve_prep, .id = "comname")
  
```

Changes in the size-at-age growth relationship varied across species, with the majority (14/18) of the species exhibiting smaller L-infinity during the warmer temperature regime.


The species that showed larger asymptotic lengths include the three hake species: **red hake, silver hake, & white hake** as well as **Atlantic herring.** These species are all among the majority group of species that is found primarily in the Northern part of the survey area, in and around the Gulf of Maine.

```{r}
#| label: growth-coef-plot
#| fig.height: 6
#| eval: true





# Reshape things so you can show confidence intervals here
plot_dat <- species_coef  %>% 
  left_join(coef_changes, by = c("comname", "parameter")) %>% 
  filter(parameter != "t0") %>% 
  mutate(llim = estimate - 2 * std_error,
         rlim = estimate + 2 * std_error,
         residence = ifelse(
           comname %in% southern_species,
           "Southern\nResident", 
           "Gulf of Maine\nResident"),
         regime = fct_rev(regime),
         comname = fct_rev(comname))





# Plot it
ggplot(plot_dat, aes(x = estimate, y = comname, group = regime, color = regime)) + 
    # need to nudge groups separately
  # Early Regime
    geom_segment(data = filter(plot_dat, regime == "Early Regime"), 
                 aes(x = llim, xend = rlim, yend = comname), 
                 position = position_nudge(x = 0, y = 0.25)) +
  geom_segment(data= filter(plot_dat, regime == "Warm Regime"), 
               aes(x = llim, xend = rlim, yend = comname), 
               position = position_nudge(x = 0, y = -0.25)) +
    geom_point(aes(color = regime), position = position_dodge(width = 1), size = 2) +
    facet_grid(residence ~ parameter, scales = "free", space = "free_y") +
    scale_color_gmri(reverse = F) +
    labs(x = "Coefficient Estimate", y = "", fill = "Temperature Regime:") +
    theme(legend.position = "bottom", 
          panel.background = element_rect(color = "gray80", fill = "transparent", linewidth = 1),
          panel.spacing = unit(2, "lines"),
          panel.border = element_rect(color = "gray80", fill = "transparent", linewidth = 1))
  
  
```


# Summary Tables of Growth Change

::: panel-tabset

## Changes in $L_\infty$

```{r}
#| label: tbl-linf-changes

species_coef %>% 
  distinct(comname, regime, parameter, estimate) %>% 
  pivot_wider(values_from = "estimate", names_from = "parameter") %>% 
  mutate(regime_2 = ifelse(regime == "Early Regime", "early", "warm")) %>% 
  select(comname, regime_2, Linf) %>% 
  pivot_wider(values_from = Linf, names_from = regime_2) %>% 
  mutate(linf_diff = warm - early,
         diff_perc = (linf_diff / early) * 100) %>% 
  mutate(across(where(is.numeric), round, 2)) %>% 
  arrange(diff_perc) %>% 
  select(c(1, 4, 5)) %>% 
  setNames(c("Common Name", #"Early Regime Linf", "Warm Regime Linf", 
             "Change in Linf (cm)", "Percent Change")) %>% 
  gt(rowname_col = "Common Name") %>% 
  gt::tab_header(title = "Changes in L-infinity") %>% 
  tab_stubhead(label = "Common Name") %>% 
  tab_row_group(label = "Body Size Increase", rows = `Percent Change` > 0) %>% 
  tab_row_group(label = "Body Size Decrease", rows = `Percent Change` < 0)
```



## Changes in Condition Factor (Fulton's K)

```{r}
#| label: tbl-condition_changes

condition_changes %>% 
  pivot_wider(values_from = "estimate", names_from = "regime") %>% 
  select(comname, "Early Regime", "Warm Regime",  regime_difference) %>% 
  mutate(across(-c(comname), .fns = round, 2)) %>% 
  arrange(desc(`Warm Regime`)) %>% 
  setNames(c("Common Name", "Early Regime", "Warm Regime", "Change in Condition (K)")) %>% 
  gt(rowname_col = "Common Name") %>% 
  gt::tab_header(title = "Changes in Condition Factor (Fulton's K)") %>% 
  tab_stubhead(label = "Common Name") %>% 
  tab_row_group(label = "Condition Increase", rows = `Change in Condition (K)` > 0) %>% 
  tab_row_group(label = "Condition Decrease", rows = `Change in Condition (K)` < 0) %>% 
  tab_row_group(label = "Condition Stable", rows = `Change in Condition (K)` == 0)
```

:::

## Growth with Changes in The Environment

```{r}
# 1. 
# Get early regime temp and late regime temp in the species_coef table
# Add the condition factos in too



# Add it to the regime coefficients
# Reshape everything
all_regime_estimates <-  regime_avgs %>% 
  rename(regime = `temp_regime`) %>% 
  filter(comname %in% vonbert_species) %>% 
  pivot_longer(names_to = "parameter", values_to = "estimate", cols = c(total_biomass:lon_sd)) %>% 
  # Join in condition factor here
  bind_rows(select(condition_changes, comname, regime, estimate, parameter)) %>% 
  # Join in the center of biomass information
  bind_rows(select(species_coef, -c(std_error, t_value, pr_t, converged))) %>% 
  pivot_wider(names_from = "regime", values_from = "estimate")


  



# Calculate deltas, reshape back to plot easier
regime_deltas <- all_regime_estimates%>% 
  mutate(regime_delta = `Warm Regime` - `Early Regime`) %>% 
  pivot_longer(cols = c(`Warm Regime`, `Early Regime`, regime_delta), names_to = "regime") %>% 
  pivot_wider(names_from = parameter, values_from = value) %>% 
  mutate(
    residence = ifelse(
      comname %in% southern_species,
      "Southern\nResident", 
      "Gulf of Maine\nResident"))
```

### Temperature

::: panel-tabset

#### K

```{r}
regime_deltas %>% 
  filter(regime == "regime_delta") %>% 
  ggplot(aes(avg_temp, K, color = residence)) +
    geom_hline(yintercept = 0, color = "gray50") +
    geom_vline(xintercept = 0, color = "gray50") +
    geom_label_repel(aes(label = comname), size = 3, 
                     nudge_y = 0.02, show.legend = FALSE) +
    geom_point() +
    scale_x_continuous(limits = c(-2,2), labels = number_format(suffix = deg_c)) +
    labs(x = expression(Delta~Bottom~Temperature),
         y = expression(Delta~K),
         title = str_c("Change in K with Temperature Change"))

```
 
#### L infinity



```{r}

regime_deltas %>% 
  filter(regime == "regime_delta") %>% 
  ggplot(aes(avg_temp, Linf, color = residence)) +
    geom_hline(yintercept = 0, color = "gray50") +
    geom_vline(xintercept = 0, color = "gray50") +
    geom_label_repel(aes(label = comname), size = 3, 
                     nudge_y = 2, show.legend = FALSE) +
    geom_point() +
  scale_x_continuous(limits = c(-2,2), labels = number_format(suffix = deg_c)) +
    labs(x = expression(Delta~t),
         y = expression(Delta~L~infinity~~(cm)),
         title = str_c("Change in L-Infinity with Temperature Change"))
```


#### Condition

```{r}
regime_deltas %>% 
  filter(regime == "regime_delta") %>% 
  ggplot(aes(avg_temp, fK, color = residence)) +
    geom_hline(yintercept = 0, color = "gray50") +
    geom_vline(xintercept = 0, color = "gray50") +
    geom_label_repel(aes(label = comname), size = 3, 
                     nudge_y = 0.01, show.legend = FALSE) +
    geom_point() +
    scale_x_continuous(limits = c(-2,2), labels = number_format(suffix = deg_c)) +
    labs(x = expression(Delta~Bottom~Temperature),
         y = expression(Delta~Condition~Factor~(K)),
         title = str_c("Change in Condition with Temperature Change"),
         color = "Center of Biomass Location")

```

:::

### Depth

::: panel-tabset

#### K
```{r}

regime_deltas %>% 
  filter(regime == "regime_delta") %>% 
  ggplot(aes(avg_depth, K, color = residence)) +
    geom_hline(yintercept = 0, color = "gray50") +
    geom_vline(xintercept = 0, color = "gray50") +
    geom_label_repel(aes(label = comname), size = 3, 
                     nudge_y = 0.025, show.legend = FALSE) +
    geom_point() +
    labs(x = expression(Delta~Depth~~(m)),
         y = expression(Delta~K),
         title = str_c("Change in K with Depth Change"),
         color = "Center of Biomass Location")
```

#### L infinity

```{r}
regime_deltas %>% 
  filter(regime == "regime_delta") %>% 
  ggplot(aes(avg_depth, Linf, color = residence)) +
    geom_hline(yintercept = 0, color = "gray50") +
    geom_vline(xintercept = 0, color = "gray50") +
    geom_label_repel(aes(label = comname), size = 3, 
                     nudge_y = 2, show.legend = FALSE) +
    geom_point() +
    labs(x = expression(Delta~L~infinity~~(cm)),
         y = expression(Delta~K),
         title = str_c("Change in L-Infinity with Depth Change"),
         color = "Center of Biomass Location")

```



#### Condition

```{r}
regime_deltas %>% 
  filter(regime == "regime_delta") %>% 
  ggplot(aes(avg_depth, fK, color = residence)) +
    geom_hline(yintercept = 0, color = "gray50") +
    geom_vline(xintercept = 0, color = "gray50") +
    geom_label_repel(aes(label = comname), size = 3, 
                     nudge_y = 0.01, show.legend = FALSE) +
    geom_point() +
    labs(x = expression(Delta~Bottom~Temperature),
         y = expression(Delta~Condition~Factor~(K)),
         title = str_c("Change in Condition with Depth Change"),
         color = "Center of Biomass Location")

```

:::

## VB Fits to Data:

```{r}
#| label: vb-fits-fun

# Make the plot for each species
vb_fits_plot = function(spec_name){
    
  # The raw size/age data:
  t_dat <- vbert_age_data %>% filter(comname == spec_name)  
  
  # The group coefficients, augmented with x values across a range
  age_max <- max(t_dat$age)
  x_range <- seq(from = 0, to = age_max, by = .1)
  t_coef <- species_coef %>% 
    distinct(comname, regime, parameter, estimate) %>% 
    pivot_wider(values_from = "estimate", names_from = "parameter") %>% 
    filter(comname == spec_name) %>% 
    right_join(
      y = data.frame(
        regime = rep(unique(t_dat$regime), length(x_range)),
        age = rep(x_range, length(unique(t_dat$regime)))),
      by = "regime") %>% 
    mutate(
      # Calculate the length at age
      pred_length = Linf * (1  - exp(-1 * K * (age - t0)))
    )
  
  
  # Make plot?
  ggplot(t_dat, aes(x = age, y = length_cm)) +
    geom_point(alpha = 0.25) +
    #facet_wrap(~regime, ncol = 1) +
    geom_line(data = t_coef,
              aes(x = age, y = pred_length, group = regime, color = regime), 
              size = 1) +
    scale_x_continuous(breaks = seq(0, age_max, by = 2),
                       limits = c(0, age_max),
                       expand = expansion(mult = c(0.1, .2))) +
    scale_color_gmri() +
    geom_dl(data = t_coef, 
            aes(x = age, y = pred_length, label = regime, color = regime), 
            method= list("last.qp", cex = 0.65, hjust = -.15),
            size = 12) +
    labs(x = "Age",
         y = "Length (cm)",
         title = spec_name,
         color = "Temperature Regime:",
         subtitle = "Length at Age Regimes")

    
  }
```

::: panelset
```{r, results="asis", fig.height = 6}
#| label: vb-fits-plots

# Loop through the key species:
walk(display_species, 
     plot_panelset, 
     plot_fun = vb_fits_plot)

```
:::

# Discussion







---

# Bonus: Data Explorations

## Age Data Availability

The availability of age data varied by species and through time, with older ages becoming less frequently sampled in recent years across many species.

```{r}
#| label: ridge-plot-function


# Plotting age distribution as ggridges
plot_age_ridgeplot <- function(species){
  vbert_age_data %>% 
    filter(comname == species,
           age <= 15) %>% 
    mutate(yr = factor(est_year),
           yr = fct_rev(yr)) %>% 
    ggplot(aes(x = age, y = yr)) +
      geom_density_ridges(aes(fill = regime), color = "white", show.legend = FALSE) +
      scale_fill_gmri() +
      facet_wrap(~comname) +
      scale_x_continuous(limits = c(0,NA), 
                         expand = expansion(add = c(0, 0))) +
      labs(x = "Age", y = "Year") +
      guides(size = guide_legend(title.position = "top", title.hjust = 0.5))
  
}
```

::: panelset
```{r, results="asis", fig.height=8, eval = FALSE}
#| label: ridge-plot-panels

# Loop through the key species:
walk(display_species, plot_panelset, plot_fun = plot_age_ridgeplot)

```
:::

Strong age classes were particularly prominent in the following species, showing lasting numbers in subsequent years.

| Species          | Strong Year Classes |
|------------------|---------------------|
| Atlantic Cod     | 2003, 2013          |
| Haddock          | 2003, 2010, 2013    |
| Atlantic Herring | 2008, 2011          |
| Pollock          | 2000, 2012          |

## Growth Increment Changes

Annual Growth increments for each species were computed to track the change in growth of specific age-groups through time.

```{r}
#| label: age-size-increments


# Age-Size Increments Differences
vb_incs <- vbert_age_data %>% 
  group_by(`common name`, est_year,  age, regime) %>% 
  summarise(avg_len = mean(length_cm, na.rm = T),
            avg_wt  = mean(indwt, na.rm = T),
            .groups = "drop") %>% 
  arrange(`common name`, age) %>% 
  group_split(`common name`, est_year) %>% 
  map_dfr(function(x){
    x %>% 
      mutate(
        # What age is being subtracted from
        lead_age   = lead(age, n = 1),
        # String built from the value to confirm
        diff_name  = str_c(age, " - ", lead_age),
        # Length/Weight at age + 1
        len_age_plus1 = lead(avg_len, n = 1),
        wt_age_plus1  = lead(avg_wt, n = 1),
        # Length/Weight Growth Increments
        length_increment    = len_age_plus1 - avg_len,
        weight_increment     = wt_age_plus1 - avg_wt,
        # Percent change in bodymass for going from age to age+1
        len_perc_change = (length_increment / avg_len) * 100,
        wt_perc_change = (weight_increment / avg_wt) * 100) %>% 
      filter((lead_age - age == 1))
  })


```

Age specific growth (annual growth increments) help detail where in a species life cycle it may be experiencing favorable or less-favorable conditions for growth. These can be a result of differences in habitat use or prey resources at different ages, and/or a change in exposure to temperature or other stressors that inflict a metabolic cost.

```{r}
#| label: age-increment-fun

# Put together a timeseries of:
# how big were the age 0's,
# how big were the age 1's

# Plotting Age Increments
plot_age_increments <- function(
    spec_choice, 
    var_choice = "length", 
    gam_knots = 15, 
    facet_prefix = "Age Increment: ",
    facet_suffix = ""){
  
# Code to switch variables and their labels:
  var_sym <- switch(var_choice,
    "length" = sym("length_increment"),
    "weight" = sym("weight_increment"))
  var_label <- switch(var_choice,
                      "length" = "Annual Growth  (cm)",
                      "weight" = "Annual Growth  (kg)")
  
  
  # Add pre/suffix to facet labels
  appender <- function(string, prefix = facet_prefix, suffix = facet_suffix) {
    paste0(prefix, string)}

  # Make the plot
  vb_incs %>% 
    filter(`common name` == spec_choice,
           lead_age <= 5) %>% 
    drop_na({{var_sym}}) %>% 
    ggplot(aes(est_year, {{var_sym}})) +
      # geom_col(fill = gmri_cols("gmri blue")) +
      geom_point(color = gmri_cols("gmri blue")) +
      geom_line(color = gmri_cols("gmri blue"), group = 1, alpha = 0.3, size = 0.8) +
      geom_smooth(method = "gam",
                  formula = y ~ s(x, bs = "cs", k = gam_knots),
                  se = FALSE,
                  size = 1,
                  color = gmri_cols("orange")) +
      facet_wrap(~diff_name, ncol = 1, scales = "free",
                 labeller = as_labeller(appender))  +
      theme(legend.position = "bottom") +
      labs(x = "",
           y = var_label,
           color = "Age Increment",
           title = str_to_title(spec_choice),
           subtitle = str_c("Changes in annual ", var_choice, " growth increments."))

}

```

::: panelset
```{r, results="asis", fig.height = 8, eval = FALSE}
#| label: age-inc-panels

# Loop through the key species:
walk(display_species, plot_panelset, plot_fun = plot_age_increments, var_choice = "weight", gam_knots = 5)

```
:::



## Temperature and Age Increments


I’m also trying to think about how to look at lagged temperature effects on size, with a particular interest in MHWs. A starting point might be to look at cross-correlation (ccf) between temperature and the age increments. That would enable us to see the time period over which potential lagged effects operate.

This will produce lots of plots (one for each age increment), so let’s start with just a few species…maybe plaice, cod, silver hake, and summer flounder based on some differences I see in the VB curves.



```{r}
#| label: ccf-plot
#| fig-height: 10

# Pull growth increments and add sst for whole area:
increment_temps <- vb_incs %>% 
  distinct(yr = est_year, comname =`common name`, diff_name, age, avg_len, avg_wt, lead_age, len_age_plus1, wt_age_plus1, length_increment, weight_increment) %>% 
  left_join(
    select(temp_regimes, -c(decade, avg_temp_c, temp_label, avg_anom_c, x, xend)) %>% 
      filter(survey_area == "Full Region")
  )


# Do cross correlation of growth increments and sst anomalies
age_increment_ccf <- increment_temps %>% 
  split(.$comname) %>% 
  map_dfr(function(species){
    # Split again to run ccf on each age increment
    age_increment_results <- species %>% 
      split(.$diff_name) %>% 
      map_dfr(function(x) {
        split_ccf <- ccf(x$sst_anom, x$length_increment, 
                         plot = FALSE, type = "correlation", lag.max = 12)
        ccf_results <- data.frame(
          "lag" = split_ccf$lag %>% as.numeric(),
          "correlation" = split_ccf$acf %>% as.numeric())}, 
        .id = "Age Increment" )
    
    return(age_increment_results)
  }, .id = "comname")
  


# Plot them
age_increment_ccf %>% 
  filter(`Age Increment` %in% c("0 - 1", "1 - 2", "2 - 3", "3 - 4",
                                "4 - 5", "5 - 6"),
         between(lag, -10, 10)) %>% 
  ggplot(aes(lag, y = comname, fill = correlation)) +
  geom_tile() +
  scale_x_continuous(breaks = seq(-10,10,2)) +
  # scale_fill_distiller(palette = "RdBu", limits = c(-1,1)) +
  scale_fill_fermenter(palette = "RdBu", limits = c(-1,1), breaks = seq(-1,1, .2)) +
  facet_wrap(`Age Increment`~., labeller = as_labeller(~str_c("Age Increment ", .x)), ncol = 2) +
  labs(x = "Year Lags on Predictor (SST Anomaly)",
       y = "Common Name",
       fill = "Correlation",
       title = "Lagged Response in Length Growth at Various Age Increments",
       subtitle = "A counterpart to CCF Plots") +
  guides(fill = guide_colorsteps(barwidth = unit(5, "in"), 
                                 title.position = "top", title.hjust = 0.5))
```




## Parameters & Environment

The following figures plot the change in Linf and K against the center of biomass values of depth, temp, lat, and lon.

```{r}
#| label: center-bio-estimation


# Group on Common Name and Regime
# run weighted mean/median/sd via biomass_kg
regime_center_bio <- bio_regimes %>% 
  group_by(comname, regime) %>% 
  summarise(
    across(.cols = c(depth = avgdepth,
                     temp = bottemp,
                     lat = decdeg_beglat,
                     lon = decdeg_beglon), 
           .fns = ~ weighted.mean(.x, w = biomass_kg, na.rm = T), 
           .names = "{.col}_mu"),
    .groups = "drop"
  )


# Join the coefficients
coef_and_cbio <- species_coef %>% 
  select(comname, regime, parameter, estimate, converged) %>% 
  pivot_wider(names_from = "parameter", values_from = "estimate") %>% 
  left_join(regime_center_bio, by = c("comname", "regime"))


```

::: panel-tabset

### Depth

```{r}
#| label: center-depth-change-plots

# K
p1 <- ggplot(coef_and_cbio, aes(depth_mu, K)) +
  geom_smooth(
    method = "lm",
    formula = y ~ x,
    color = "gray50") +
  ggforce::geom_link2(
    aes(group = comname,
        alpha = stat(index),
        color = "Transition"),
    color = "black",
    size = 0.75,
    show.legend = FALSE) +
  geom_point(aes(color = regime)) +
  scale_color_gmri() +
  labs(x = "Center of Biomass Depth (m)",
       y = "K",
       color = "Species Center of Biomass")


# Linf
p2 <- ggplot(coef_and_cbio, aes(depth_mu, Linf)) +
  geom_smooth(
    method = "lm",
    formula = y ~ x,
    color = "gray50") +
  ggforce::geom_link2(
    aes(group = comname,
        alpha = stat(index),
        color = "Transition"),
    color = "black",
    size = 0.75,
    show.legend = FALSE) +
  geom_point(aes(color = regime)) +
  scale_color_gmri() +
  labs(x = "Center of Biomass Depth (m)",
       y = "Linf",
       color = "Species Center of Biomass")


p1 | p2
```

### Bottom Temperature

```{r}
#| label: center-temp-change-plots

# K
p1 <- ggplot(coef_and_cbio, aes(temp_mu, K)) +
  geom_smooth(
    method = "lm",
    formula = y ~ x,
    color = "gray50") +
  ggforce::geom_link2(
    aes(group = comname,
        alpha = stat(index),
        color = "Transition"),
    color = "black",
    size = 0.75,
    show.legend = FALSE) +
  geom_point(aes(color = regime)) +
  scale_color_gmri() +
  labs(x = "Center of Biomass Temp (C)",
       y = "K",
       color = "Species Center of Biomass")


# Linf
p2 <- ggplot(coef_and_cbio, aes(temp_mu, Linf)) +
  geom_smooth(
    method = "lm",
    formula = y ~ x,
    color = "gray50") +
  ggforce::geom_link2(
    aes(group = comname,
        alpha = stat(index),
        color = "Transition"),
    color = "black",
    size = 0.75,
    show.legend = FALSE) +
  geom_point(aes(color = regime)) +
  scale_color_gmri() +
  labs(x = "Center of Biomass Temp (c)",
       y = "Linf",
       color = "Species Center of Biomass")

p1 | p2
```

### Latitude

```{r}
#| label: center-lat-change-plots

# K
p1 <- ggplot(coef_and_cbio, aes(lat_mu, K)) +
  geom_smooth(
    method = "lm",
    formula = y ~ x,
    color = "gray50") +
  ggforce::geom_link2(
    aes(group = comname,
        alpha = stat(index),
        color = "Transition"),
    color = "black",
    size = 0.75,
    show.legend = FALSE) +
  geom_point(aes(color = regime)) +
  scale_color_gmri() +
  labs(x = "Center of Biomass Latitude",
       y = "K",
       color = "Species Center of Biomass")


# Linf
p2 <- ggplot(coef_and_cbio, aes(lat_mu, Linf)) +
  geom_smooth(
    method = "lm",
    formula = y ~ x,
    color = "gray50") +
  ggforce::geom_link2(
    aes(group = comname,
        alpha = stat(index),
        color = "Transition"),
    color = "black",
    size = 0.75,
    show.legend = FALSE) +
  geom_point(aes(color = regime)) +
  scale_color_gmri() +
  labs(x = "Center of Biomass Latitude",
       y = "Linf",
       color = "Species Center of Biomass")


p1 | p2
```

### Longitude

```{r}
#| label: center-lon-change-plots


# K
p1 <- ggplot(coef_and_cbio, aes(lon_mu, K)) +
  geom_smooth(
    method = "lm",
    formula = y ~ x,
    color = "gray50") +
  ggforce::geom_link2(
    aes(group = comname,
        alpha = stat(index),
        color = "Transition"),
    color = "black",
    size = 0.75,
    show.legend = FALSE) +
  geom_point(aes(color = regime)) +
  scale_color_gmri() +
  labs(x = "Center of Biomass Longitude",
       y = "K",
       color = "Species Center of Biomass")


# Linf
p2 <- ggplot(coef_and_cbio, aes(lon_mu, Linf)) +
  geom_smooth(
    method = "lm",
    formula = y ~ x,
    color = "gray50") +
  ggforce::geom_link2(
    aes(group = comname,
        alpha = stat(index),
        color = "Transition"),
    color = "black",
    size = 0.75,
    show.legend = FALSE) +
  geom_point(aes(color = regime)) +
  scale_color_gmri() +
  labs(x = "Center of Biomass Longitude",
       y = "Linf",
       color = "Species Center of Biomass")

p1 | p2

```

:::



# Retired Assets:

This section exists to isolate code/analyses that were removed


## Length at Age by Regime

```{r}
#| label: regime-size-plots
#| eval: false

# Distribution of Length/Weight Across Regimes 
plot_regime_sizes <- function(
    spec, 
    var = "length", 
    age_lim = 5, 
    facet_prefix = "Age - ", 
    facet_suffix = ""){
  
  # switches for length or width
  var_col <- switch (var,
    "length" = sym("length_cm"),
    "weight" = sym("indwt"))
  var_lab <- switch (var,
    "length" = "Individual Length (cm)",
    "weight" = "Individual Weight (kg)")
  
  # Add pre/suffix to facet labels
  appender <- function(string, prefix = facet_prefix, suffix = facet_suffix) {
    paste0(prefix, string)}
  
  # Select Ages, Prep data
  size_changes <- bio_regimes %>% 
  filter(
    comname == spec,
    age <= 10) %>% 
  ## Calculate group averages
  group_by(age, regime) %>% 
  mutate(
    median_size = median(!!{{var_col}})) %>% 
    ungroup() 
  
  # Make median dataframe
  median_df <- size_changes %>%
    distinct(age, regime, median_size) %>%
    pivot_wider(names_from = "regime", values_from = "median_size")
  
  # Make Plot
  size_changes %>% 
    mutate(age = fct_rev(factor(age))) %>% 
    ggplot(aes(x = !!{{var_col}})) +
    
    ## distribution
    stat_halfeye(aes(color = regime, 
                     fill = after_scale(color)),
                 slab_alpha = .5, 
                 .width = 0, 
                 trim = T, 
                 shape = 21, 
                 point_colour = "gray25",
                 stroke = 1.6,
                 scale = .86) +
    
    # median line
    geom_segment(
      data = median_df,
      aes(x = `Early Regime`,
          xend = `Warm Regime`,
          y = 0,
          yend = 0),
      size = .8,
      color = "grey25") +
    
    ## median points - not working
    stat_halfeye(aes(color = regime), .width = c(0), slab_fill = NA) +
    facet_grid(age~., labeller = as_labeller(appender), scales = "free_y") +
    scale_color_gmri() + 
    scale_fill_gmri() +
    scale_y_continuous(labels = percent_format()) +
    theme(legend.position = "bottom", 
          strip.text.y = element_text(angle = 0),
          axis.text.y = element_text(size = 8)) +
    labs(x = var_lab,
         y = "Proportion",
         title = spec,
         fill = "Temperature Regime",
         color = "Temperature Regime",
         shape = "Median"
         )
  
}


# Tester: 
# plot_regime_sizes(display_species[[1]], var = "length")
```


::: panelset
```{r, results="asis", fig.height = 8}
#| label: regime-size-panels
#| eval: false

# Loop through the key species:
walk(display_species, plot_panelset, plot_fun = plot_regime_sizes, var = "length")

```
:::

## Weight at Age by Regime

::: panelset
```{r, results="asis", fig.height = 8}
#| label: weight-at-age-panels
#| eval: false

# Loop through the key species:
walk(display_species, plot_panelset, plot_fun = plot_regime_sizes, var = "weight")

```
:::

## Shifts in Growth

```{r}
#| label: growth-curve-shifts
#| fig.height: 8
#| fig.width: 8

# Plot their growth curves
regime_comparison %>% 
  #filter(comname %in% display_species) %>% 
  ggplot(aes(x = age, y = growth_frac)) +
    geom_hline(yintercept = 0, size = 0.5, lty = 2, color = "black") +
    geom_line(aes(group = comname), show.legend = FALSE, size = 1, color = "orange")+
    scale_y_continuous(labels = percent_format()) +
    facet_wrap(~comname, scales = "free_x", ncol = 4) + 
    labs(x = "Age", y = "Shift in Length Moving to Warm Regime", 
         title = "Thermal Regime Impacts on Growth",
         subtitle = "Changes in Size at Age (Warm Regime - Historic Regime)") 
```



```{r}
#| label: data-for-curves
#| eval: false

# Kathy requested the curve data.
# Going to save both the coefficients and the fitted data for all species

write_csv(regime_comparison, here("data/growth_results/growth_regime_fits.csv"))
write_csv(species_coef, here("data/growth_results/growth_regime_coefs.csv"))

```


#### Growth Change Horizons



```{r}
#| label: growth-change-horizons
#| eval: false

# Try horizons
library(ggHoriPlot)


# Filter outliers beyond 5th and 95th quantile
cutpoints <- regime_comparison %>% 
  mutate(
    outlier = between(
      growth_frac,
      quantile(growth_frac, 0.05, na.rm = T)-
        1.5 * IQR(growth_frac, na.rm = T),
      quantile(growth_frac, 0.95, na.rm = T)+
        1.5 * IQR(growth_frac, na.rm = T))) %>% 
  filter(outlier)


# Set origin
ori <- 0


# Manually pick cut points
sca <- seq(-1, 1, length.out = 9)
sca_bins <- str_c(sca[1:(length(sca)-1)], " to ", sca[2:length(sca)], "%")
sca_labels <- rev(sca_bins)


theme_set(theme_bw() + 
            theme(
              # Titles
              plot.title = element_text(hjust = 0, face = "bold", size = 14),
              plot.subtitle = element_text(size = 9),
              plot.caption = element_text(size = 8, margin = margin(t = 20), color = "gray40"),
              plot.margin = unit(c(1, 1, 2, 1), "lines"),
              legend.title = element_text(size = 9),
              legend.text = element_text(size = 9),
              # Axes
              axis.line.y = element_line(color = "black"),
              axis.ticks.y = element_line(), 
              axis.line.x = element_line(color = "black"),
              axis.ticks.x = element_line(), 
              axis.text = element_text(size = 11),
              axis.title = element_text(size = 12),
              rect = element_rect(fill = "transparent", color = "black"),
              # Facets
              strip.text = element_text(color = "white", 
                                        face = "bold",
                                        size = 11),
              strip.background = element_rect(
                color = "#00736D", 
                fill = "#00736D", 
                size = 1, 
                linetype="solid")))


# Plot it all
ggplot(regime_comparison, aes(x = age, y = growth_frac)) +
  geom_horizon(
    aes(age, 
        y = growth_frac,
        fill = ..Cutpoints..), 
    origin = ori, 
    horizonscale = sca) +
  scale_fill_hcl(palette = 'RdBu', reverse = T, labels = sca_labels) +
  facet_grid(comname~.) +
  theme_bw() + 
  scale_x_continuous(limits = c(0,10), expand = expansion(add = c(0, 0))) +
  theme(
    # Titles
    plot.title = element_text(hjust = 0, face = "bold", size = 14),
    plot.subtitle = element_text(size = 9),
    plot.caption = element_text(
      size = 8, 
      margin = margin(t = 20), 
      color = "gray40"),
    plot.margin = unit(c(1, 1, 2, 1), "lines"),
    legend.title = element_text(size = 9),
    legend.text = element_text(size = 9),
    # Axes
    axis.line.y = element_line(color = "black"),
    axis.line.x = element_line(color = "black"),
    axis.ticks.x = element_line(), 
    axis.text = element_text(size = 11),
    axis.title = element_text(size = 12),
    rect = element_rect(fill = "transparent", color = "black"),
    # Facets
    strip.text = element_text(color = "white", 
                              face = "bold",
                              size = 11),
    strip.background = element_rect(
      color = "#00736D", 
      fill = "#00736D", 
      size = 1, 
      linetype="solid"),
    panel.grid = element_blank(),
    panel.spacing.y=unit(0.05, "lines"),
    strip.text.y = element_text(size = 7, angle = 0, hjust = 0, face = "bold"),
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.border = element_blank(),
    legend.position = "left")  +
  labs(x = 'Age', 
       fill = "Change in Body Size at Age") +
  guides(fill = guide_legend(ncol = 1))



```


```{r}
#| results: asis

gmRi::insert_gmri_footer()
```

