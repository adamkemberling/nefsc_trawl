---
title: "Size at Age Regimes"
format: 
  html:
    code-fold: true
    code-tools: true
    df-print: kable
editor: visual
execute: 
  echo: true
  warning: false
  message: false
  fig.height: 6
  fig.width: 6
  fig.align: "center"
  comment: ""
  
---

```{r packages and functions}
#| include = FALSE,
#| echo = FALSE

####  Packages  ####
library(FSAdata)
library(FSA)
library(car)
library(tidyverse)
library(gmRi)
library(targets)
library(scales)
library(patchwork)
library(directlabels)
library(xaringanExtra)
library(ggridges)
library(ggdist)
library(ggforce)
library(geomtextpath)
library(colorspace)

# Set theme
theme_set(theme_gmri())

# Acitvate panelset
xaringanExtra::use_panelset()

# Function to generate panels using a key word and a plot function
plot_panelset <- function(spec, plot_fun, ...) {
  
  # Open panel
  cat("::: {.panel}\n")
  
  # Create header for panel name
  cat("##", spec, "{.panel-name}\n")

  # # Text as a plot description
  # cat("Plot of", spec, "\n")

  # Make plot
  p <- plot_fun(spec, ...)
  print(p)

  # Add linebreak
  cat("\n")

  # Close panel
  cat(":::\n")
}
```



`r gmRi::use_gmri_style_rmd(css_file = "gmri_rmarkdown.css")`

## Comparing Growth Regimes in the NW Atlantic

Recent changes in Gulf stream positioning have altered the relative influences of the Gulf stream and Labrador current on temperature and salinity regimes for the region. Understanding that this new temperature and salinity regime should alter both the energetics of the region as well as food-web dynamics, we seek to identify whether these changes have had a measurable impact on the growth of several groundfish species.


## Temperature Regimes

The change in thermal regimes occurred around 2010. Following this regime change, annual temperatures have been several degrees warmer than the previous 3+ decades.

```{r temp regimes}
# Load the regional temperatures from {targets}
withr::with_dir(rprojroot::find_root('_targets.R'), 
                tar_load(regional_oisst))




# Get regional averages
temp_regimes <- regional_oisst %>% 
  filter(yr > 1981) %>% 
  mutate(regime = ifelse(yr < 2010, "1982-2009 Average", "2010-2021 Average")) %>% 
  group_by(survey_area, regime) %>% 
  mutate(
    survey_area = ifelse(survey_area == "all", "Full Region", survey_area),
    survey_area = factor(survey_area, 
                         levels = c("Full Region", "GoM", "GB", "SNE", "MAB")),
    avg_temp_c = round(mean(sst), 2),
    temp_label = str_c(avg_temp_c, "\u00b0C"),
    avg_anom_c = mean(sst_anom),
    #avg_anom_c = ifelse(regime == "1982-2009 Regime", 0, avg_anom_c),
    x = ifelse(regime == "1982-2009 Average", 1981.5, 2009.5),
    xend = ifelse(regime == "1982-2009 Average", 2009.5, 2021.5),
         ) %>% 
  ungroup()




# Plot how each one exhibits a break in the
temp_regimes %>% 
  filter(survey_area == "Full Region") %>% 
  ggplot( aes(yr, sst_anom)) +
  geom_col(aes(fill = regime),  size = 0.75, alpha = 0.4) +
  scale_fill_gmri() +
  # Using geomtextpath for label
  geom_textpath(
    aes(x = yr, 
        y = avg_anom_c, 
        label = temp_label, 
        linecolor = regime,
        colour = regime), 
        size = 4, vjust = -1, fontface = "bold", show.legend = FALSE) +
  # Line segments for the regime averages:
  geom_segment(
    aes(x = x, 
        xend = xend,
        y = avg_anom_c, 
        yend = avg_anom_c,
        color = regime),
    size = .8,
    linetype = 1) +
  scale_x_continuous(expand = expansion(add = c(0.25,0.25))) +
  scale_y_continuous(labels = number_format(suffix = " \u00b0C")) +
  scale_color_gmri() +
  guides(fill = "none") +
  theme(
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.background = element_rect(fill = "transparent"),
    legend.key = element_rect(fill = "transparent", color = "transparent")) + 
  labs(
    title = "Northwest-Atlantic Temperature Regime Shift",
    x = "", 
    y = "Surface Temperature Anomaly",
    caption = "Anomalies calculated using 1982-2011 reference period.") +
  guides(label = "none")
   
```

## Groundfish Biological Data

The data on groundfish size-at-age is obtained as part of the NEFSC's northeast trawl survey. The age data specifically is a subset of the overall catch data, the biological dataset, which contains additional information on individuals such as age/sex/histology.

```{r bio data prep}
# Access Biological Data with {targets}
withr::with_dir(rprojroot::find_root('_targets.R'), 
                tar_load(survdat_biological))

# 1. Prepare Bio Data for Age analysis for regimes:

# Drop NA age data, restrict to summer and fall
nmfs_bio <- survdat_biological %>%
  filter(is.na(age) == FALSE,
         season %in% c("Summer", "Fall"))%>% 
      as.data.frame()
  

#Add regime and decade labels
nmfs_bio <- nmfs_bio %>% 
  mutate(
    yearclass = est_year - (age-1),
    regime = ifelse(est_year < 2010, "Early Regime", "Warm Regime"),
    decade = floor_decade(est_year)) 

rm(survdat_biological)
```


### Studying Regimes

To ensure enough age data is available for deriving growth characteristics, the data is grouped into regimes that match the regional temperature regimes. Despite these species living at or near the bottom, research suggests that the forces driving these thermal regimes would have far-reaching impacts biological impacts. These impacts may directly change the near-bottom environment through mixing patterns, and/or indirectly through food-web impacts.

Through this lens we will assess changes to body size, size-at-age, and growth characteristics derived using the von-bertalanffy growth equation.

```{r year filter}
# Filter to just the data for the two regimes
regime_dat <- filter(nmfs_bio, est_year >= 2000, est_year <= 2019)

```

### Species Selected

The biological data is then separated into lists organized by species. The lists contain all data for a given species, broken into groups at a set interval of time. In this case it is ten-year thermal regimes we seek to compare.

In the original proposal it was stated that 17 species would be used, species that are regularly measured and aged. Ordering all species by the number aged we can pull out the following top species:

```{r vbert species selection}
####  Data Prep  #### 

# Rank species by how many measurements there are
species_abunds <- regime_dat %>% 
  count(comname) %>% 
  arrange(desc(n)) # ordered by number measured

# Reorder alphabetically
vonbert_species <- sort(species_abunds$comname[1:17])
```

These will be the species that we assess length-at-age characteristics for our meta-analysis:

**`r pander::pander(vonbert_species)`.**

Unfortunately; despite being major players in the regions ecology, age data is not available for spiny dogfish and other elasmobranch species.

```{r panel species}

# Name the list so it carries through
names(vonbert_species) <- vonbert_species


##### Pull species data into the list, and make group id for later
all_vonbert <-  map_dfr(vonbert_species, function(species_name){
  # Filter to the vonbert species
  regime_dat %>%
    filter(comname == species_name) %>% 
    mutate(group_id = str_c(regime, comname, sep = "-")) 
}, .id = "common name") 


# Species we want panels for:
key_species <- sort(c(
  "american plaice",
  "atlantic cod",
  "atlantic herring",
  "butterfish",
  "haddock", 
  "pollock",
  "scup",
  "silver hake",
  "summer flounder",
  "winter flounder",
  "yellowtail flounder"
))
```



### Growth Increment Estimation


One aspect of growth beyond size-at-age is the annual growth between years of a specific age, or the growth increment. 

```{r}

# Age-Size Increments Differences
vb_incs <- all_vonbert %>% 
  group_by(`common name`, est_year,  age, regime) %>% 
  summarise(avg_len = mean(length_cm, na.rm = T),
            avg_wt  = mean(indwt, na.rm = T),
            .groups = "drop") %>% 
  arrange(`common name`, age) %>% 
  group_split(`common name`, est_year) %>% 
  map_dfr(function(x){
    x %>% 
      mutate(
        # What age is being subtracted from
        lead_age   = lead(age, n = 1),
        # String built from the value to confirm
        diff_name  = str_c(age, " - ", lead_age),
        # Length/Weight at age + 1
        len_age_p1 = lead(avg_len, n = 1),
        wt_age_p1  = lead(avg_wt, n = 1),
        # Length/Weight Growth Increments
        len_inc    = len_age_p1 - avg_len,
        wt_inc     = wt_age_p1 - avg_wt,
        # Percent change in bodymass for going from age to age+1
        len_perc_change = (len_inc / avg_len) * 100,
        wt_perc_change = (wt_inc / avg_wt) * 100) %>% 
      filter((lead_age - age == 1))
  })


```


## Age Data Frequencies

Just looking at the raw data available, it becomes obvious that there are differences in the number of fish at various ages through time. 

With cases of large cohorts passing through, or older individuals being caught less frequently. Particularly large cohorts of haddock are a good example.


```{r ridgeplot fun}
# Plotting age distribution as ggridges
plot_age_ridgeplot <- function(species){
  all_vonbert %>% 
    filter(comname == species,
           age <= 15) %>% 
    mutate(yr = factor(est_year),
           yr = fct_rev(yr)) %>% 
    ggplot(aes(x = age, y = yr)) +
      geom_density_ridges(aes(fill = regime), color = "white", show.legend = FALSE) +
      scale_fill_gmri() +
      facet_wrap(~comname) +
      scale_x_continuous(limits = c(0,NA), 
                         expand = expansion(add = c(0, 0))) +
      labs(x = "Age", y = "Year") +
      guides(size = guide_legend(title.position = "top", title.hjust = 0.5))
  
}
```

::::: {.panelset}

```{r ridge panels, results="asis", fig.height=8}

# Loop through the key species:
walk(key_species, plot_panelset, plot_fun = plot_age_ridgeplot)

```

:::::

# Growth Increment Changes

```{r}

# Put together a timeseries of:
# how big were the age 0's,
# how big were the age 1's

# Plotting Age Increments
plot_age_increments <- function(
    spec_choice, 
    var_choice = "length", 
    gam_knots = 15, 
    facet_prefix = "Age Increment: ",
    facet_suffix = ""){
  
# Code to switch variables and their labels:
  var_sym <- switch(var_choice,
    "length" = sym("len_inc"),
    "weight" = sym("wt_inc"))
  var_label <- switch(var_choice,
                      "length" = "Annual Growth  (cm)",
                      "weight" = "Annual Growth  (kg)")
  
  
  # Add pre/suffix to facet labels
  appender <- function(string, prefix = facet_prefix, suffix = facet_suffix) {
    paste0(prefix, string)}

  # Make the plot
  vb_incs %>% 
    filter(`common name` == spec_choice,
           lead_age <= 5) %>% 
    drop_na({{var_sym}}) %>% 
    ggplot(aes(est_year, {{var_sym}})) +
      # geom_col(fill = gmri_cols("gmri blue")) +
      geom_point(color = gmri_cols("gmri blue")) +
      geom_line(color = gmri_cols("gmri blue"), group = 1, alpha = 0.3, size = 0.8) +
      geom_smooth(method = "gam",
                  formula = y ~ s(x, bs = "cs", k = gam_knots),
                  se = FALSE,
                  size = 1,
                  color = gmri_cols("orange")) +
      facet_wrap(~diff_name, ncol = 1, scales = "free",
                 labeller = as_labeller(appender))  +
      theme(legend.position = "bottom") +
      labs(x = "",
           y = var_label,
           color = "Age Increment",
           title = str_to_title(spec_choice),
           subtitle = str_c("Changes in annual ", var_choice, " growth increments."))

}

```



::::: {.panelset}

```{r, results="asis", fig.height = 8}

# Loop through the key species:
walk(key_species, plot_panelset, plot_fun = plot_age_increments, var_choice = "weight", gam_knots = 5)

```

:::::



# Length at Age Changes



```{r regime size plots}

# Distribution of Length/Weight Across Regimes 
plot_regime_sizes <- function(spec, var = "length", age_lim = 5, facet_prefix = "Age - ", facet_suffix = ""){
  
  # switches for length or width
  var_col <- switch (var,
    "length" = sym("length_cm"),
    "weight" = sym("indwt"))
  var_lab <- switch (var,
    "length" = "Individual Length (cm)",
    "weight" = "Individual Weight (kg)")
  
  # Add pre/suffix to facet labels
  appender <- function(string, prefix = facet_prefix, suffix = facet_suffix) {
    paste0(prefix, string)}
  
  # Select Ages, Prep data
  size_changes <- regime_dat %>% 
  filter(
    comname == spec,
    age <= 6) %>% 
  ## Calculate group averages
  group_by(age, regime) %>% 
  mutate(
    median_size = median(!!{{var_col}})) %>% 
    ungroup() 
  
  # Make median dataframe
  median_df <- size_changes %>%
    distinct(age, regime, median_size) %>%
    pivot_wider(names_from = "regime", values_from = "median_size")
  
  # Make Plot
  size_changes %>% 
    ggplot(aes(x = !!{{var_col}})) +
    
    ## distribution
    stat_halfeye(aes(color = regime, 
                     fill = after_scale(color)),
                 slab_alpha = .5, 
                 .width = 0, 
                 trim = T, 
                 shape = 21, 
                 point_colour = "gray25",
                 stroke = 1.6,
                 scale = .86) +
    
    # median line
    geom_segment(
      data = median_df,
      aes(x = `Early Regime`,
          xend = `Warm Regime`,
          y = 0,
          yend = 0),
      size = .8,
      color = "grey25", # , position = position_nudge(y = -.15)
    ) +
    
    ## median points - not working
    stat_halfeye(aes(color = regime), .width = c(0), slab_fill = NA) +
    
   
    facet_wrap(~age, ncol = 1, 
               labeller = as_labeller(appender), scales = "free") +
    scale_color_gmri() + 
    scale_fill_gmri() +
    scale_y_continuous(labels = percent_format()) +
    theme(legend.position = "bottom") +
    labs(x = var_lab,
         y = "Proportion",
         title = spec,
         fill = "Temperature Regime",
         color = "Temperature Regime",
         shape = "Median"
         )
  
  
}


# Tester: 
# plot_regime_sizes(key_species[[1]], var = "length")
```


::::: {.panelset}

```{r, results="asis", fig.height = 8}

# Loop through the key species:
walk(key_species, plot_panelset, plot_fun = plot_regime_sizes, var = "length")

```

:::::

# Weight at Age Changes


::::: {.panelset}

```{r, results="asis", fig.height = 8}

# Loop through the key species:
walk(key_species, plot_panelset, plot_fun = plot_regime_sizes, var = "weight")

```

:::::

# Changes in Growth

Growth in fishes is commonly modeled using the "Von-Bertalanffy" growth function to capture how a fishes size (length or weight) changes with age. To give a coarse glimpse into how this relationship may have changed over time we can look at how the parameters have changed between regimes.

```{r}
# Set the function for nls() to solve
vb <- vbFuns(param="Typical") 


# Function to Pull Vonbert Coefficients
vonbert_coef <- function(length_age_dat, start_points, min_obs = 20){
  
  # Von Bert Fitting Using: {FSA}
  # Don't run on fewer than a minimum number of observations
  num_aged <- nrow(length_age_dat)
  if(num_aged < min_obs){
    na_df <- data.frame("Linf" = NA, 
                        "K" = NA, 
                        "t0" = NA)
    return(na_df)
  }
  
  # Use nls to estimate VBGF parameters using starting points
  vbert_fit <- nls(length_cm ~ vb(age, Linf, K, t0), 
                   data = length_age_dat, 
                   start = start_points)
  
  # Access parameters with coef()
  # Estimate sizes at age
  vbert_coef <- as.data.frame(t(coef(vbert_fit)))
  return(vbert_coef)
  
}
```


```{r}
# Second Function for running that for a single Species, split by a factor column
species_vonbert <- function(spec, split_col, min_obs){
  
  spec_dat <- filter(all_vonbert, comname == spec)
  
  # Get starting points from all data
  test_starts <-  vbStarts(length_cm ~ age, 
                           data = spec_dat)
  
  # Get coefficients for groups
  spec_dat %>% 
    split(.[split_col]) %>% 
    map_dfr(vonbert_coef, test_starts, min_obs = min_obs, .id = split_col) %>% 
    mutate(comname = spec)
}

```

Once everything is prepped we can then fun the von Bert parameter estimation for all the species we are interested using the desired groups.

```{r, fig.height = 6}

# Running everything?
#species_coef <- key_species %>% 
species_coef <- vonbert_species %>% 
  map_dfr(.f = species_vonbert, 
          split_col =  "regime", 
          min_obs = 30)

# Plotting Everything
species_coef %>%
  pivot_longer(names_to = "vbcoef", values_to = "val", cols = c("K", "Linf", "t0")) %>% 
  filter(vbcoef != "t0") %>% 
  ggplot(aes(x = val, y = fct_rev(comname), fill = fct_rev(regime))) +
    geom_col(position = "dodge") +
    facet_wrap(~vbcoef, scales = "free_x") +
    scale_fill_gmri(reverse = T) +
    labs(x = "Coefficient Estimate", y = "", fill = "Temperature Regime:") +
  theme(legend.position = "bottom", 
        panel.background = element_rect(color = "gray80", fill = "transparent", size = 1),
        panel.spacing = unit(2, "lines"),
        panel.border = element_rect(color = "gray80", fill = "transparent", size = 1))
```


# Growth Curves

# VB Fits to Data:

```{r}

# Make the plot for each species
vb_fits_plot = function(spec_name){
    
  # The raw size/age data:
  t_dat <- all_vonbert %>% filter(comname == spec_name)  
  
  # The group coefficients, augmented with x values across a range
  age_max <- max(t_dat$age)
  x_range <- seq(from = 0, to = age_max, by = .1)
  t_coef <- species_coef %>% 
    filter(comname == spec_name) %>% 
    right_join(
      y = data.frame(
        regime = rep(unique(t_dat$regime), length(x_range)),
        age = rep(x_range, length(unique(t_dat$regime)))),
      by = "regime") %>% 
    mutate(
      # Calculate the length at age
      pred_length = Linf * (1  - exp(-1 * K * (age - t0)))
    )
  
  
  # Make plot?
  ggplot(t_dat, aes(x = age, y = length_cm)) +
    geom_point(alpha = 0.25) +
    #facet_wrap(~regime, ncol = 1) +
    geom_line(data = t_coef,
              aes(x = age, y = pred_length, group = regime, color = regime), 
              size = 1) +
    scale_x_continuous(breaks = seq(0, age_max, by = 2),
                       limits = c(0, age_max),
                       expand = expansion(mult = c(0.1, .2))) +
    scale_color_gmri() +
    geom_dl(data = t_coef, 
            aes(x = age, y = pred_length, label = regime, color = regime), 
            method= list("last.qp", cex = 0.65, hjust = -.15),
            size = 12) +
    labs(x = "Age",
         y = "Length (cm)",
         title = spec_name,
         color = "Temperature Regime:",
         subtitle = "Length at Age Regimes")

    
  }
```

::::: {.panelset}

```{r, results="asis", fig.height = 6}

# Loop through the key species:
walk(key_species, 
     plot_panelset, 
     plot_fun = vb_fits_plot)

```

:::::

# Shifts in Growth


Goal is to find some way to show all of them together in one form:


```{r}
#| fig.height = 8,
#| fig.width = 8

# Take the first part from the previous plot:
# takes each species
# for age 0 - max_age, solve what the size would be based on vb fit
regime_curve_prep <- function(spec_name){
  
  # The raw size/age data:
  t_dat <- all_vonbert %>% filter(comname == spec_name)  
  
  # The group coefficients, augmented with x values across a range
  age_max <- max(t_dat$age)
  x_range <- seq(from = 0, to = age_max, by = .1)
  t_coef <- species_coef %>% 
    filter(comname == spec_name) %>% 
    right_join(
      y = data.frame(
        regime = rep(unique(t_dat$regime), length(x_range)),
        age = rep(x_range, length(unique(t_dat$regime)))),
      by = "regime") %>% 
    mutate(
      # Calculate the length at age
      pred_length = Linf * (1  - exp(-1 * K * (age - t0)))
    )
  
  # Pivot wider?
  # Take the size at age from each regime and get the difference
  t_coef <- t_coef %>%
    select(-c(Linf, K, t0)) %>% 
    pivot_wider(names_from = "regime", values_from = "pred_length") %>%
    mutate(
      growth_shift = `Warm Regime` - `Early Regime`,
      growth_frac = (growth_shift / `Early Regime`),
      size_change  = ifelse(growth_shift > 0, "Increase", "Decrease")
    )
  
  return(t_coef)
  
}


# Do it for all the species
regime_comparison <- vonbert_species %>% 
  map_dfr(.f = regime_curve_prep, .id = "comname") 

# Plot their growth curves
regime_comparison %>% 
  #filter(comname %in% key_species) %>% 
  ggplot(aes(x = age, y = growth_frac)) +
    geom_hline(yintercept = 0, size = 0.5, lty = 2, color = "black") +
    geom_line(aes(group = comname), show.legend = FALSE, size = 1, color = "orange")+
    scale_y_continuous(labels = percent_format()) +
    facet_wrap(~comname, scales = "free_x", ncol = 4) + 
    labs(x = "Age", y = "Shift in Length Moving to Warm Regime", 
         title = "Thermal Regime Impacts on Growth",
         subtitle = "Changes in Size at Age (Warm Regime - Historic Regime)") 
```


```{r}
#| eval = FALSE

# Kathy requested the curve data.
# Going to save both the coefficients and the fitted data for all species
library(here)
write_csv(regime_comparison, here("data/growth_results/growth_regime_fits.csv"))
write_csv(species_coef, here("data/growth_results/growth_regime_coefs.csv"))

```



```{r}
# Try horizons
library(ggHoriPlot)


# Filter outliers beyond 5th and 95th quantile
cutpoints <- regime_comparison %>% 
  mutate(
    outlier = between(
      growth_frac,
      quantile(growth_frac, 0.05, na.rm = T)-
        1.5 * IQR(growth_frac, na.rm = T),
      quantile(growth_frac, 0.95, na.rm = T)+
        1.5 * IQR(growth_frac, na.rm = T))) %>% 
  filter(outlier)


# Set origin
ori <- 0


# Manually pick cut points
sca <- seq(-1, 1, length.out = 9)
sca_bins <- str_c(sca[1:(length(sca)-1)], " to ", sca[2:length(sca)], "%")
sca_labels <- rev(sca_bins)


theme_set(theme_bw() + 
            theme(
              # Titles
              plot.title = element_text(hjust = 0, face = "bold", size = 14),
              plot.subtitle = element_text(size = 9),
              plot.caption = element_text(size = 8, margin = margin(t = 20), color = "gray40"),
              plot.margin = unit(c(1, 1, 2, 1), "lines"),
              legend.title = element_text(size = 9),
              legend.text = element_text(size = 9),
              # Axes
              axis.line.y = element_line(color = "black"),
              axis.ticks.y = element_line(), 
              axis.line.x = element_line(color = "black"),
              axis.ticks.x = element_line(), 
              axis.text = element_text(size = 11),
              axis.title = element_text(size = 12),
              rect = element_rect(fill = "transparent", color = "black"),
              # Facets
              strip.text = element_text(color = "white", 
                                        face = "bold",
                                        size = 11),
              strip.background = element_rect(
                color = "#00736D", 
                fill = "#00736D", 
                size = 1, 
                linetype="solid")))


# Plot it all
ggplot(regime_comparison, aes(x = age, y = growth_frac)) +
  geom_horizon(
    aes(age, 
        y = growth_frac,
        fill = ..Cutpoints..), 
    origin = ori, 
    horizonscale = sca) +
  scale_fill_hcl(palette = 'RdBu', reverse = T, labels = sca_labels) +
  facet_grid(comname~.) +
  theme_bw() + 
  scale_x_continuous(limits = c(0,10), expand = expansion(add = c(0, 0))) +
  theme(
    # Titles
    plot.title = element_text(hjust = 0, face = "bold", size = 14),
    plot.subtitle = element_text(size = 9),
    plot.caption = element_text(
      size = 8, 
      margin = margin(t = 20), 
      color = "gray40"),
    plot.margin = unit(c(1, 1, 2, 1), "lines"),
    legend.title = element_text(size = 9),
    legend.text = element_text(size = 9),
    # Axes
    axis.line.y = element_line(color = "black"),
    axis.line.x = element_line(color = "black"),
    axis.ticks.x = element_line(), 
    axis.text = element_text(size = 11),
    axis.title = element_text(size = 12),
    rect = element_rect(fill = "transparent", color = "black"),
    # Facets
    strip.text = element_text(color = "white", 
                              face = "bold",
                              size = 11),
    strip.background = element_rect(
      color = "#00736D", 
      fill = "#00736D", 
      size = 1, 
      linetype="solid"),
    panel.grid = element_blank(),
    panel.spacing.y=unit(0.05, "lines"),
    strip.text.y = element_text(size = 7, angle = 0, hjust = 0, face = "bold"),
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.border = element_blank(),
    legend.position = "left")  +
  labs(x = 'Age', 
       fill = "Change in Body Size at Age") +
  guides(fill = guide_legend(ncol = 1))



```

# All Age Size Differences

```{r}
#| eval = TRUE,
#| fig.height = 2

# Try geom_waffle to just count each species as an individual and show that they are growing to smaller sizes in new regime:
library(ggwaffle)
ggplot(data = waffle_iron(
  data = filter(regime_comparison, age == 5), 
  aes_d(group = size_change), rows = 2), 
         aes(x, y, fill = fct_rev(group))) +
  geom_waffle() +
  theme_waffle() +
  scale_fill_gmri() +
  theme(axis.text = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        legend.title = element_text(face = "bold", size = 12),
        legend.position = "bottom",
        panel.grid.major.y = element_blank()) +
  labs(x = "", y = "", fill = "Warm Regime Impact on Age 5 Body Length:")

```



# Average Body Sizes
 

`r insert_gmri_footer()`
