---
title: "NEFSC Trawl Size at Age Distribution"
description: |
  Looking at how size at age has changed across the New England groundfish community
author: "Adam A. Kemberling"
date: "`r Sys.Date()`"
output:
  distill::distill_article:
    self_contained: false
    code_folding: hide
    highlight: haddock
    highlight_downlit: true
    toc: true
---

```{r setup, include=FALSE}

# Chunk Options
knitr::opts_chunk$set(echo = TRUE, 
                      message = F, 
                      warning = F, 
                      comment = "", 
                      fig.height = 6, 
                      fig.width = 6)


####  Packages  ####
library(lme4)
library(DT)
library(FSAdata)
library(FSA)
library(car)
library(tidyverse)
library(gmRi)
library(targets)
library(ggridges)
library(patchwork)
library(nlme)
library(directlabels)



# Set theme
theme_set(theme_gmri())

# Load xaringanExtra
library(xaringanExtra)

# Acitvate panelset
xaringanExtra::use_panelset()


```

`r use_gmri_style_rmd(css_file = "gmri_rmarkdown.css")`

# Exploring Size-at-age Changes

This report digs into changes in size with age using biological data from the NMFS bottom trawl survey. This dataset is a subset of the groundfish trawl survey's total catch.

The subset is saved while at sea to be brought back for additional workout for things like aging or histology. Because these fishes are worked up at an individual level they have additional data than is otherwise available from the general survey catch data.

Because this is a subset of the full catch data, this information is better at size-at-age analysis and not suited for size-frequency information.


## Load/Prep Bio Data

The biological data has its own target, but is loaded from box using the `{gmRi}` package just like the catch data, pulling the data off our shared cloud storage.

```{r}
# Access Biological Data with {gmRi}
# nmfs_bio <- gmRi::gmri_survdat_prep(survdat_source = "bio")
withr::with_dir(rprojroot::find_root('_targets.R'), 
                tar_load(survdat_biological))
```

### Year Groupings

For some of the analyses below the data are grouped into 5-year increments to ensure that there is enough data at-age that might be sparse for any single given year. The function to apply these labels is below:


```{r}
# 1. Make 5 year increments
bio_5yr_prep <- function(survdat_biological){
  
  # Drop NA age data, restirct to summer and fall
  nmfs_bio <- survdat_biological %>% 
  filter(is.na(age) == FALSE,
         season %in% c("Summer", "Fall"))
  
  yr5_breaks <- seq(1970, 2020, by = 5)
  yr5_ends <- seq(1974, 2024, by = 5)
  yr5_labels <- str_c(yr5_breaks, "-", yr5_ends)
  yr5_labels <- yr5_labels[1:(length(yr5_labels)-1)]


  #Add 5-year groups, decade labels
  nmfs_bio <- nmfs_bio %>% 
    mutate(
      yearclass = est_year - (age-1),
        five_yr_group = cut(
          est_year, 
          breaks = yr5_breaks, 
          labels = yr5_labels,
          include.lowest = TRUE,
          ordered_result = TRUE),
        decade = floor_decade(est_year)) %>% 
    as.data.frame()
}
```

Following this step the biological data is now ready for looking at individual years, cohorts, or five-year groups.

```{r}
# run cleanup
nmfs_bio <- bio_5yr_prep(survdat_biological = survdat_biological)


```

### Species Selection

In the original proposal it was stated that 17 species would be used, species that are regularly measured and aged. Ordering all species by the number aged we can pull out the following top species:


```{r}
####  Data Prep  #### 

# Rank species by how many measurements there are
species_abunds <- nmfs_bio %>% 
  count(comname) %>% 
  arrange(desc(n)) # ordered by number measured

# Reorder alphabetically
vonbert_species <- sort(species_abunds$comname[1:17])
```

These will be the species that we assess length-at-age characteristics for: **`r pander::pander(vonbert_species)`**

### Survey Seasons

We care about data from the two main survey seasons, so we limit the data to just those seasons before splitting it out into lists for each species. The lists contain all data for a given species, broken into groups at a set interval of time. In this case it is five year increments.

```{r}
# Name the list so it carries through
names(vonbert_species) <- vonbert_species


# Does not work for because of bad start points or no age data:
# skates, dogfish, fourspot flounder, goosefish


##### Pull species data into the list, and make group id for later
species_data <- map(vonbert_species, function(species_name){
  
  # Drop NA ages, set increment labels
  nmfs_bio %>%
    filter(comname == species_name) %>% 
    mutate(group_id = str_c(est_year, comname, sep = "-")) 
})


```




## Age Data Availability

The availability of data for fitting growth curves varies by species & sex for the different seasons and years of the survey. Some species are much longer lived and have a larger age range that may be difficult to accurately fit without good representation in the data.

```{r, fig.height = 12}

# Check Age Data Availability
all_vonbert <- bind_rows(species_data, .id = "common name") 

# Make summary table
all_vonbert %>% 
  group_by(comname, decade) %>% 
  summarise(
    number_aged = n(),
    min_age = min(age),
    max_age = max(age),
    age_range = max_age - min_age,
    num_per_age = number_aged / age_range,
    .groups = "drop") %>% 
  mutate(across(where(is.numeric), round, 1),
         age_range = NULL) %>% 
  setNames(
    c("Common Name", "Decade", "# Aged", 
      "Age Min", "Age Max", "Avg. Fish / Age")) %>% 
  DT::datatable()


```

#### Growth Increment Calculation

One aspect of growth beyond size-at-age is the annual growth between years of a specific age, or the growth increment. 

```{r}
# Age-Size Increments Differences
vb_incs <- all_vonbert %>% 
  group_by(`common name`, est_year,  age) %>% 
  summarise(avg_len = mean(length_cm, na.rm = T),
            avg_wt = mean(biomass_kg, na.rm = T),
            .groups = "drop") %>% 
  arrange(`common name`,age) %>% 
  group_split(`common name`, est_year) %>% 
  map_dfr(function(x){
    x %>% 
      mutate(
        lead_age   = lead(age, n = 1),
        diff_name  = str_c(age, " - ", lead_age),
        len_age_p1 = lead(avg_len, n = 1),
        wt_age_p1  = lead(avg_wt, n = 1),
        len_inc    = len_age_p1 - avg_len,
        wt_inc     = wt_age_p1 - avg_wt) %>% 
      filter((lead_age - age == 1))
  })


```

# Raw Data Exploration

Before fitting anything, let's first look at how the size at age and growth increments look visually. To avoid plot overload the focus will be on 5 main species that have a high ecological or commercial significance.

```{r}
# Species we want panels for:
key_species <- sort(c(
  "atlantic cod",
  "haddock", 
  "acadian redfish",
  "silver hake",
  "winter flounder"
))
```



## Decadal Size at Age Changes

From the raw data we have measurements of individuals sampled and the age that they were later given by otolith readers. Without needing to fir growth curves we can look at how these sizes change over the years:

```{r}
# Plotting a species changing weight at age:
saa_boxplot <- function(comname_select, age_cutoff = 8){
  
  #tester: comname <- "haddock"
  
  # Pull species
  this_species <- all_vonbert %>% 
  filter(comname == comname_select) %>% 
    mutate(decade = str_c(decade, "'s")) %>% 
    filter(est_year >= 1990,
           age <= age_cutoff) %>% 
    mutate(age = fct_drop(factor(age)))
  
  # Set var and label
 
  
  
  # Build Plot for decades as box-whisker
  len_plot <- ggplot(this_species) +
    geom_boxplot(aes(age, length_cm, fill = decade), position = "dodge",
                 width = .5, alpha = 0.4,
                 outlier.colour = NA) +
    scale_fill_gmri() + 
    theme(legend.position = "none") +
    labs(x = "Age", y = "Length (cm)", 
         fill = "Decadal Distribution",
         title = str_to_title(comname_select),
         subtitle = "Decadal Change to Size at Age")
  
  # Build Plot for decades as box-whisker
  wt_plot <- ggplot(this_species) +
    geom_boxplot(aes(age, indwt, fill = decade), position = "dodge",
                 width = .5, alpha = 0.4,
                 outlier.colour = NA) +
    scale_fill_gmri() +
    theme(legend.position = "bottom") +
    labs(x = "Age", y = "Weight (kg)", 
         fill = "Decadal Distribution")
  
  return(len_plot / wt_plot)
  
 
  
}

# Function to make panels for it:
# Make the panels
saa_panel <- function(spec) {
  
  # Open panel
  cat("::: {.panel}\n")

  # Create header for panel name
  cat("##", spec, "{.panel-name}\n")

  # # Text as a plot description
  # cat("Plot of", spec, "\n")

  # Make plot
  p <- saa_boxplot(comname_select = spec)
  print(p)

  # Add linebreak
  cat("\n")

  # Close panel
  cat(":::\n")
}
```


::::: {.panelset}

```{r, results="asis", fig.height=8}
# Loop through the key species:
walk(key_species, saa_panel)

```

:::::



## Size at Age Trends


```{r}

# Plot individual Sizes and the trends with them:
plot_raw_saa <- function(spec_choice, gam_knots = 15, var_choice, facet_prefix = "Age: ", facet_suffix){
  
  # Code to switch variables and their labels:
  var_sym <- switch(var_choice,
    "length" = sym("length_cm"),
    "weight" = sym("indwt"))
  var_label <- switch(var_choice,
                      "length" = "Length (cm)",
                      "weight" = "Weight (kg)")
  
  
  # Add pre/suffix to facet labels
  appender <- function(string, prefix = facet_prefix, suffix = facet_suffix) {
    paste0(prefix, string)
    }
  
  # Plot them
  all_vonbert %>% 
    filter(`common name` == spec_choice,
           age <= 5) %>%
    drop_na({{var_sym}}) %>% 
    ggplot(aes(est_year, y = {{var_sym}} )) +
    geom_point(alpha = 0.3) +
    geom_smooth(method = "gam",
                formula = y ~ s(x, bs = "cs", k = gam_knots),
                size = 1,
                color = gmri_cols("orange"),
                se = FALSE) +
    facet_wrap(~age, ncol = 1, scales = "free",
               labeller = as_labeller(appender)) +
    labs(
      x = "Year",
      y = var_label,
      title = str_to_title(spec_choice),
      subtitle = str_c("Changes in ", var_choice, " at age."))
  
}

# Function to make panels for it:
# Make the panels
raw_saa_panel <- function(spec) {
  
  # Open panel
  cat("::: {.panel}\n")

  # Create header for panel name
  cat("##", spec, "{.panel-name}\n")

  # # Text as a plot description
  # cat("Plot of", spec, "\n")

  # Make plot
  p <- plot_raw_saa(spec_choice = spec, var_choice = "length")
  print(p)

  # Add linebreak
  cat("\n")

  # Close panel
  cat(":::\n")
}
```


::::: {.panelset}

```{r, results="asis", fig.height=8}
# Loop through the key species:
walk(key_species, raw_saa_panel)
```

:::::



## Growth Increment Trends

```{r}

# Put together a timeseries of:
# how big were the age 0's,
# how big were the age 1's


# Plotting Age Increments
plot_age_increments <- function(spec_choice, var_choice = "length", gam_knots = 15, facet_prefix = "Age Increment: "){
  



# Code to switch variables and their labels:
  var_sym <- switch(var_choice,
    "length" = sym("len_inc"),
    "weight" = sym("wt_inc"))
  var_label <- switch(var_choice,
                      "length" = "Annual Growth  (cm)",
                      "weight" = "Annual Growth  (kg)")
  
  
  # Add pre/suffix to facet labels
  appender <- function(string, prefix = facet_prefix, suffix = facet_suffix) {
    paste0(prefix, string)}

  # Make the plot
  vb_incs %>% 
    filter(`common name` == spec_choice,
           lead_age <= 4) %>% 
    drop_na({{var_sym}}) %>% 
    ggplot(aes(est_year, {{var_sym}})) +
    geom_point() +
    geom_smooth(method = "gam",
                formula = y ~ s(x, bs = "cs", k = gam_knots),
                se = FALSE,
                size = 1,
                color = gmri_cols("orange")) +
    facet_wrap(~diff_name, ncol = 1, scales = "free",
               labeller = as_labeller(appender))  +
    theme(legend.position = "bottom") +
    labs(x = "",
         y = var_label,
         color = "Age Increment",
         title = str_to_title(spec_choice),
         subtitle = str_c("Changes in annual ", var_choice, " growth increments."))

}

# Function to make panels for it:
# Make the panels
increments_panel <- function(spec) {
  
  # Open panel
  cat("::: {.panel}\n")

  # Create header for panel name
  cat("##", spec, "{.panel-name}\n")

  # # Text as a plot description
  # cat("Plot of", spec, "\n")

  # Make plot
  p <- plot_age_increments(spec_choice = spec)
  print(p)

  # Add linebreak
  cat("\n")

  # Close panel
  cat(":::\n")
}
```

::::: {.panelset}

```{r, results="asis", fig.height=8}

# Loop through the key species:
walk(key_species, increments_panel)

```

:::::




## Growth Horizons

This was just an idea and has not been fleshed out:

```{r}
# Idea:
# Set each year or yearclass as weight anomalies from the all-year averages
# then use horizon plots to show how much bigger/smaller the age classes are against that long-term average

# W/ that idea will probably just want all that data in a table
```







---

# 5-year Periods Von Berts

The Von-Bertalanffy parameterization used is the "Typical" von Bertalanffy parameterization, also known as the Beverton-Holt parameterization, which is implemented using the {FSA} package.

We can check that this is the case by displaying the equations:

```{r, fig.height=2, eval = TRUE}
# "typical" von bert
typical <- growthFunShow(param = "Typical", "vonBertalanffy")
typical_plot <- ggplot() +
  annotate(x = 1, y = 1, label = typical, geom = "text", size = 6) +
  labs(title = '"Typical" Parameterization') + 
  theme_void()


bholt <- growthFunShow(param = "BevertonHolt", "vonBertalanffy")
bholt_plot <- ggplot() +
  annotate(x = 1, y = 1, label = bholt, geom = "text", size = 6) +
  labs(title = '"Beverton-Holt" Parameterization') + 
  theme_void()

typical_plot | bholt_plot
```

To start things off we first set the von Bert parameterization to solve using nonlinear least squares: `nls()`

```{r}
( vb <- vbFuns(param="Typical") )
```

Then once we have set that as the function we want to use, we can write a wrapper around it that will take input length and age data, some reasonable parameter starting points, and some minimum number of observations that we set to make sure groups with very few aged fish don't break the workflow.

```{r}
# Function to Pull Vonbert Coefficients
vonbert_coef <- function(length_age_dat, start_points, min_obs = 20){
  
  # Von Bert Fitting Using: {FSA}
  # Don't run on fewer than a minimum number of obervations
  num_aged <- nrow(length_age_dat)
  if(num_aged < min_obs){
    na_df <- data.frame("Linf" = NA, 
                        "K" = NA, 
                        "t0" = NA, 
                        "n_aged" = num_aged, 
                        "len_age_1" = NA, 
                        "len_age_2" = NA, 
                        "len_age_3" = NA)
    return(na_df)
  }
  
  # Use nls to estimate VBGF parameters using starting points
  vbert_fit <- nls(length_cm ~ vb(age, Linf, K, t0), 
                   data = length_age_dat, 
                   start = start_points)
  
  # Access parameters with coef()
  # Estimate sizes at age
  vbert_coef <- as.data.frame(t(coef(vbert_fit))) %>% 
    mutate(n_aged = num_aged,
           len_age_1 = Linf * (1  - exp(-1 * K * (1 - t0))),
           len_age_2 = Linf * (1  - exp(-1 * K * (2 - t0))),
           len_age_3 = Linf * (1  - exp(-1 * K * (3 - t0))))
  return(vbert_coef)
  
  
}
```

This next function is a little redundant, but makes it easier to use `purrr::map` and repeat the estimations for each species:

```{r}


# Function for running that for a  single Species
species_vonbert <- function(comname, split_col, min_obs){
  
  # Get starting points from all data
  test_starts <-  vbStarts(length_cm ~ age, data = species_data[[comname]])
  
  # Get coefficients for groups
  species_data[[comname]] %>% 
    split(.[split_col]) %>% 
    map_dfr(vonbert_coef, test_starts, min_obs = min_obs, .id = split_col) %>% 
    mutate(comname = comname)
}
```

Once everything is prepped we can then fun the von Bert parameter estimation for all the species we are interested using the desired groups.

```{r}

# Running everything?
species_coef <- vonbert_species[c(1:17)] %>% 
  map_dfr(species_vonbert, split_col =  "five_yr_group", min_obs = 30)
```

## Plotting Coefficients {.tabset .tabset-pills}

Since the table of coefficients is somewhat simple here is a function to select a species, the x_column to use (corresponding to the time grouping), and the name of the coefficient to plot.

```{r}
# pick species and coefficients
plot_vonbert_coef <- function(comnames, x_col, coef_name){
  
  x_col_sym <- sym(x_col)
  coef_sym <- sym(coef_name)
  coef_label <- switch (
    coef_name,
    Linf = "Asymptotic Max Length (cm)",
    K = "Body Growth Coefficient (K)",
    t0 = "Hypothetical Age of Zero Size (t0)",
    n_aged = "Number Aged",
    len_age_1 = "Age 1 length (cm)",
    len_age_2 = "Age 2 length (cm)",
    len_age_3 = "Age 3 length (cm)")
  species_coef %>% 
    filter(comname %in% comnames) %>% 
    ggplot(aes(y = {{coef_sym}}, x = {{x_col_sym}})) +
    geom_line(group = 1, linetype = 3) +
    geom_point(size = 0.8) +
    scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
    facet_wrap(~comname, ncol = 1, scales = "free") +
    labs(x = "Date Period", y = coef_label)
  
}

```

Using that function we can now take a look at the coefficients for any given species/coefficient combination.

### L-infinity

```{r}


plot_vonbert_coef(comnames = c("atlantic cod",  "haddock", "acadian redfish", "silver hake"), 
                  x_col = "five_yr_group", 
                  coef_name = "Linf")


```

### K

```{r}
plot_vonbert_coef(comnames = c("atlantic cod", "haddock", "acadian redfish", "silver hake"), 
                  x_col = "five_yr_group", 
                  coef_name = "K")


```

### t0

```{r}
plot_vonbert_coef(comnames = c("atlantic cod", "haddock", "acadian redfish", "silver hake"), 
                  x_col = "five_yr_group", 
                  coef_name = "t0")
```

### Number Aged

```{r}
plot_vonbert_coef(comnames = c("atlantic cod", "haddock", "acadian redfish", "silver hake"), 
                  x_col = "five_yr_group", 
                  coef_name = "n_aged")
```

### Age 1 Size

```{r}
plot_vonbert_coef(comnames = c("atlantic cod", "haddock", "acadian redfish", "silver hake"), 
                  x_col = "five_yr_group", 
                  coef_name = "len_age_1")
```

### Age 2 Size

```{r}
plot_vonbert_coef(comnames = c("atlantic cod", "haddock", "acadian redfish", "silver hake"), 
                  x_col = "five_yr_group", 
                  coef_name = "len_age_2")
```

### Age 3 Size

```{r}
plot_vonbert_coef(comnames = c("atlantic cod", "haddock", "acadian redfish", "silver hake"), 
                  x_col = "five_yr_group", 
                  coef_name = "len_age_3")
```

## Tracking Cohorts in Time

### Bubble Plots {.tabset .tabset-pills}

```{r}
# Plotting age distribution
plot_age_bubbleplot <- function(species){
  age_bubble <- species_data[[species]] %>% 
    count(comname, est_year, age) %>% 
    ggplot(aes(x = est_year, y = age, size = n)) +
      geom_point(shape = 21, color = "white", fill = gmri_cols("gmri blue")) +
      facet_wrap(~comname) +
      labs(x = "Year", y = "Age", size = "Number Measured") +
      guides(size = guide_legend(title.position = "top", title.hjust = 0.5))
  return(age_bubble)
  
  # # Take this out:
  # size_bubble <- species_data[[species]] %>% 
  #   count(comname, est_year, age, length_cm) %>% 
  #   ggplot(aes(x = est_year, y = length_cm)) +
  #     geom_jitter(aes(color = age), height = 0, width = 0.3, alpha = 0.75) +
  #     scale_color_gmri(discrete = FALSE) +
  #     facet_wrap(~comname) +
  #     labs(x = "Year", y = "Length (cm)", color = "Age")   +
  #     guides(color = guide_colorbar(title.position = "top", title.hjust = 0.5))
  #   
  # figs <- age_bubble / size_bubble
  # return(figs)
  
  
  # Instead,
  # Get the average size for each age,
  # Make the buble size reflect the fish size

  }
# 
# 
# # Process Each species
# bubble_plots <- map(.x = vonbert_species, .f = plot_age_bubbleplot)

# Function to make panels for it:
# Make the panels
bubble_panel <- function(spec) {
  
  # Open panel
  cat("::: {.panel}\n")

  # Create header for panel name
  cat("##", spec, "{.panel-name}\n")

  # # Text as a plot description
  # cat("Plot of", spec, "\n")

  # Make plot
  p <- plot_age_bubbleplot(species = spec)
  print(p)

  # Add linebreak
  cat("\n")

  # Close panel
  cat(":::\n")
}
```

::::: {.panelset}

```{r, results="asis", fig.height=6}

# Loop through the key species:
walk(key_species, bubble_panel)

```

:::::



### Ridgeplots {.tabset .tabset-pills}

```{r}
# Plotting age distribution as ggridges
plot_age_ridgeplot <- function(species){
  species_data[[species]] %>% 
    mutate(yr = factor(est_year),
           yr = fct_rev(yr)) %>% 
    ggplot(aes(x = age, y = yr)) +
      geom_density_ridges(fill = gmri_cols("gmri blue"), color = "white") +
      facet_wrap(~comname) +
      scale_x_continuous(limits = c(0,NA)) +
      labs(x = "Age", y = "Year") +
      guides(size = guide_legend(title.position = "top", title.hjust = 0.5))
  
}

# # Process Each species
# ridge_plots <- map(vonbert_species, plot_age_ridgeplot)

# Function to make panels for it:
# Make the panels
ridge_panel <- function(spec) {
  
  # Open panel
  cat("::: {.panel}\n")

  # Create header for panel name
  cat("##", spec, "{.panel-name}\n")

  # # Text as a plot description
  # cat("Plot of", spec, "\n")

  # Make plot
  p <- plot_age_ridgeplot(species = spec)
  print(p)

  # Add linebreak
  cat("\n")

  # Close panel
  cat(":::\n")
}
```

::::: {.panelset}

```{r, results="asis", fig.height=6}

# Loop through the key species:
walk(key_species, ridge_panel)

```
:::::


## Cohort Based Von Bertalannffy

Fish born as part of the same cohort are likely to exhibit similar patterns in growth due to their exposure to similar environments at the same points in their development.

For this reason and others it may be meaningful to capture that cohort effect when tracking changes in growth coefficients.

One way to do this is with mixed effects models.

```{r, eval = FALSE}

# Grab one species to use as tester
test_species <- species_data$`acadian redfish` %>% 
  mutate(
    age = as.numeric(age),
    year = factor(est_year),
    yearclass = factor(yearclass))


# Formula for nlme model
vbert_form <- ~ Linf * (1 - exp(-K * (t - t0)))

# Attempt to include random effect for cohort with "yearclass"
#vbert_form <-  ~ Linf * (1 - exp(-K * (t - t0))) + (1 | yearclass)


# use derive to construct function
nfun <- deriv(expr = vbert_form,
              namevec = c("Linf", "K", "t0"),
              function.arg = c("Linf", "K", "t0"))

# Set starting points vector
test_starts <-  vbStarts(length_cm ~ as.numeric(age), data = test_species)

# Play around until it runs
nlmer(length_cm ~ nfun(age, Linf, K, t0)  ~ (1 | yearclass),
      data = test_species, 
      start = test_starts)
```

## Export Size at Age and Coefficients

# Catch Weighted Average Size and Age

For average age and average size by species the stratified abundances are used. Length is freely available, whereas age must be estimated by length.

## Average Age

## Average Size

`r insert_gmri_footer()`
