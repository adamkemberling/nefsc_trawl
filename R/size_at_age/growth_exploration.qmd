---
title: "Growth Changes in NE Shelf Species"
author: 
    name: "Adam A. Kemberling"
    title: "Quantitative Research Associate"
    url: https://github.com/adamkemberling
    affiliation: Gulf of Maine Research Institute
description: | 
 Changes in Size and Weight at Age Across Cohorts
date: "`r Sys.Date()`"
format:
  html:
    self-contained: true
    df-print: kable
    toc: true
    toc-depth: 2
execute: 
  echo: false
  warning: false
  message: false
  eval: true
  fig.height: 6
  fig.width: 6
  fig.align: center
  comment: ""
---

```{r}

####  Packages  ####
{
  library(car)
  library(scales)
  library(patchwork)
  library(directlabels)
  library(xaringanExtra)
  library(ggforce)
  library(colorspace)
  library(gt)
  library(tidyverse)
  library(gmRi)
  library(targets)
  library(ggrepel)
  library(broom)
}


# Set seed
set.seed(3905)

# Set theme
theme_set(theme_gmri())

# Celsius symbol
deg_c <- "\u00b0C"

# Activate panelset
xaringanExtra::use_panelset()

# Function to generate panels using a key word and a plot function
plot_panelset <- function(spec, plot_fun, ...) {
  
  # Open panel
  cat("::: {.panel}\n")
  
  # Create header for panel name
  cat("##", spec, "{.panel-name}\n")

  # # Text as a plot description
  # cat("Plot of", spec, "\n")

  # Make plot
  p <- plot_fun(spec, ...)
  print(p)

  # Add linebreak
  cat("\n")

  # Close panel
  cat(":::\n")
}
```

## Decadal Variability in Growth Model Exploration

```{r}
#| label: add-css
#| results: asis
#| 
gmRi::use_gmri_style_rmd(css_file = "gmri_rmarkdown.css")

```


```{r}
#| label: species-list

# Seasons to include in center of biomass
season_filter <- list(
  "cob" = c("Spring", "Fall"),
  "age" = c("Spring", "Fall"))

#. Species that have center of biomass south of Gulf of Maine
southern_species <- c("atlantic mackerel", "scup", "black sea bass", "butterfish")

# Species to display with their own panels
vb_species <- sort(c(
  "acadian redfish",
  "american plaice",
  "atlantic cod",
  "atlantic herring",
  "atlantic mackerel",
  "black sea bass",
  "butterfish",
  "haddock", 
  "pollock",
  "red hake",
  "scup",
  "silver hake",
  "summer flounder",
  "white hake",
  "windowpane",
  "winter flounder",
  "witch flounder",
  "yellowtail flounder"
))


# Not enough data
# # Species that are either less-vulnerable or protected from fishing
# vb_species <- sort(c(vb_species, "atlantic wolffish", "ocean pout", "cusk"))


```

```{r}
#| label: growth-data-prep

# Access Biological Data with {targets}
withr::with_dir(rprojroot::find_root('_targets.R'), 
                tar_load(survdat_biological))

# 1. Prepare Bio Data for Age analysis for regimes:

# Drop NA age data, restrict to both summer and fall
bio_data <- survdat_biological %>%
  filter(is.na(age) == FALSE,
         season %in% season_filter$age) %>% 
      as.data.frame()
  

# Supplement
# Add regime and decade labels
# Add residence info
# Add condition Facotr: Fulton's condition factor
bio_data <- bio_data %>% 
  mutate(
    yearclass = est_year - (age-1),
    regime = ifelse(est_year < 2010, "Early Regime", "Warm Regime"),
    decade = floor_decade(est_year),
    residence = ifelse(
           comname %in% southern_species,
           "Southern\nResident", 
           "Gulf of Maine\nResident"),
    # Fultons condition factor:
    fK = (100 * indwt*1000) / length_cm^3) 

rm(survdat_biological)


####  Growth Data Prep  #### 

# Filter to just the data for the two regimes
bio_regimes <- bio_data %>% 
  filter(est_year >= 1970, est_year <= 2019)

# tidy up
rm(bio_data)
```

The following tables show the available data by species for assessing size-at-age changes among species sample by the federal trawl survey. Each row indicates the number of individuals sampled and aged by the survey program. All species aged will have lengths, but some may not have weights, particularly in earlier years.

```{r}
#| label: Age-Observations-Availability

# Prep data separately for table
age_truncated <- bio_regimes %>% 
    filter(comname %in% vb_species,
           age > 0) %>% 
    complete(comname, est_year) %>% 
    mutate(regime = ifelse(est_year < 2010, "Early Regime", "Warm Regime"),
           age = ifelse(age>10, ">10", age)) %>% 
    mutate(age = fct_drop(age),
           age_tally = ifelse(!is.na(age), 1, 0))


# Function to make a table
species_table <- function(x){
  age_truncated %>% 
    filter(comname == x) %>% 
    group_by(regime, comname, est_year, age) %>% 
    summarise(n_aged = sum(age_tally), .groups = "drop") %>% 
    mutate(age = factor(age, levels = c(as.character(1:10), ">10"))) %>% 
    arrange(age) %>% 
    mutate(age = fct_drop(age)) %>% 
    pivot_wider(names_from = "age", values_from = n_aged) %>% 
    select(-one_of("NA")) %>% 
    group_by(regime, comname) %>% 
    arrange(est_year) %>% 
    gt(rowname_col = "est_year") %>% 
    tab_header(title = str_c(str_to_title(x) , " - Individuals Aged by Year"), 
               subtitle = "Numbers Combined from Spring and Fall Surveys") %>% 
    sub_missing(missing_text = "") %>% 
    gt::cols_label("est_year" = "Age:") %>% 
    as_raw_html()
  
  
}

  
```


::: panelset
```{r, results="asis"}
#| label: age-tables

# Loop through the key species:
walk(vb_species, 
     plot_panelset, 
     plot_fun = species_table)

```
:::

# Size at Age Comparisons

Given that we can't really construct meaningful VB curves for cohorts with a 10-year window of interest, we need to consider an alternative way of putting some statistics behind our numbers to assess significance.

I think looking at differences in LaA and WaA over periods of interest will be helpful. I think a useful example to emulate is Fig 3 and Table 1 in the attached Neuheimer and Gronkjaer paper. However, instead of using trend lines and slopes, it would be better to do a Welch's t-test comparing 1970-2009 to 2010-2019 (and plotting means for those periods in the figure).

I'm also still debating whether to use 1970-2009 as the comparison or whether to do just the preceding decade, so seeing Welch's t-test results for 2000-2009 and 2010-2019 would be helpful too.

Please truncate output values to no more than 3 decimal places so it's easier to look at. (We'll want to pull other stats out of the Welch's t-test for the paper, but for shaping the paper, I'd prefer to see less right now.)

These are the methods to use for the tests and for testing assumptions:

**Welch's Two-Sample T-Test**

**Bartletts Two-Sample Test**

# Length at Age

The following tables display the results of two-sample testing comparing the length at age of each species between data from two different periods. Significant differences are highlighted when they occur, and in those rows the larger size period's mean has been highlighted in green, with the smaller sized period's mean highlighted in red.

```{r}
#| label: prep-comparison-periods
# Group on common name and time periods and age

# Get the groups we want to compare
year_groups <- list("1970-2009" = c(1970:2009),
                    "2000-2009" = c(2000:2009),
                    "2010-2019" = c(2010:2019))



# Get data into each group, calculate the means?
period_groups <- map(year_groups, function(period){
  
  # filter years:
  period_dat <- age_truncated %>% 
    filter(est_year %in% period)
  
  return(period_dat)
  
  })



# Set the Age ranges for each species:
ages_to_test <- list(
  "acadian redfish"     = c(1:15),
  "american plaice"     = c(1:12),
  "atlantic cod"        = c(1:12),
  "atlantic herring"    = c(1:12),
  "atlantic mackerel"   = c(1:10),
  "black sea bass"      = c(1:10),
  "butterfish"          = c(1:6),
  "haddock"             = c(1:14),
  "pollock"             = c(1:14),
  "red hake"            = c(1:12),
  "scup"                = c(1:12),
  "silver hake"         = c(1:12),
  "summer flounder"     = c(1:12),
  "white hake"          = c(1:12),
  "windowpane"          = c(1:8),
  "winter flounder"     = c(1:14),
  "witch flounder"      = c(1:14),
  "yellowtail flounder" = c(1:12)
)


```




```{r}
#| label: get-period-means


# Now Group the species and compute means
period_means <- map_dfr(period_groups, function(period_dat){
  
  # Get the mean for each age
  period_dat %>% 
    filter(!is.na(age)) %>% 
    group_by(comname, age) %>% 
    summarise(
      n_lengths = sum(!is.na(length_cm)),
      mean_LAA  = mean(length_cm, na.rm = T),
      n_weights = sum(!is.na(indwt)),
      mean_WAA  = mean(indwt, na.rm = T),
      .groups = "drop"
    )
  
}, .id = "comparison_period") %>% 
  mutate(age = factor(age, levels = c(1:10, ">10"))) %>% 
  arrange(comparison_period, comname, age)
```





```{r}
#| label: ageclass-ttest-function



# Function to compare a single ageclass:
ageclass_ttest <-  function(age_x, species_data = both_periods_df, dependent_var = {{test_var}}){
  
    # Subset the age class
    age_subset <- dplyr::filter(species_data, age == age_x)
    
    # Set formula to change dynamically to function input:
    test_formula <- formula(str_c(dependent_var, " ~ comparison_period"))
    
    # Run the comparison of means
    
    tidy_t <-  t.test(test_formula, data = age_subset) %>% 
      tidy() %>% 
      select(estimate1, estimate2, method, p.value)

  tidy_b <- tidy(bartlett.test(length_cm ~ comparison_period, data = age_subset)) %>% 
    select(variance_test = method, 
           bartlett_p =  p.value)

  # Make an output table
  bind_cols(
    list(
      data.frame(
        "comparison_var" = dependent_var,
        "statistical_test" = "two sample t.test"),
        tidy_t,
        tidy_b))}


```



```{r}
#| label: species-ageclass-function

# Function to take each species and compare some variable across comparison periods
species_ageclass_ttests <- function(comname_x, group_1 = "1970-2009", group_2 = "2010-2019", test_var = "length_cm"){

  # 1. Make names for the two groups/regimes
  regime_names <- c(group_1, group_2)
  
  
  # Grab their data and put into a table, set the levels so group_1 is the first factor level
  both_periods_df <- bind_rows(
      list(filter(period_groups[[group_1]], comname == comname_x) %>% drop_na(age, {{test_var}}),
           filter(period_groups[[group_2]], comname == comname_x) %>% drop_na(age, {{test_var}})) %>% 
        setNames(regime_names),
      .id = "comparison_period") %>% 
    mutate(comparison_period = factor(comparison_period, levels = regime_names))
  
  
  
  
  # 2. Run the ttest comparison for each ageclass:
  
  # Map the ages for that species
  ageclass_comparisons <- map_dfr(
    ages_to_test[[comname_x]], 
    possibly(
      .f = ~ageclass_ttest(.x, species_data = both_periods_df, dependent_var = test_var),
    
      # Make a fail state that lets some ages through
      otherwise = 
        data.frame(
          "comparison_var" = test_var,
          "statistical_test" = "two sample t.test", 
          "estimate1" = NA,    
          "estimate2" = NA,    
          "method" = NA,           
          "p.value" = NA,          
          "variance_test" = NA,    
          "bartlett_p" = NA)),
      .id = "age") 
  

  # 3. Do minor renaming and adjusting
  ageclass_comparisons <- ageclass_comparisons %>% 
    mutate(age = as.numeric(as.character(age))) %>% 
    rename({{group_1}} := estimate1) %>% 
    rename({{group_2}} := estimate2)
  
  
  # Get the number of values for each ageclass in each comparison period
  ages_tested <- both_periods_df %>% 
    filter(age %in% ages_to_test[[comname_x]]) %>% 
    group_by(comparison_period, age) %>% 
    summarise(n_obs = n(),
              n_years = n_distinct(est_year),
              .groups = "drop") %>% 
    mutate(obs_per_yr = n_obs / n_years,
           age = as.numeric(as.character(age)))
  
  # Reshape it so it can join to the comparison results:
  species_results <- ages_tested %>% 
    pivot_wider(names_from = comparison_period, values_from = c(n_obs, n_years, obs_per_yr)) %>% 
    left_join(ageclass_comparisons, by = "age") %>% 
    arrange(age)
  
  
  return(species_results)
}

#-----------  Running All Length Comparisons. ----------------









```


```{r}
#| label: function-testing
#| eval: false



species_ageclass_ttests(comname_x = "haddock", group_1 = "1970-2009", group_2 = "2010-2019", test_var = "length_cm")
```



```{r}
#| label: function-mapping-testing
#| eval: false

map_dfr(setNames(vb_species, vb_species), 
        possibly(
          .f = ~ species_ageclass_ttests(comname_x = .x, 
                                         group_1 = "1970-2009", 
                                         group_2 = "2010-2019", 
                                         test_var = "length_cm"),
          otherwise = data.frame(
            "age" = NA,
            "n_obs_1970-2009" = NA,
            "n_obs_2010-2019" = NA,
            "n_years_1970-2009" = NA,    
            "n_years_2010-2019" = NA,    
            "obs_per_yr_1970-2009" = NA,
            "obs_per_yr_2010-2019" = NA, 
            "comparison_var" = NA,
            "statistical_test" = "two sample t.test", 
            "mean1970_2009" = NA,    
            "mean2010_2019" = NA,   
            "method" = NA,         
            "p.value" = NA,          
            "variance_test" = NA,    
            "bartlett_p" = NA)), 
        .id = "comname")
```




::: panel-tabset

### 1970-2009 & 2010 - 2019

```{r}
# Perform Length at Age Tests Tests
laa_tests_1 <- map_dfr(
  .x = setNames(vb_species, vb_species), 
  .f = possibly(
    
    .f = ~ species_ageclass_ttests(
      comname_x = .x, 
      group_1 = "1970-2009", 
      group_2 = "2010-2019", 
      test_var = "length_cm"),
    
    otherwise = data.frame(
      "age" = NA,
      "n_obs_1970-2009" = NA,
      "n_obs_2010-2019" = NA,
      "n_years_1970-2009" = NA,    
      "n_years_2010-2019" = NA,    
      "obs_per_yr_1970-2009" = NA,
      "obs_per_yr_2010-2019" = NA, 
      "comparison_var" = NA,
      "statistical_test" = "two sample t.test", 
      "1970-2009" = NA,    
      "2010_2019" = NA,   
      "method" = NA,         
      "p.value" = NA,          
      "variance_test" = NA,    
      "bartlett_p" = NA)), 
    .id = "comname")
```


```{r}
# Make Tables for Each Species to Reduce Length

saa_table <- function(comname_x, saa_results, period_1 = "1970-2009", period_2 = "2010-2019", var_title = "Length at Age"){
  
  saa_results %>% 
    filter(comname == comname_x) %>% 
    select(-c(statistical_test, variance_test, method)) %>% 
    select(-c(3,4,5,6)) %>% 
    mutate(across(where(is.numeric), round, 3)) %>% 
    group_by(comname) %>% 
    gt(rowname_col = "age") %>% 
    sub_missing(missing_text = "") %>% 
    tab_header(title = str_c(str_to_title(comname_x), var_title, "  - Two-Sample Test"), 
               subtitle = str_c("Comparison of ", period_1, " & ", period_2, " Data")) %>% 
    tab_style(
      style = list(cell_fill(color = "#A4D1A2")),
      locations = cells_body(
        columns = {{period_1}}, 
        rows = p.value < 0.05 & {{period_1}} > {{period_2}})) %>% 
    tab_style(
      style = list(cell_fill(color = "#F9E3D6")),
      locations = cells_body(
        columns = {{period_1}}, 
        rows = p.value < 0.05 & {{period_1}} < {{period_2}})) %>% 
    tab_style(
      style = list(cell_fill(color = "#A4D1A2")),
      locations = cells_body(
        columns = {{period_2}}, 
        rows = p.value < 0.05 & {{period_1}} < {{period_2}})) %>% 
    tab_style(
      style = list(cell_fill(color = "#F9E3D6")),
      locations = cells_body(
        columns = {{period_2}}, 
        rows = p.value < 0.05 & {{period_1}} > {{period_2}})) %>% 
    tab_style(
        style = list(cell_fill(color = "#A4D1A2")),
        locations = cells_body(columns = p.value, rows = p.value < 0.05)) %>% 
    as_raw_html()
  
  
  
}


```




::: panelset
```{r, results="asis"}
#| label: laa-tables-1

# Loop through the key species:
walk(vb_species, 
     plot_panelset, 
     plot_fun = saa_table,
     saa_results = laa_tests_1,
     period_1 = "1970-2009",
     period_2 = "2010-2019",
     var_title = " Length at Age")

```
:::



### 2000-2009 & 2010-2019

```{r}
# Perform Length at Age Tests Tests
laa_tests_2 <- map_dfr(
  .x = setNames(vb_species, vb_species), 
  .f = possibly(
    
    .f = ~ species_ageclass_ttests(
      comname_x = .x, 
      group_1 = "2000-2009", 
      group_2 = "2010-2019", 
      test_var = "length_cm"),
    
    otherwise = data.frame(
      "age" = NA,
      "n_obs_2000-2009" = NA,
      "n_obs_2010-2019" = NA,
      "n_years_2000-2009" = NA,    
      "n_years_2010-2019" = NA,    
      "obs_per_yr_2000-2009" = NA,
      "obs_per_yr_2010-2019" = NA, 
      "comparison_var" = NA,
      "statistical_test" = "two sample t.test", 
      "2000-2009" = NA,    
      "2010_2019" = NA,   
      "method" = NA,         
      "p.value" = NA,          
      "variance_test" = NA,    
      "bartlett_p" = NA)), 
    .id = "comname")


```




::: panelset
```{r, results="asis"}
#| label: laa-tables-2

# Loop through the key species:
walk(vb_species, 
     plot_panelset, 
     plot_fun = saa_table,
     saa_results = laa_tests_2,
     period_1 = "2000-2009",
     period_2 = "2010-2019",
     var_title = " Length at Age")

```
:::



:::



# Weight at Age


The following tables display the results of two-sample testing comparing the weight at age of each species between data from two different periods. Significant differences are highlighted when they occur, and in those rows the larger size period's mean has been highlighted in green, with the smaller sized period's mean highlighted in red.

::: panel-tabset

### 1970-2009 & 2010-2019


```{r}
# Perform Length at Age Tests Tests
waa_tests_1 <- map_dfr(
  .x = setNames(vb_species, vb_species), 
  .f = possibly(
    
    .f = ~ species_ageclass_ttests(
      comname_x = .x, 
      group_1 = "1970-2009", 
      group_2 = "2010-2019", 
      test_var = "indwt"),
    
    otherwise = data.frame(
      "age" = NA,
      "n_obs_1970-2009" = NA,
      "n_obs_2010-2019" = NA,
      "n_years_1970-2009" = NA,    
      "n_years_2010-2019" = NA,    
      "obs_per_yr_1970-2009" = NA,
      "obs_per_yr_2010-2019" = NA, 
      "comparison_var" = NA,
      "statistical_test" = "two sample t.test", 
      "1970-2009" = NA,    
      "2010_2019" = NA,   
      "method" = NA,         
      "p.value" = NA,          
      "variance_test" = NA,    
      "bartlett_p" = NA)), 
    .id = "comname")


```




::: panelset
```{r, results="asis"}
#| label: waa-tables-1

# Loop through the key species:
walk(vb_species, 
     plot_panelset, 
     plot_fun = saa_table,
     saa_results = waa_tests_1,
     period_1 = "1970-2009",
     period_2 = "2010-2019",
     var_title = " Weight at Age")

```
:::




### 2000-2009 & 2010-2019


```{r}
# Perform Length at Age Tests Tests
waa_tests_2 <- map_dfr(
  .x = setNames(vb_species, vb_species), 
  .f = possibly(
    
    .f = ~ species_ageclass_ttests(
      comname_x = .x, 
      group_1 = "2000-2009", 
      group_2 = "2010-2019", 
      test_var = "indwt"),
    
    otherwise = data.frame(
      "age" = NA,
      "n_obs_2000-2009" = NA,
      "n_obs_2010-2019" = NA,
      "n_years_2000-2009" = NA,    
      "n_years_2010-2019" = NA,    
      "obs_per_yr_2000-2009" = NA,
      "obs_per_yr_2010-2019" = NA, 
      "comparison_var" = NA,
      "statistical_test" = "two sample t.test", 
      "2000-2009" = NA,    
      "2010_2019" = NA,   
      "method" = NA,         
      "p.value" = NA,          
      "variance_test" = NA,    
      "bartlett_p" = NA)), 
    .id = "comname")


```




::: panelset
```{r, results="asis"}
#| label: waa-tables-2

# Loop through the key species:
walk(vb_species, 
     plot_panelset, 
     plot_fun = saa_table,
     saa_results = waa_tests_2,
     period_1 = "2000-2009",
     period_2 = "2010-2019",
     var_title = " Weight at Age")

```
:::

:::



# Condition Factor at Age

The following tables display the results of two-sample testing comparing fulton's condition factor at age of each species between data from two different periods. Significant differences are highlighted when they occur, and in those rows the larger size period's mean has been highlighted in green, with the smaller sized period's mean highlighted in red.

::: panel-tabset

### 1970-2009 & 2010 - 2019


```{r}
# Perform Length at Age Tests Tests
condition_tests_1 <- map_dfr(
  .x = setNames(vb_species, vb_species), 
  .f = possibly(
    
    .f = ~ species_ageclass_ttests(
      comname_x = .x, 
      group_1 = "1970-2009", 
      group_2 = "2010-2019", 
      test_var = "fK"),
    
    otherwise = data.frame(
      "age" = NA,
      "n_obs_1970-2009" = NA,
      "n_obs_2010-2019" = NA,
      "n_years_1970-2009" = NA,    
      "n_years_2010-2019" = NA,    
      "obs_per_yr_1970-2009" = NA,
      "obs_per_yr_2010-2019" = NA, 
      "comparison_var" = NA,
      "statistical_test" = "two sample t.test", 
      "1970-2009" = NA,    
      "2010_2019" = NA,   
      "method" = NA,         
      "p.value" = NA,          
      "variance_test" = NA,    
      "bartlett_p" = NA)), 
    .id = "comname")


```




::: panelset
```{r, results="asis"}
#| label: condition-tables-1

# Loop through the key species:
walk(vb_species, 
     plot_panelset, 
     plot_fun = saa_table,
     saa_results = condition_tests_1,
     period_1 = "1970-2009",
     period_2 = "2010-2019",
     var_title = " Condition (K) at Age")

```
:::


### 2000-2009 & 2010-2019


```{r}
# Perform Length at Age Tests Tests
condition_tests_2 <- map_dfr(
  .x = setNames(vb_species, vb_species), 
  .f = possibly(
    
    .f = ~ species_ageclass_ttests(
      comname_x = .x, 
      group_1 = "2000-2009", 
      group_2 = "2010-2019", 
      test_var = "fK"),
    
    otherwise = data.frame(
      "age" = NA,
      "n_obs_2000-2009" = NA,
      "n_obs_2010-2019" = NA,
      "n_years_2000-2009" = NA,    
      "n_years_2010-2019" = NA,    
      "obs_per_yr_2000-2009" = NA,
      "obs_per_yr_2010-2019" = NA, 
      "comparison_var" = NA,
      "statistical_test" = "two sample t.test", 
      "2000-2009" = NA,    
      "2010_2019" = NA,   
      "method" = NA,         
      "p.value" = NA,          
      "variance_test" = NA,    
      "bartlett_p" = NA)), 
    .id = "comname")


```




::: panelset
```{r, results="asis"}
#| label: condition-tables-2

# Loop through the key species:
walk(vb_species, 
     plot_panelset, 
     plot_fun = saa_table,
     saa_results = condition_tests_2,
     period_1 = "2000-2009",
     period_2 = "2010-2019",
     var_title = " Condition (K) at Age")

```
:::

:::

## Takeaways

With the exception of silver hake, all species in these tests are significantly smaller at older ages. There are instances where species are larger at their earliest ages (1-4 years of age), but their growth then plateaus and they ultimately reach a smaller adult size. Black sea bass is another possible exception, showing some age-classes with smaller lengths and weights, but not in a consistent pattern with increasing age. 



::: {.panel-tabset}
  
### 1970-2009 vs. 2009-2019
  
  

```{r}
#| eval: true
# Export the data for Kathy

all_results <- bind_rows(
  list(
    "length-at-age-groups-1" = laa_tests_1,  
    "length-at-age-groups-2" = laa_tests_2,
    "weight-at-age-groups-1" = waa_tests_1,  
    "weight-at-age-groups-2" = waa_tests_2,
    "condition-at-aage-groups-1" = condition_tests_1,  
    "condition-at-aage-groups-2" = condition_tests_2
  ), .id = "comparison variable") %>% 
  relocate(`2000-2009`, .before = "method")


# palette for bars
winloss_pal <- c(gmri_cols("blue"), gmri_cols("orange"), "gray70")


# Prepare data in list for bars
winloss_results_1 <- all_results %>% 
  select(`comparison variable`, comname, age, comparison_var, 
         `1970-2009`, 
         `2010-2019`, 
         p.value) %>% 
  drop_na() %>% 
  group_by(comname, comparison_var) %>% 
  arrange(age) %>% 
  mutate(wins = case_when(
    p.value > 0.05 ~ 0.5,
    p.value < 0.05 & `1970-2009` > `2010-2019` ~ 0,
    p.value < 0.05 & `1970-2009` < `2010-2019` ~ 1)) %>% 
  summarize(wins = list(wins), .groups = "drop") 





# Assemble the table
winloss_results_1 %>% 
  mutate(
    comparison_var = ifelse(comparison_var == "indwt", "Individual Weight", comparison_var),
    comparison_var = ifelse(comparison_var == "length_cm", "Individual Length", comparison_var),
    comparison_var = ifelse(comparison_var == "fK", "Condition (k)", comparison_var),
    comname = str_to_title(comname)) %>% 
  pivot_wider(names_from = comparison_var, values_from = wins) %>% 
  select(comname, `Individual Length`, `Individual Weight`, `Condition (k)`) %>% 
  gt(rowname_col = "comname") %>%
  tab_header(
    title = "Changes in Size-At-Age Characteristics",
    subtitle = "Significant changes in size moving from 1970-2009 & to 2010-2019 size-at-age data") %>% 
  gtExtras::gt_plt_winloss(`Individual Weight`, palette = winloss_pal) %>% 
  gtExtras::gt_plt_winloss(`Individual Length`, palette = winloss_pal) %>% 
  gtExtras::gt_plt_winloss(`Condition (k)`, palette = winloss_pal) %>% 
  tab_spanner(
    label = "Size-at-Age Differences",
    columns = c(`Individual Length`,`Individual Weight`,`Condition (k)`)) %>% 
  tab_footnote(
    footnote = md('Colored bars indicate the change in an ageclass characteristic moving from the periods of 1970-2009 to 2010-2019. Bars in <a style="color:#EA4F12">orange indicate significant declines in length, weight or condition.</a> Bars colored in <a style="color:#00608A">blue indicate significant increases in length, weight or condition.</a> And bars in <a style="color:#B3B3B3">gray</a> indicate no difference in ageclass characteristics.</a>' ),
    locations = cells_column_labels(
      columns = c(`Individual Length`, `Individual Weight`, `Condition (k)`)
  )) %>% 
  gt::cols_label(
    `Individual Length` = md("**Length Changes**"),
    `Individual Weight` = md("**Weight Changes**"),
    `Condition (k)` = md("**Condition Changes**"))


```



### 2000-2009 vs. 2010-2019
  
  

```{r}
# Prepare data in list for bars
winloss_results_2 <- all_results %>% 
  select(`comparison variable`, comname, age, comparison_var, 
         `2000-2009`,
         `2010-2019`, 
         p.value) %>% 
  drop_na() %>% 
  group_by(comname, comparison_var) %>% 
  arrange(age) %>% 
  mutate(wins = case_when(
    p.value > 0.05 ~ 0.5,
    p.value < 0.05 & `2000-2009` > `2010-2019` ~ 0,
    p.value < 0.05 & `2000-2009` < `2010-2019` ~ 1)
    ) %>% 
  summarize(wins = list(wins), .groups = "drop") 



# Assemble the table
winloss_results_2 %>% 
  mutate(
    comparison_var = ifelse(comparison_var == "indwt", "Individual Weight", comparison_var),
    comparison_var = ifelse(comparison_var == "length_cm", "Individual Length", comparison_var),
    comparison_var = ifelse(comparison_var == "fK", "Condition (k)", comparison_var),
    comname = str_to_title(comname)) %>% 
  pivot_wider(names_from = comparison_var, values_from = wins) %>% 
  select(comname, `Individual Length`, `Individual Weight`, `Condition (k)`) %>% 
  gt(rowname_col = "comname") %>%
  tab_header(
    title = "Changes in Size-At-Age Characteristics",
    subtitle = "Significant changes in size moving from 2000-2009 & to 2010-2019 size-at-age data") %>% 
  gtExtras::gt_plt_winloss(`Individual Weight`, palette = winloss_pal) %>% 
  gtExtras::gt_plt_winloss(`Individual Length`, palette = winloss_pal) %>% 
  gtExtras::gt_plt_winloss(`Condition (k)`, palette = winloss_pal) %>% 
  tab_spanner(
    label = "Size-at-Age Differences",
    columns = c(`Individual Length`,`Individual Weight`,`Condition (k)`)) %>% 
  tab_footnote(
    footnote = md('Colored bars indicate the change in an ageclass characteristic moving from the periods of 2000-2009 to 2010-2019. Bars in <a style="color:#EA4F12">orange indicate significant declines in length, weight or condition.</a> Bars colored in <a style="color:#00608A">blue indicate significant increases in length, weight or condition.</a> And bars in <a style="color:#B3B3B3">gray</a> indicate no difference in ageclass characteristics.</a>' ),
    locations = cells_column_labels(
      columns = c(`Individual Length`, `Individual Weight`, `Condition (k)`)
  )) %>% 
  gt::cols_label(
    `Individual Length` = md("**Length Changes**"),
    `Individual Weight` = md("**Weight Changes**"),
    `Condition (k)` = md("**Condition Changes**"))

```


  
:::

### Size at Age in Time


```{r}
# Get the average ageclass size for all species:
size_at_ages_all <- age_truncated %>% 
  group_by(comname, year = est_year, age) %>% 
  summarise(
    avg_len = mean(length_cm, na.rm =T),
    avg_wt = mean(indwt, na.rm =T),
    avg_condition = mean(fK, na.rm =T),
    .groups = "drop") %>% 
  complete(comname, year, age)



# Function to plot them all:
size_at_age_means <- function(comname_x, test_var = avg_len, var_label = "Average Length (cm)"){
  
  # Data for lines
  size_at_age_data <- size_at_ages_all %>% 
    filter(comname == comname_x)
  
  
  # Data for period averages
  period_list <- list(
    "period_1" = c(1970:2009),
    "period_2" = c(2000:2009),
    "period_3" = c(2010:2019))
  
  # Data to get averages
  species_dat <- filter(age_truncated, comname == comname_x)
  
  # Get the means over that range, make a dataframe of x, xend, y, yend for segments
  period_means <- map_dfr(period_list, function(period_years){
    species_dat %>% 
      filter(est_year %in% period_years) %>% 
      group_by(comname, age) %>% 
  summarise(
    avg_len = mean(length_cm, na.rm =T),
    avg_wt = mean(indwt, na.rm =T),
    avg_condition = mean(fK, na.rm =T),
    .groups = "drop") %>% 
      mutate(x = min(period_years), 
             xend = max(period_years))
  }, .id = "period")
  
  
  # Make the plot
  ggplot(size_at_age_data, aes(year, {{test_var}})) +
    geom_line(aes(group = age), color = "gray70") +
    geom_segment(
      data = period_means,
      aes(x = x, xend = xend, y = {{test_var}}, yend = {{test_var}}, group = age, color = period),
      linewidth = 1, show.legend = FALSE) +
      scale_color_manual(values = c(gmri_cols("yellow"), gmri_cols("blue"), gmri_cols("orange"))) +
      labs(title = comname_x, y = var_label)
  
}
  

```

#### Length at Age


::: panelset
```{r, results="asis"}

# Loop through the key species:
walk(vb_species, 
     plot_panelset, 
     plot_fun = size_at_age_means,
     test_var = avg_len,
     var_label = "Individual Length (cm)")

```
:::


#### Weight at Age


::: panelset
```{r, results="asis"}

# Loop through the key species:
walk(vb_species, 
     plot_panelset, 
     plot_fun = size_at_age_means,
     test_var = avg_wt,
     var_label = "Individual Weight (kg)")

```
:::



```{r}
#| eval: false
#| label: export_table

write_csv(all_results, here::here("R/size_at_age/size_at_age_local_data/size_at_age_two_sample_tests.csv"))

```

