---
title: "Haddock Error Check"
author: "Adam A. Kemberling"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: TRUE
    toc_float:
        collapsed: FALSE
    code_folding: show
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F, comment = NA)
options(knitr.kable.NA = '')

###__ Packages  ####
library(here)
library(janitor)
library(gmRi)
library(patchwork)
library(tidyverse)
library(knitr)
library(kableExtra)
library(scales)
library(ggforce)
library(ruler)



# Load the build code and stratification function
box_paths <- research_access_paths(os.use = "unix")
mills_path <- box_paths$mills
res_path <- box_paths$res

#### Set theme  ####
theme_set(theme_minimal())

```

`r use_gmri_style_rmd(css_file = "gmri_rmarkdown.css")`

# Haddock Check

When digging into the data for Haddock it appeared that the biomass for haddock in the Henry Bigelow Era, as derived from length-weight relationships was distinctly higher than for in the spring as well as during the Albatross years.

What gives?

## Pull Haddock data

```{r}
# Load 2020 Raw survdat data from .RData file
load(here("data/NEFSC/Survdat_Nye_Aug 2020.RData"))
trawl_20 <- survdat %>% clean_names()
rm(survdat)



# Do normal cleanup steps
trawl_20 <- trawl_20 %>% 
  mutate(
    # Text Formatting 
    comname = tolower(comname),
    id      = format(id, scientific = FALSE),
    svspp   = as.character(svspp),
    svspp   = str_pad(svspp, 3, "left", "0"),
    
    # Biomass and abundance NA substitutions
    biomass   = ifelse(is.na(biomass) == TRUE & abundance > 0, 0.0001, biomass),
    # # Checking if error is caused by this adjustment: verdict - not the issue
    abundance = ifelse(is.na(abundance) == TRUE & biomass > 0, 1, abundance),
    
    # Sratum number, excluding leading and trailing codes for inshore/offshore, for matching
    strat_num = str_sub(stratum, 2, 3)) %>%  
  mutate(biom_adj  = ifelse(biomass == 0 & abundance > 0, 0.0001, biomass), .after = biomass) %>% 
  mutate(abund_adj = ifelse(abundance == 0 & biomass > 0, 1, abundance), .after = abundance)
  # # Checking if error is caused by this adjustment: verdict - not the issue
  # mutate(abund_adj = abundance, .after = abundance)




# And filter
haddock <- trawl_20 %>% 
  filter(# Filter to just Spring and Fall
         season %in% c("SPRING", "FALL"),
         # Only the Albatross and Henry Bigelow
         svvessel %in% c("AL", "HB"),
         est_year >= 2000,
         est_year <= 2020, 
         comname == "haddock")
```


## Adjust Numbers at Length

```{r}
# Get the abundance value for each sex arrived at by summing across each length
# sometimes there are more measured than initially tallied*
abundance_check <- haddock %>%
  group_by(id, comname, catchsex, abundance) %>%
  summarise(
    abund_actual = sum(numlen),                
    n_len_class = n_distinct(length), # number of distinct lengths caught that station
    .groups     = "keep") %>% 
  ungroup()

# Conversion factor translates each size at length to what it would need be to be
# fot them to add up to that "abund_actual"
conv_factor <- haddock %>% 
  distinct(id, comname, catchsex, length, abund_adj) %>% 
  inner_join(abundance_check) %>% 
  mutate(convers = abund_adj / abund_actual)
  


# Merge back and convert the numlen field
haddock_clean <- haddock %>%
  left_join(conv_factor) %>%
  mutate(numlen_adj = numlen * convers, .after = numlen) %>% 
  select(-c(abund_actual, convers))
```


## Match to Growth Coefficients

```{r}
# This table is a combined table of wigley and fishbase L-W coefficients
lw_combined <- read_csv(here::here("data/biomass_key_combined.csv"), col_types = cols()) %>% 
  mutate(svspp = str_pad(svspp, 3, "left", "0"))


# Just use the Wigley Paper Coefficients
wigley_coefficients <- filter(lw_combined, source == "wigley") %>% 
  select(source, season, svspp, comname, scientific_name, spec_class, 
         hare_group, fishery, catchsex, a, b, ln_a)

# merge on comname, season, and catchsex
haddock_lw <- left_join(haddock_clean, wigley_coefficients)

# Calculate the LW Biomasses for given lengths
haddock_lw <- haddock_lw %>% 
  mutate(
    llen          = log(length),                # Self explanatory
    ind_log_wt    = ln_a + (b * llen),          # log(weight) of an individual at that length
    ind_weight_kg = exp(ind_log_wt),            # Weight of an individual in size class
    sum_weight_kg = ind_weight_kg * numlen_adj, # Weight of all individuals of size class
    # Adjustment for how BIOMASS is repeated, 
    # puts it in equal amounts for each weight class so we can sum easier
    biom_per_lclass = (biom_adj / n_len_class)  
  )
```


## Look at differences between the two

```{r}

# Checking one species at a time
haddock_lw %>% 
  
  group_by(id, est_year, season, svvessel, catchsex) %>% 
  summarise(lw_bio = sum(sum_weight_kg),
            biomass_col = sum(biom_per_lclass)) %>% 
  ggplot(aes(biomass_col, lw_bio, 
             color = svvessel)) +
  geom_point(show.legend = F) +
  facet_grid(season~svvessel) +
  geom_abline(slope = 1, intercept = 0, linetype = 2, color  = "darkblue") +
  labs(x = "Weight from survdat$BIOMASS", y = "Weight from LW relationship",
       caption = "Dashed line depicts 1:1 relationship",
       subtitle = "Haddock Growth Coefficient Testing")
  
      
    
```

## Is it an issue with the length classes?

Its possible that I introduced some matching issues by trying to cheat my way through with that biomass per length class column.

```{r}
# Pull distinct records of each stations BIOMASS for haddock
BIOMASS <- haddock_lw %>% 
  distinct(id, est_year, season, svvessel, catchsex, abund_adj, biom_adj) %>% 
  rename(biomass = biom_adj)

# Use distinct to drop any duplicate stations, grab all lw weights
LW <- haddock_lw %>% 
  distinct(id, est_year, season, svvessel, catchsex, numlen_adj, abund_adj, sum_weight_kg) %>% 
  group_by(id, est_year, season, svvessel, catchsex, abund_adj) %>% 
  summarise(lw_biomass = sum(sum_weight_kg))

# add them together, should merge seemlessly as station totals
dup_id_test <- left_join(BIOMASS, LW)

# plot
ggplot(dup_id_test,
       aes(biomass, lw_biomass, 
             color = svvessel)) +
  geom_point(show.legend = F) +
  facet_grid(season~svvessel) +
  geom_abline(slope = 1, intercept = 0, linetype = 2, color  = "darkblue") +
  labs(x = "Weight from survdat$BIOMASS", y = "Weight from LW relationship",
       caption = "Dashed line depicts 1:1 relationship",
       subtitle = "Haddock Growth Coefficient Testing")
```



## Anything remarkable happening with lengths?

```{r}
haddock_lw %>% 
  ggplot() + 
  geom_histogram(aes(x = length, fill = svvessel)) + #un-weighted
  geom_histogram(aes(x = length, weight = numlen_adj, fill = svvessel)) + #weighted
  facet_grid(season~svvessel) +
  labs(x = "Length (cm)", y = "Frequency - Weighted By Numlen")
  
```

## Numbers

```{r}
haddock_lw %>% 
  group_by(est_year, svvessel, season) %>% 
  summarise(total_fish = sum(numlen_adj)) %>% 
  ggplot(aes(est_year, total_fish, color = svvessel)) +
  geom_line(show.legend = F) +
  facet_wrap(~season) +
  labs(x = "", y = "Total Haddock Caught in Survey")
```


