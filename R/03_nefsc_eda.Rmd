---
title: "NEFSC Exploratory Data Analysis"
author: "Adam A. Kemberling"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: TRUE
    toc_float:
        collapsed: FALSE
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

####  Packages  ####
library(here)
library(rnaturalearth)
library(gmRi)
library(sf)
library(janitor)
library(sizeSpectra)
library(patchwork)
library(tidyverse)
library(ggforce)


####  Support Functions  ####
source(here("R/support/sizeSpectra_support.R"))
mills_path <- shared.path(os.use = "unix", group = "Mills Lab", folder = NULL)
res_path <- shared.path(os.use = "unix", group = "RES Data", folder = NULL)



####  Load Data  ####

# Load the build code and stratification function
source(here("R/01_nefsc_ss_build.R"))

# Fetch data prepped for size spectra analysis
#trawl_weights <- load_ss_data()

# Save it once you proved that the function works
# write_csv(trawl_weights, here::here("data/survdat_ss.csv"))

# Load it from csv (faster)
trawl_weights <- read_csv(here::here("data/survdat_ss.csv"), col_types = cols(), guess_max = 1e4)

# Load the shapefiles for the polygons

#### Set theme  ####
theme_set(theme_minimal())

```


# Exporatory Data Analysis of NEFSC Bottom Trawl Survey Data

Exploration of spatial and temporal patterns in abundance, and bodymass of fishes from the Northeast groundfish survey.

```{r group summaries}

# Load GMRI Style
use_gmri_style_rmd(css_file = "gmri_rmarkdown.css")

# Do some formatting
trawldat <- trawl_weights %>% 
  mutate(
    id = as.character(id),
    season = ifelse(season == "SPRING", "Spring", "Fall"),
    season = factor(season, levels = c("Spring", "Fall"))
  )


ann_means <- trawldat %>% 
  group_by(est_year) %>% 
  summarise(
    season = "Spring + Fall",
    total_biomass_kg = sum(sum_weight_g, na.rm = T) / 1000,
    n_stations = n_distinct(id),
    biomass_per_station = total_biomass_kg / n_stations,
    mean_individual_biomass = weighted.mean(single_weight_g, weights = numlen_adj),
    mean_individual_length = weighted.mean(length, weights = numlen_adj)) 

seasonals <- trawldat %>% 
  group_by(est_year, season) %>% 
  summarise(
    n_stations = n_distinct(id),
    total_biomass_kg = sum(sum_weight_g, na.rm = T) / 1000,
    biomass_per_station = total_biomass_kg / n_stations,
    mean_individual_biomass = weighted.mean(single_weight_g, weights = numlen_adj),
    mean_individual_length = weighted.mean(length, weights = numlen_adj)) 

# bind them so you can facet
summs <- bind_rows(ann_means, seasonals)
```


## Temporal Trends {.tabset .tabset-pills}

Patterns in annual abundance or CPUE of High Profile Species at annual and/or seasonal levels.


### Total Biomass

Biomass of a given species from a station is a function of the adjusted number caught, their lengths, and the corresponding weights at-length using the species specific length-weight relationship coefficients. sex-specific coefficients and seasonal growth coefficients are used when available.

Total biomass in the following plots represent the total of all individual biomass estimates from all species with available growth coefficients, for each year and within each survey season.

```{r, fig.height = 8}
bio_1 <- ann_means %>% 
  ggplot(aes(est_year, total_biomass_kg, color = season)) +
    geom_line(group = 1) +
    scale_color_manual(values = "black") +
    labs(x = "", y = "Total Biomass (kg)")

bio_2 <- seasonals %>% 
  ggplot(aes(est_year, total_biomass_kg, color = season)) +
    geom_line() +
    labs(x = "", y = "Total Biomass (kg)")

bio_1 / bio_2
```


### CPUE

Biomass per unit effort in the following figures represents the total biomass divided by the effort in number of stations. Adjustments for the 2008 vessel change are assumed to be corrected for in the data. There has been no correction for differences in stratum area in these figures.


```{r, fig.height = 8}
cpue_1 <- ann_means %>% 
  ggplot(aes(est_year, biomass_per_station, color = season)) +
    geom_line(group = 1) +
    scale_color_manual(values = "black") +
    labs(x = "", y = "Adjusted Biomass per Station (kg)")

cpue_2<- seasonals %>% 
  ggplot(aes(est_year,biomass_per_station, color = season)) +
    geom_line() +
    labs(x = "", y = "Adjusted Biomass per Station (kg)")

cpue_1 / cpue_2
```


### Relative Contribution

For the following figures on relative contribution, axes for the two survey seasons are used to highlight relative differences in total biomass and cpue between the two survey seasons. A dashed line is overlayed to represent what an equal allocation would resemble. Years above the line indicate that more biomass/cpue occurred in the Fall and vice versa.

```{r, fig.height = 8}
bio_comp <- seasonals %>% select(est_year,  season, total_biomass_kg) %>% 
  pivot_wider(names_from = season, values_from = total_biomass_kg) %>% 
  mutate(decade = floor_decade(est_year)) %>% 
  ggplot(aes(Spring, Fall, color = decade)) +
    geom_point() +
    geom_mark_ellipse() +
    geom_abline(slope = 1, intercept = 0, linetype = 2, color = "gray50") +
    labs(x = "Spring", y = "Fall", subtitle = "Total Biomass")+
    facet_wrap(~decade) +
    theme(legend.position = "none")


cpue_comp <- seasonals %>% select(est_year,  season, biomass_per_station) %>% 
  pivot_wider(names_from = season, values_from = biomass_per_station) %>% 
  mutate(decade = floor_decade(est_year)) %>% 
  ggplot(aes(Spring, Fall, color = decade)) +
    geom_point() +
    geom_mark_ellipse() +
    geom_abline(slope = 1, intercept = 0, linetype = 2, color = "gray50") +
    labs(x = "Spring", y = "Fall", subtitle = "Biomass / Standard Tow") +
    facet_wrap(~decade) +
    theme(legend.position = "none")

bio_comp / cpue_comp


```

### Species Groups

Relative contribution to overall biomass by species group based on management and/or life history: Demersal, Elasmobranch, Groundfish, Pelagic


```{r, fig.height = 8}
# Species Class Bins Data Prep
class_totals <- trawldat %>% 
  group_by(est_year, spec_class) %>% 
  summarise(`Total Class Biomass` = sum(total_biomass) / 1000) %>% 
  ungroup() %>% 
  left_join(ann_means, by = "est_year") %>% 
  mutate(`Percent of Annual Biomass` = (`Total Class Biomass` / total_biomass_kg) * 100 ,
         `Species Category` = spec_class,
         Year = as.character(est_year))

# Class Proportions
class_totals %>% 
  ggplot(aes(x = fct_rev(Year), y = `Percent of Annual Biomass`, fill = `Species Category`)) + 
    geom_col(color = "white", size = 0.2) +
    labs(x = "", y = "Proportion of Total Annual Biomass") +
    coord_flip() +
    scale_fill_gmri() +
    scale_y_continuous(position = "right", ) +
    guides("fill" = guide_legend(title.position = "top", title.hjust = 0.5)) +
    theme(legend.position = "bottom")

```


### Mean Individual Biomass

Check these across years and also by season

```{r}

summs %>% 
  ggplot(aes(est_year, mean_individual_biomass, color = season)) +
    geom_line(show.legend = FALSE) +
    scale_color_manual(values = c(
      "Spring + Fall" = "black",
      "Spring" = as.character(gmri_cols("gmri blue")),
      "Fall"   = as.character(gmri_cols("orange")))) +
  #theme(legend.position = "bottom", legend.title = element_blank()) +
  labs(x = "", y = "Mean Individual Biomass (g)") +
  facet_wrap(~season, ncol = 1)
      
  
```


### Mean Individual Length

```{r}
summs %>% 
  ggplot(aes(est_year, mean_individual_length, color = season)) +
    geom_line(show.legend = FALSE) +
    scale_color_manual(values = c(
      "Spring + Fall" = "black",
      "Spring" = as.character(gmri_cols("gmri blue")),
      "Fall"   = as.character(gmri_cols("orange")))) +
  #theme(legend.position = "bottom", legend.title = element_blank()) +
  labs(x = "", y = "Mean Individual Length (cm)") +
  facet_wrap(~season, ncol = 1)
```


## Spatial Patterns  {.tabset .tabset-pills}


For large regions like Georges Bank and the Gulf of Maine, what kind of patterns are we seeing.

```{r}

# Load the strata
survey_strata <- read_sf(str_c(res_path, "Shapefiles/BottomTrawlStrata/BTS_Strata.shp"))  %>% 
  clean_names() %>% 
  filter(strata >= 01010 ,
         strata <= 01760,
         strata != 1310,
         strata != 1320,
         strata != 1330,
         strata != 1350,
         strata != 1410,
         strata != 1420,
         strata != 1490) 


# Key to which strata = which regions
strata_key <- list(
  "Georges Bank"          = as.character(13:23),
  "Gulf of Maine"         = as.character(24:40),
  "Southern New England"  = str_pad(as.character(1:12), width = 2, pad = "0", side = "left"),
  "Mid-Atlantic Bight"    = as.character(61:76))


# Assign Areas
survey_strata <- survey_strata %>% 
  mutate(
    strata = str_pad(strata, width = 5, pad = "0", side = "left"),
    strata_num = str_sub(strata, 3, 4),
    area = case_when(
      strata_num %in% strata_key$`Georges Bank` ~ "Georges Bank",
      strata_num %in% strata_key$`Gulf of Maine` ~ "Gulf of Maine",
      strata_num %in% strata_key$`Southern New England` ~ "Southern New England",
      strata_num %in% strata_key$`Mid-Atlantic Bight` ~ "Mid-Atlantic Bight",
    TRUE ~ "Outside Major Study Areas"
  )) %>% 
  select(finstr_id, strata, strata_num, area, a2, str2, set, stratuma, str3, geometry)

# Load new england
new_england <- ne_states("united states of america") %>% st_as_sf(crs = 4326) 


# Make trawl data an sf dataset
trawl_sf <- trawldat %>% st_as_sf(coords = c("decdeg_beglon", "decdeg_beglat"), crs = 4326)

```





### Trawl Regions

```{r}
# Plot to check
ggplot() +
  geom_sf(data = new_england) +
  geom_sf(data =survey_strata, aes(fill = area)) +
  coord_sf(xlim = c(-79, -65.5), ylim = c(32, 44.5), expand = FALSE) +
  guides(fill = guide_legend(nrow = 2)) +
  theme(legend.position = "bottom", legend.title = element_blank())
```


### Regional Summaries 
```{r}
area_summs <- trawldat %>% 
  group_by(est_year, area) %>% 
  summarise(
    season = "Spring + Fall",
    total_biomass_kg = sum(sum_weight_g, na.rm = T) / 1000,
    n_stations = n_distinct(id),
    biomass_per_station = total_biomass_kg / n_stations,
    mean_individual_biomass = weighted.mean(single_weight_g, weights = numlen_adj),
    mean_individual_length = weighted.mean(length, weights = numlen_adj)
  )


area_summs %>% 
  mutate_if(is.numeric,round, 2) %>% 
  DT::datatable()

```


### Total Biomass

```{r}
area_summs %>% 
  ggplot(aes(est_year, total_biomass_kg)) +
    geom_line() +
    facet_wrap(~area, ncol = 2) +
    labs(x = "", y = "Total Biomass (kg)")
```



### CPUE

```{r}
area_summs %>% 
  ggplot(aes(est_year, biomass_per_station)) +
    geom_line() +
    facet_wrap(~area, ncol = 2) +
    labs(x = "", y = "Adjusted Biomass per Station (kg)")
           
```




# Summary

```{r footer}
insert_gmri_footer()
```

