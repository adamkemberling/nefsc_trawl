---
title: "SURVDAT Pull Check"
author: "Adam A. Kemberling"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: TRUE
    toc_float:
        collapsed: FALSE
    code_folding: show
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


knitr::opts_chunk$set(echo = TRUE, message = F, warning = F, comment = NA)
options(knitr.kable.NA = '')

###__ Packages  ####
library(here)
library(janitor)
library(gmRi)
library(patchwork)
library(tidyverse)
library(knitr)
library(kableExtra)
library(waldo)



# Load the build code and stratification function
box_paths <- research_access_paths(os.use = "unix")
mills_path <- box_paths$mills
res_path <- box_paths$res

#### Set theme  ####
theme_set(theme_minimal())
```

`r use_gmri_style_rmd(css_file = "gmri_rmarkdown.css")`

# SURVDAT pull comparison

Digging into differences in the fall Bigelow survey data across different pulls of `survdat`

Objective is to isolate which main columns are inconsistent across the datasets and whether the problem is isolated to specific species.

## Load SURVDAT Sources

```{r}

# 2016
load(paste0(mills_path, "Projects/WARMEM/Old survey data/Survdat_Nye2016.RData"))
survdat_16 <- clean_names(survdat) %>% filter(est_year >= 2000)


# 2019
load(paste0(res_path, "NMFS_trawl/Survdat_Nye_allseason.RData"))
survdat_19 <- clean_names(survdat) %>% filter(est_year >= 2000)

# 2020
load(paste0(res_path, "NMFS_trawl/Survdat_Nye_Aug 2020.RData"))
survdat_20 <- clean_names(survdat) %>% filter(est_year >=  2000)

# 2021
load(paste0(res_path, "NMFS_trawl/survdat_slucey_01152021.RData"))
survdat_21 <- clean_names(survdat) %>% filter(year >= 2000)

# remove survdat
rm(survdat)
```


## Run Cleanup Function

The cleanup function does a number of steps to each survdat source. This includes the removal of specific strata, the removal of non-spring/fall seasons, removal of vessels other than the Albatross or Bigelow, the dropping of NA biomass and abundance events, and the removal of certain species like shrimp.

It also matches up the stations with larger regions they fall within and the survey effort within each of those. This should not have an impact on any of the things we are tracking below.

```{r}
# Cleanup functions
source(here("R/01_nefsc_ss_build.R"))

# Clean each up using the survdat prep function
trawldat_16 <- survdat_prep(survdat = survdat_16, survdat_source = "2016") %>% 
  mutate(survdat_source = "2016")
trawldat_19 <- survdat_prep(survdat = survdat_19, survdat_source = "2019") %>% 
  mutate(survdat_source = "2019")
trawldat_20 <- survdat_prep(survdat = survdat_20, survdat_source = "2020") %>% 
  mutate(survdat_source = "2020")
trawldat_21 <- survdat_prep(survdat = survdat_21, survdat_source = "2021") %>% 
  mutate(survdat_source = "2021")

rm(survdat_16, survdat_19, survdat_20, survdat_21)
```

## Conversion Factor Comparisons {.tabset}

The "conversion factor" is a number representing the scale of mismatch between the abundance of a species caught at in a tow when measured using the `survdat$avundance` column compared to the sum of `survdat$numlen` across all the lengths caught.

In theory they should be equal. Numbers greater than 1 indicate that the abundance column was greater than the sum of individuals at the different lengths.

```{r}

# This is the same code used to make numlen_adj in the build:
get_convers <- function(trawldat){
  abundance_check <- trawldat %>%
    group_by(id, comname, catchsex, abundance) %>%
    summarise(
      numlen_abund = sum(numlen),                
      n_len_class  = n_distinct(length), # number of distinct lengths caught that station
      .groups      = "keep") %>% 
    ungroup()
  
  # Conversion factor translates each size at length to what it would need be to be
  # for them to add up to that "abundance" column
  conv_factor <- trawldat %>% 
    distinct(id, comname, catchsex, length, abundance) %>% 
    inner_join(abundance_check) %>% 
    mutate(convers = abundance / numlen_abund)
    
  
  
  # Merge back and convert the numlen field
  trawldat_adjusted <- trawldat %>%
    left_join(conv_factor) %>%
    mutate(numlen_adj = numlen * convers, .after = numlen) 
  
  return(trawldat_adjusted)
}



# Put all the groups together to compare conversion factors
trawldat_combined <- bind_rows(
  list(
    "2016" = get_convers(trawldat_16),
    "2019" = get_convers(trawldat_19),
    "2020" = get_convers(trawldat_20),
    "2021" = get_convers(trawldat_21)), 
  .id = "survdat_source"
)
```

### All Species

```{r}
trawldat_combined %>% 
  mutate(season = fct_rev(season)) %>% 
  ggplot(aes(y = convers, 
             x  = survdat_source, 
             color = survdat_source)) +
  geom_boxplot() +
  facet_grid(season ~ svvessel) + 
  scale_color_gmri() +
  labs(subtitle = "numlen to abundance conversion value - All Species",
       y = "(survdat$abundance / sum(numlen))",
       x = "",
       caption = "Conversion value calculated at each station for each species & sex.\nMay reflect change in catch composition.")
```
### Haddock Only

```{r}
trawldat_combined %>% 
  filter(comname == "haddock") %>% 
  mutate(season = fct_rev(season)) %>% 
  ggplot(aes(y = convers, 
             x  = survdat_source, 
             color = survdat_source)) +
  geom_boxplot() +
  facet_grid(season ~ svvessel) + 
  scale_color_gmri() +
  labs(subtitle = "numlen to abundance conversion value - Haddock only",
       y = "(survdat$abundance / sum(numlen))",
       x = "",
       caption = "Conversion value calculated at each station/sex for haddock.")
```


## Single Species Checks {.tabset .tabset-pills}

For each of the following species we are comparing 4 main things across the different survdat sources:

 1. The number of unique station id's each year   
 2. The total number of fish, as tallied from the survdat$numlen column   
 3. The total abundance of fish as the sum of survdat$abundance from distinct stations and the species caught at them      
 4. The total biomass for each year as the sum of survdat$biomass from distinct stations and the species caught at them   
```{r}

# Funciton to pull single species data
species_select <- function(species_choice){
  
  # Combine data from each source for plotting
  source_list <- list(trawldat_16, trawldat_19, 
                      trawldat_20, trawldat_21)
  
  # Use map to not repeat so much code
  select_species <- map_dfr(source_list, function(surv_source){
    surv_source %>% 
      select(survdat_source, id, est_year, season, comname, length, 
             numlen, abundance, biom_adj) %>% 
      filter(comname == species_choice)
  })
  
  return(select_species)
}

# Plotting Numlen Totals and Station counts
plot_stations <- function(combined_data, species_choice){
  
  # Total numlen fish
  species_numlens <- combined_data %>% 
    group_by(survdat_source, est_year, season) %>% 
    summarise(n_stations = n_distinct(id),
              sum_numlen = sum(numlen, na.rm = T),
              .groups = "keep")  %>%  
    ungroup() %>% 
    mutate(season = fct_rev(season))
  
  
  
  station_plot <- ggplot(species_numlens, 
                         aes(est_year, n_stations, color = survdat_source)) +
    geom_line() +
    facet_wrap(~season) +
    scale_color_gmri() +
    labs(x = "", y = "total stations")
  
  numlen_plot <- ggplot(species_numlens, 
                        aes(est_year, sum_numlen, color = survdat_source)) +
    geom_line() +
    facet_wrap(~season) +
    scale_color_gmri() +
    labs(x = "", y = "total numlen abundance", 
         caption = paste0(species_choice, " only"))
  
  plot_out <- station_plot / numlen_plot
  return(plot_out)
}

# Plotting Biomass and Abundances
plot_biomass <- function(combined_data, species_choice){
  # Abundance and Biomass
  species_abund_bio <- combined_data %>% 
    distinct(survdat_source, est_year, season, id, abundance, biom_adj) %>% 
    group_by(survdat_source, est_year, season) %>% 
    summarise(n_stations = n_distinct(id),
              abundance = sum(abundance, na.rm = T),
              biomass = sum(biom_adj, na.rm = T),
              .groups = "keep") %>%  
    ungroup() %>% 
    mutate(season = fct_rev(season))
  
  abund_plot <- ggplot(species_abund_bio, 
                       aes(est_year, abundance, color = survdat_source)) +
    geom_line() +
    facet_wrap(~season) +
    scale_color_gmri() +
    labs(x = "", y = "Total survdat$abundance")
  
  
  bio_plot <- ggplot(species_abund_bio, aes(est_year, biomass, color = survdat_source)) +
    geom_line() +
    facet_wrap(~season) +
    scale_color_gmri() +
    labs(x = "", y = "Total survdat$biomass", 
         caption = paste0(species_choice, " only"))
  
  plot_out <- abund_plot / bio_plot
  return(plot_out)
  
}

```

### Haddock {.tabset}

#### Stations and Numlen Totals

```{r}
species_choice <- "haddock"
single_species <- species_select(species_choice)
plot_stations(single_species, species_choice)

```

#### Abundance and Biomass

```{r}
plot_biomass(single_species, species_choice)
```

### Spiny dogfish {.tabset}

#### Stations and Numlen Totals

```{r}
species_choice <- "spiny dogfish"
single_species <- species_select(species_choice)
plot_stations(single_species, species_choice)

```

#### Abundance and Biomass

```{r}
plot_biomass(single_species, species_choice)
```


### Atlantic Cod {.tabset}

#### Stations and Numlen Totals

```{r}
species_choice <- "atlantic cod"
single_species <- species_select(species_choice)
plot_stations(single_species, species_choice)

```

#### Abundance and Biomass

```{r}
plot_biomass(single_species, species_choice)
```


### Atlantic Herring {.tabset}

#### Stations and Numlen Totals

```{r}
species_choice <- "atlantic herring"
single_species <- species_select(species_choice)
plot_stations(single_species, species_choice)

```

#### Abundance and Biomass

```{r}
plot_biomass(single_species, species_choice)
```

`r insert_gmri_footer()`